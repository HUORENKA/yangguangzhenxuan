# 模块 - 批量采购（PRD）

- 版本：V1.0
- 日期：2026-02-04
- 适用范围：阳光优采原型（`pages/home.html` 新增 Tab 与批量采购能力）

---

## 1. 背景与目标

### 1.1 背景
当前采购用户在商城逐个搜索、逐个加购效率低。需要提供“批量采购”入口，让用户通过导入采购单，一次性生成待采购清单，并在商城中为每条需求选择对应商品，完成批量加购/下单前准备。

### 1.2 目标
- 提供**采购单模板下载**与**导入采购单**能力（支持 `xlsx/xls/csv`）。
- 导入成功后，生成“待采购商品清单”并支持逐行**选品匹配**。
- 每条待采购商品支持“**暂不采购**”（从后续流程中移除）。
- 存在“待匹配”行时，**禁止提交**（防止漏选）。

### 1.3 非目标（V1 不做）
- 审批流、预算管控强拦截、合同/发票/税务流程。
- 自动下单/自动选品（V1 以“推荐候选 + 人工确认”为主）。
- 采购单头信息（本次明确不需要 Sheet1）。

---

## 2. 入口与信息架构

### 2.1 首页入口（Tab）
- 页面：`pages/home.html`
- 位置：顶部 Tab 导航 `#tabNav` 中，“阳光见证链”右侧新增 Tab 按钮：**批量采购**
- Tab 行为：与现有 Tab 一致（同页内容切换），新增 `data-tab="batch"`（命名可调整但需唯一）。

### 2.2 批量采购 Tab 内容区（建议区块）
1) 顶部操作条
- `采购单模板下载`（下拉：Excel 模板 / CSV 模板 / 字段说明）
- `导入采购单`（按钮 + 拖拽上传区）

2) 导入结果区
- 未导入：展示功能说明、模板字段说明、导入限制提示
- 导入成功：展示“待采购清单”表格 + 汇总栏 + 提交按钮

3) 选品弹窗（逐行）
- 默认带入该行的关键词与店铺名、价格范围
- 支持搜索、筛选、候选列表选择

---

## 2.3 线框图（对应原型实现）

### 2.3.1 首页 Tab（入口位置）

```
┌─────────────────────────────────────────────────────────────────────┐
│ Tab： [首页]  [平台公告]  [阳光见证链]  [批量采购]                   │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.3.2 批量采购页面（默认态 / 未导入）

```
┌─────────────────────────────────────────────────────────────────────┐
│ 批量采购                                                             │
│ 说明：支持 xlsx/xls/csv；任一校验错误整单不导入                       │
│                                                                     │
│ [采购单模板下载▼]  [导入采购单]                                       │
│                                                                     │
│ ┌───────────────────────────────────────────────────────────────┐   │
│ │  拖拽文件到此处，或点击“导入采购单”                               │   │
│ │  支持：xlsx/xls/csv（模板含“【示例】”行，导入时自动忽略）          │   │
│ └───────────────────────────────────────────────────────────────┘   │
│                                                                     │
│ （隐藏）导入失败原因列表 / 字段说明 / 清单表格                        │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.3.3 批量采购页面（导入失败：仅展示错误原因，整单不导入）

```
┌─────────────────────────────────────────────────────────────────────┐
│ 导入失败                                                             │
│ 发现以下问题，本次采购单未导入：                                     │
│  - 商品名称必填                                                       │
│  - 数量必须为大于0的整数                                               │
│  - 最高价不能小于最低价                                               │
│  - 存在重复明细，请合并后再导入                                       │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.3.4 批量采购页面（导入成功：汇总栏 + 清单表格）

```
┌─────────────────────────────────────────────────────────────────────┐
│ 汇总： 总行数 10 | 已匹配 7 | 待匹配 3 | 超价提示 2      [加入购物车] │
│ 提示：仍有未匹配商品，请完成匹配后提交。（有待匹配则按钮置灰）         │
│                                                                     │
│ ┌────┬──────────┬────────┬────┬──────┬────┬──────┬──────┬──────┐    │
│ │行号│商品名称   │规格型号│品牌│店铺名│数量│最低价│最高价│状态  │…   │
│ ├────┼──────────┼────────┼────┼──────┼────┼──────┼──────┼──────┤    │
│ │  1 │A4复印纸   │70g…    │得力│震坤行│ 10 │20.00 │30.00 │待匹配 │…   │
│ │    │                                                [选择商品]    │
│ │    │                                                [暂不采购]    │
│ ├────┼──────────┼────────┼────┼──────┼────┼──────┼──────┼──────┤    │
│ │  2 │中性笔     │0.5mm…  │晨光│-     │  5 │-     │25.00 │已匹配 │…   │
│ │    │                                     （如超价：Tag“超出价格范围”）│
│ └────┴──────────┴────────┴────┴──────┴────┴──────┴──────┴──────┘    │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.3.5 选品弹窗（逐行匹配：条件自动带入）

```
┌──────────────────────────── 选择对应商品 ────────────────────────────┐
│ 左侧：待采购信息 + 搜索条件                 右侧：候选商品列表         │
│ ┌───────────────────────────┐           ┌───────────────────────────┐ │
│ │ 待采购信息                │           │ 候选商品（N条）             │ │
│ │ - 商品：A4复印纸           │           │ ┌───────────────────────┐ │ │
│ │ - 规格：70g 500张/包       │           │ │ 得力 A4复印纸 70g…      │ │ │
│ │ - 品牌：得力               │           │ │ 店铺：震坤行  ¥25.92    │ │ │
│ │ - 店铺：震坤行             │           │ │           [选为对应商品]│ │ │
│ │ - 数量：10                 │           │ └───────────────────────┘ │ │
│ │ - 价格：20~30 不含税       │           │ ┌───────────────────────┐ │ │
│ │                           │           │ │ 齐心 A4复印纸 70g…      │ │ │
│ │ 搜索条件（自动带入）       │           │ │ 店铺：震坤行  ¥23.50    │ │ │
│ │ [关键词] [店铺名]          │           │ │           [选为对应商品]│ │ │
│ │ [最低价] [最高价]          │           │ └───────────────────────┘ │ │
│ │ [搜索] [清空店铺]          │           │                           │ │
│ └───────────────────────────┘           └───────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 3. 用户流程（V1）

### 3.1 主流程
1. 用户在首页点击 **批量采购** Tab。
2. 点击 **采购单模板下载**，获取模板（含示例行）。
3. 用户按模板填写后点击 **导入采购单**（上传文件）。
4. 系统解析并进行校验：
   - 若有任意错误：**导入失败，整单不导入**；页面仅展示“错误原因”（无需逐行定位信息）。
   - 若无错误：导入成功，生成“待采购清单”。
5. 用户逐行在商城中为每条需求选择对应商品：
   - 支持店铺名模糊匹配筛选
   - 支持把最高/最低价带入选品筛选条件
   - 允许选择价格范围外商品，但在列表行提示“超出价格范围”
6. 用户可对某条需求点击 **暂不采购**，该条从清单中移除，不进入后续提交。
7. 当清单中不存在“待匹配”行时，用户点击 **提交/加入购物车** 完成批量操作。

### 3.2 禁止提交规则
- 只要存在任意一行状态为 **待匹配**，提交按钮置灰并提示：`仍有未匹配商品，请完成匹配后提交`。

---

## 4. 采购单模板（仅 1 个 Sheet）

### 4.1 模板文件
- Excel：`采购单模板.xlsx`（推荐）
- CSV：`采购单模板.csv`
- **模板包含示例行**（便于用户理解）。

### 4.2 字段定义（列）
> 说明：行号由系统生成，**模板中不体现行号列**。

| 字段（列名） | 必填 | 类型/规则 | 说明 |
|---|---:|---|---|
| 商品名称 | 是 | 文本，去首尾空格，长度建议 ≤ 100 | 主要检索关键词 |
| 规格型号 | 否 | 文本，长度建议 ≤ 100 | 提升匹配准确率 |
| 品牌 | 否 | 文本，长度建议 ≤ 50 | 用于筛选/排序 |
| 供应商（店铺名） | 否 | 文本，长度建议 ≤ 100 | 店铺名**模糊匹配**筛选 |
| 数量 | 是 | **整数**，> 0 | 只允许整数 |
| 最高价 | 否 | 数字，≥ 0（不含税单价） | 用于筛选/提示 |
| 最低价 | 否 | 数字，≥ 0（不含税单价） | 用于筛选/提示 |

### 4.3 示例行约定（避免误导入）
- 模板示例行建议使用商品名称前缀：`【示例】`（例如 `【示例】A4复印纸`）。
- 导入时：系统将**自动忽略**商品名称以 `【示例】` 开头的行（与“空行忽略”一致，避免用户忘删导致误导入）。

---

## 5. 导入与校验（有错则整单不导入）

### 5.1 支持格式
- `xlsx` / `xls` / `csv`
- CSV 编码：优先识别 UTF-8（含 BOM）与 GBK；无法识别时提示“编码不支持”。

### 5.2 解析策略
- Excel：
  - 优先读取名为 `采购明细` 的 Sheet；若不存在则读取第 1 个 Sheet。
  - 表头行：默认第 1 行（允许前置空行，需自动跳过直至识别到表头）。
- CSV：
  - 第 1 行为表头。

### 5.3 空行处理
- 空行（全部字段为空或全空格）**忽略**。
- `【示例】` 行按“忽略行”处理。

### 5.4 重复行判定（报错）
> 你已确认：重复行报错，且出现任何错误则整单不导入。

- 判重 Key（建议）：
  - `商品名称 + 规格型号 + 品牌 + 供应商（店铺名） + 最高价 + 最低价`
- 若出现重复（Key 完全一致）：错误原因追加 `存在重复明细，请合并后再导入`。

### 5.5 字段级校验规则
导入校验失败即生成错误原因（可多条），最终只展示“原因列表”（无需逐行展示）。

- 商品名称：
  - 必填；为空则错误：`商品名称必填`
- 数量：
  - 必填；必须为**整数**且 > 0
  - 非整数/≤0：错误：`数量必须为大于0的整数`
- 最高价/最低价：
  - 若填写，必须为数字且 ≥ 0
  - 若两者都填，需满足 `最高价 >= 最低价`，否则错误：`最高价不能小于最低价`
- 店铺名/规格/品牌：
  - 仅做长度与非法字符（可选）校验；不要求必须存在对应店铺（因为店铺名模糊匹配，且店铺可能变更）

### 5.6 错误呈现（按你的要求）
- 只要存在任一错误：**导入失败，整单不导入**
- 页面仅展示：
  - 标题：`导入失败`
  - 列表：**错误原因**（去重后展示即可）
  - 不展示行号、明细定位信息

> 可选增强（不影响“只展示原因”）：提供“下载错误明细”按钮，仅用于线下排查；若你希望严格不提供，也可不做。

---

## 6. 待采购清单（导入成功后）

### 6.1 列表字段（页面展示建议）
- 系统行号（系统生成）
- 商品名称 / 规格型号 / 品牌 / 店铺名
- 数量
- 最高价 / 最低价
- 匹配状态
- 已选商品（名称、单价、不含税、店铺）
- 操作：`选择商品/更换`、`暂不采购`

### 6.2 行状态机
- **待匹配**：未选择商城商品（默认）
- **已匹配**：已选择商城商品
- **已匹配-超出价格范围**：已选择商品，但单价不在 \([最低价, 最高价]\) 内（仅提示，不阻止提交，除非后续另行要求）

### 6.3 价格范围提示规则（你已确认）
当行存在最高价或最低价时，若已选商品单价不在范围内：
- 行内展示提示：`超出价格范围`
- 提示样式建议：黄色/橙色 Tag + 悬浮说明（例：`单价 32.00 超出范围 20.00~30.00（不含税）`）

---

## 7. 选品（逐行匹配）

### 7.1 进入方式
在“待采购清单”行点击 `选择商品/更换` 打开选品弹窗。

### 7.2 默认带入条件（你已确认）
打开弹窗时自动带入：
- **关键词**：商品名称（必带）+（规格型号/品牌 若有则拼接）
- **店铺名**：来自导入列“供应商（店铺名）”，用于筛选（模糊匹配）
- **价格范围**：最高价/最低价（不含税单价），用于筛选/排序提示

### 7.3 店铺名模糊匹配策略
若用户填写店铺名：
- 默认筛选：店铺名 `contains` 匹配（不区分大小写/全半角，支持去空格）
- 若筛选后无结果：
  - 允许用户一键“清空店铺筛选”扩大范围（不视为导入错误）

### 7.4 商品候选展示（建议）
候选卡片/行展示信息：
- 商品名称（含规格关键字）
- 不含税单价
- 店铺名
- 简要标签：合规/销量/评分（原型可简化）
- 操作：`选为对应商品`

### 7.5 选择确认
用户点击候选的 `选为对应商品`：
- 回填到采购单列表行，状态变为“已匹配”
- 若超价：状态标记“已匹配-超出价格范围”，但仍可提交（V1 只提示）

---

## 8. 暂不采购（你已确认：后续不体现）

### 8.1 行为
用户点击某行 `暂不采购`：
- 该行从“待采购清单”中**移除**
- 不参与后续提交、不在提交结果中体现

### 8.2 防误触建议（强烈建议）
因为移除后不再体现，建议提供轻量可撤销能力：
- 操作后弹出 Toast：`已暂不采购，可撤销（5秒）`
- 5 秒内点击“撤销”可恢复该行

---

## 9. 提交（加入购物车/下一步）

### 9.1 提交前置条件（强约束）
- 清单中不得存在 **待匹配** 行，否则禁止提交（按钮置灰）。

### 9.2 提交结果
V1 建议实现为：
- `加入购物车`：将“已匹配”行按数量加入购物车（不含税价格展示与结算逻辑属于后续模块）

> 若你们希望直接创建订单，也可在 V2 扩展“生成订单草稿”。

---

## 10. 权限与风控（建议）
- 未登录用户：可查看 Tab，但导入与提交提示登录（与现有原型登录态一致）。
- 上传文件大小与行数限制（建议，需你们定值）：
  - 最大文件：10MB
  - 最大明细行：500 行（忽略行不计入）

---

## 11. 埋点与日志（建议，便于评估）
- 模板下载次数（按格式）
- 导入尝试次数、导入失败次数、失败原因分布
- 成功导入行数分布
- 匹配完成率（已匹配/总行数）
- 超出价格范围行占比
- 暂不采购次数
- 提交成功次数

---

## 12. 验收标准（V1）
- 首页 Tab 中“阳光见证链”右侧存在“批量采购”入口，点击可切换到批量采购内容区。
- 模板下载支持 `xlsx/xls/csv`，模板包含示例行且示例行导入时会被忽略。
- 导入支持 `xlsx/xls/csv`，空行忽略；重复行报错。
- 任一错误发生时：整单不导入；页面仅展示错误原因列表。
- 导入成功后生成待采购清单；每行可打开选品弹窗并带入关键词、店铺名（模糊匹配）与价格范围。
- 选择价格范围外商品时：列表行提示“超出价格范围”。
- “暂不采购”会将行移除且不进入后续提交；建议支持 5 秒撤销。
- 存在“待匹配”行时禁止提交；全部匹配后可提交并加入购物车（或进入下一步）。

