<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>首页 | 阳光甄选</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="../assets/custom.css">
  <script src="../assets/mock.js"></script>
  
  <style>
    :root { --color-primary: #E2231A; --color-primary-hover: #c01e16; }
    .text-primary { color: #E2231A; }
    .bg-primary { background-color: #E2231A; }
    .border-primary { border-color: #E2231A; }
    
    .top-dark { background: #3d4451; color: #e5e7eb; }
    .top-red { background: linear-gradient(135deg, #E2231A 0%, #c01e16 100%); }
    
    .product-card {
      display: flex; flex-direction: column; transition: all 0.25s ease; border: 1px solid #e5e7eb;
    }
    .product-card:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); border-color: #E2231A; }
    .product-card > a { flex: 1; min-height: 0; display: flex; flex-direction: column; }
    .product-card > a .reco-card-top { flex: 1; min-height: 0; }
    .product-card .price-rational-wrap { flex-shrink: 0; }
    .product-card .reco-card-actions { flex-shrink: 0; }
    .product-card .reco-card-supplier {
      height: 1.25rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
      flex-shrink: 0;
    }
    
    .cat-left { background: linear-gradient(180deg, #fff5f4 0%, #fff 100%); border: 1px solid #fde2e0; }
    .cat-item:hover { background: #ffebe9; color: #E2231A; }
    .cat-item.active { background: #ffebe9; color: #E2231A; font-weight: 600; border-left: 3px solid #E2231A; }
    
    .reco-panel { background: #4a5568; color: #fff; min-height: 320px; }
    .reco-panel.sec2 { background: #6b5b4f; }
    .reco-panel.sec3 { background: #4a6b5c; }
    .reco-section { min-height: 320px; }
    .tab-2nd { transition: all 0.2s; }
    .tab-2nd.active { background: #E2231A; color: #fff; }
    .tab-2nd:not(.active) { background: #f3f4f6; color: #374151; }
    .tab-2nd:not(.active):hover { background: #e5e7eb; }
    
    .float-menu { position: fixed; right: 16px; top: 50%; transform: translateY(-50%); z-index: 500; }
    .float-item { width: 76px; min-height: 76px; border-radius: 8px; background: #fff; box-shadow: 0 2px 12px rgba(0,0,0,0.14); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px 6px; gap: 6px; }
    .float-item:hover { background: #E2231A; color: #fff; }
    .float-item i { font-size: 22px; }
    .float-item span { font-size: 13px; line-height: 1.2; }
    
    .tab-btn { height: 44px; padding: 0 16px; font-size: 14px; color: #4b5563; border-bottom: 2px solid transparent; display: inline-flex; align-items: center; }
    .tab-btn.active { color: #E2231A; border-color: #E2231A; font-weight: 600; }
    .tab-btn:hover { color: #E2231A; }

    .core-display { position: relative; align-items: stretch; }
    .category-panel { width: 220px; height: 450px; display: flex; flex-direction: column; flex-shrink: 0; }
    .category-list { flex: 1; overflow-y: auto; overflow-x: hidden; min-height: 0; }
    .category-list .cat-item { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .mega-panel { position: absolute; top: 0; left: 220px; right: 0; height: 450px; background: #fff; border: 1px solid #e5e7eb; box-shadow: 0 8px 24px rgba(0,0,0,0.12); z-index: 400; display: flex; gap: 24px; padding: 16px; overflow: hidden; }
    .mega-left { flex: 1; min-width: 0; overflow-y: auto; }
    .mega-right { width: 280px; border-left: 1px solid #f3f4f6; padding-left: 16px; flex-shrink: 0; display: flex; flex-direction: column; }
    .mega-hot-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
    .mega-hot-more { font-size: 12px; color: #E2231A; font-weight: 500; }
    .mega-hot-more:hover { text-decoration: underline; }
    .mega-col { margin-bottom: 12px; }
    .mega-col-title { font-weight: 600; color: #111827; margin-bottom: 6px; }
    .mega-item { font-size: 13px; color: #4b5563; margin-right: 12px; display: inline-block; }
    .mega-item:hover { color: #E2231A; }
    .mega-hot-products { display: flex; flex-direction: column; gap: 10px; }
    .mega-product-card { display: flex; gap: 10px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; text-decoration: none; color: inherit; }
    .mega-product-card:hover { border-color: #E2231A; }
    .mega-product-card img { width: 56px; height: 56px; object-fit: cover; border-radius: 4px; }
    .mega-product-card .info { flex: 1; min-width: 0; }
    .mega-product-card .name { font-size: 12px; color: #111827; line-clamp: 2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .mega-product-card .price { font-size: 13px; color: #E2231A; font-weight: 600; margin-top: 4px; }

    .carousel { position: relative; overflow: hidden; border-radius: 10px; background: #f3f4f6; width: 100%; height: 100%; }
    .carousel-slides { display: flex; transition: transform 0.5s ease; height: 100%; }
    .carousel-slide { min-width: 100%; height: 100%; position: relative; background-size: cover; background-position: center; }
    .carousel-overlay { position: absolute; inset: 0; background: linear-gradient(90deg, rgba(0,0,0,0.55) 0%, rgba(0,0,0,0.15) 50%, rgba(0,0,0,0.05) 100%); }
    .carousel-text { position: absolute; left: 24px; top: 50%; transform: translateY(-50%); color: #fff; max-width: 60%; }
    .carousel-tag { display: inline-block; padding: 4px 10px; background: rgba(255,255,255,0.2); border-radius: 999px; font-size: 12px; margin-bottom: 8px; }
    .carousel-arrow { position: absolute; top: 50%; transform: translateY(-50%); width: 44px; height: 44px; border-radius: 50%; background: rgba(0,0,0,0.45); color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; }
    .carousel-arrow.left { left: 44px; }
    .carousel-arrow.right { right: 44px; }
    .carousel-dots { position: absolute; bottom: 12px; right: 16px; display: flex; gap: 6px; }
    .carousel-dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(255,255,255,0.6); cursor: pointer; }
    .carousel-dot.active { background: #E2231A; }

    .supplier-grid { display: grid; grid-template-columns: repeat(6, minmax(0, 1fr)); gap: 12px; }
    .supplier-card { border: 1px solid #e5e7eb; background: #fff; border-radius: 8px; padding: 0; overflow: hidden; }
    .supplier-card:hover { border-color: #E2231A; box-shadow: 0 6px 16px rgba(0,0,0,0.08); }
    .supplier-card-img-wrap { position: relative; width: 100%; aspect-ratio: 16/10; overflow: hidden; }
    .supplier-card-img { width: 100%; height: 100%; object-fit: cover; background: #f3f4f6; display: block; }
    .supplier-card-overlay { position: absolute; left: 0; right: 0; bottom: 0; padding: 10px 12px; background: linear-gradient(to top, rgba(0,0,0,0.72) 0%, rgba(0,0,0,0.45) 70%, transparent 100%); color: #fff; text-align: left; }
    .supplier-card-name { font-weight: 600; color: #fff; font-size: 13px; margin-bottom: 4px; line-height: 1.3; }
    .supplier-card-business { font-size: 12px; color: rgba(255,255,255,0.92); line-height: 1.4; }

    .footer-services { background: #3f3f46; color: #fff; }
    .footer-inner { display: flex; align-items: flex-start; justify-content: space-between; gap: 32px; flex-wrap: wrap; }
    .footer-left { flex: 1; min-width: 0; }
    .footer-quick-links { font-size: 14px; color: #fff; margin-bottom: 14px; }
    .footer-quick-links a { color: #fff; text-decoration: none; }
    .footer-quick-links a:hover { text-decoration: underline; color: rgba(255,255,255,0.9); }
    .footer-quick-links span.sep { margin: 0 8px; color: rgba(255,255,255,0.5); }
    .footer-org { font-size: 13px; color: rgba(255,255,255,0.85); line-height: 1.8; }
    .footer-right { display: flex; align-items: flex-start; gap: 20px; flex-shrink: 0; }
    .footer-icon-item { display: flex; flex-direction: column; align-items: center; gap: 6px; text-align: center; min-width: 64px; }
    .footer-icon-item .icon-wrap { width: 44px; height: 44px; border: 1px solid #E2231A; color: #E2231A; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
    .footer-icon-item .icon-text { font-size: 12px; color: rgba(255,255,255,0.9); line-height: 1.3; }

    .float-item-login { color: #E2231A !important; font-weight: 600; }
    .float-item-login:hover { background: #E2231A; color: #fff !important; }

    .search-input:focus { outline: none; border-color: #E2231A; box-shadow: 0 0 0 2px rgba(226,35,26,0.15); }
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

    /* 价格合理性标识模块：与上方供应商留足间距，评价贴近横条，区间与点位样式优化 */
    .price-rational-wrap {
      margin-top: 18px;
      padding-top: 4px;
      border-top: 1px solid #f3f4f6;
    }
    .price-rational-bar-container { position: relative; width: 100%; padding-top: 16px; }
    .price-rational-label {
      position: absolute; font-size: 11px; font-weight: 600; line-height: 1.2;
      color: #1d4ed8; white-space: nowrap; transform: translateX(-50%); z-index: 3;
      bottom: 100%; margin-bottom: 2px; pointer-events: none;
    }
    .price-rational-label.high { color: #b91c1c; }
    .price-rational-bar-wrap {
      position: relative; width: 100%; height: 10px; border-radius: 5px;
      overflow: visible; display: flex; box-shadow: inset 0 1px 2px rgba(0,0,0,0.06);
    }
    .price-rational-bar-green {
      width: 80%; height: 100%; background: linear-gradient(180deg, #99f6e4 0%, #5eead4 50%, #2dd4bf 100%);
      border-radius: 5px 0 0 5px; border: 1px solid rgba(45,212,191,0.35); border-right: none;
    }
    .price-rational-bar-red {
      width: 20%; height: 100%; background: linear-gradient(180deg, #fecaca 0%, #fca5a5 50%, #f87171 100%);
      border-radius: 0 5px 5px 0; border: 1px solid rgba(248,113,113,0.4); border-left: none;
    }
    .price-rational-dot {
      position: absolute; top: 50%; transform: translate(-50%, -50%);
      border-radius: 2px; z-index: 2; box-shadow: 0 1px 2px rgba(0,0,0,0.15);
    }
    .price-rational-dot-min {
      width: 4px; height: 11px; background: #047857; left: 0;
      border: 1px solid rgba(4,120,87,0.5);
    }
    .price-rational-dot-ref {
      width: 4px; height: 11px; background: #b45309; left: 80%;
      border: 1px solid rgba(180,83,9,0.5);
    }
    .price-rational-dot-price {
      width: 4px; height: 16px; background: #2563eb;
      border: 1px solid rgba(37,99,235,0.5); box-shadow: 0 1px 3px rgba(37,99,235,0.35);
    }
    .price-rational-labels {
      display: flex; justify-content: space-between; margin-top: 4px;
      font-size: 10px; color: #6b7280; line-height: 1.3;
    }
    .price-rational-labels .left { text-align: left; }
    .price-rational-labels .right { text-align: right; }

    /* 分类推荐区商品卡片：价格行与“合规”标签（绿色标签样式） */
    .reco-card-price-row {
      display: flex; align-items: center; gap: 8px; flex-wrap: nowrap; margin-bottom: 8px;
    }
    .reco-card-price-row > span:first-child { flex-shrink: 0; }
    .reco-card-price-tag {
      display: inline-flex; align-items: center; gap: 3px;
      padding: 2px 8px; font-size: 11px; font-weight: 600;
      color: #065f46;
      background: #d1fae5;
      border: 1px solid #34d399; border-radius: 999px;
      box-shadow: 0 1px 2px rgba(6, 95, 70, 0.12);
      white-space: nowrap; letter-spacing: 0.04em;
      flex-shrink: 0;
    }
    .reco-card-price-tag::before {
      content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; font-size: 9px;
      color: #059669;
    }

    /* 商品卡片操作按钮：比质比价、寻源询价 */
    .reco-card-actions { display: flex; gap: 8px; margin-top: 10px; }
    .reco-card-actions .btn-compare, .reco-card-actions .btn-inquiry {
      flex: 1; height: 32px; border-radius: 6px; font-size: 12px; font-weight: 500;
      display: inline-flex; align-items: center; justify-content: center; gap: 4px;
      border: 1px solid #e5e7eb; background: #fff; color: #374151; cursor: pointer;
      transition: all 0.2s; text-decoration: none;
    }
    .reco-card-actions .btn-compare:hover, .reco-card-actions .btn-inquiry:hover {
      border-color: #E2231A; color: #E2231A; background: #fff5f4;
    }

    /* 比质比价弹窗：全宽、贴底部、无遮罩，仅通过关闭按钮关闭 */
    .compare-modal {
      position: fixed; left: 0; right: 0; bottom: 0; width: 100%;
      max-height: 75vh; z-index: 701; background: #f3f4f6;
      display: flex; flex-direction: column; gap: 12px;
      padding: 0 20px 20px 20px; box-shadow: 0 -8px 32px rgba(0,0,0,0.2);
      opacity: 0; visibility: hidden; transform: translateY(100%);
      transition: all 0.3s ease; overflow: hidden; border-radius: 16px 16px 0 0;
    }
    .compare-modal.show { opacity: 1; visibility: visible; transform: translateY(0); }
    .compare-modal-header {
      flex-shrink: 0; height: 44px; display: flex; align-items: center; justify-content: flex-end; padding: 0 4px 0 0;
    }
    .compare-modal-close {
      width: 32px; height: 32px; border-radius: 50%; background: #E2231A; color: #fff; border: none;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      font-size: 14px;
    }
    .compare-modal-close:hover { background: #c01e16; }
    .compare-section {
      flex-shrink: 0; background: #e5e7eb; border-radius: 10px; padding: 12px 16px;
    }
    .compare-section-title { font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px; }
    .compare-section-similar .compare-section-head {
      display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 12px;
    }
    .compare-section-similar .compare-section-head .compare-section-title { margin-bottom: 0; }
    .compare-section-tabs { display: flex; align-items: center; gap: 0; flex-shrink: 0; }
    .compare-section-tab {
      padding: 8px 16px; font-size: 13px; font-weight: 500; border-radius: 0;
      border: 1px solid #d1d5db; background: #fff; color: #6b7280; cursor: pointer;
      margin-left: -1px; transition: all 0.2s;
    }
    .compare-section-tab:first-child { margin-left: 0; border-radius: 6px 0 0 6px; }
    .compare-section-tab:last-child { border-radius: 0 6px 6px 0; }
    .compare-section-tab:hover { border-color: #E2231A; color: #E2231A; background: #fff5f4; z-index: 1; }
    .compare-section-tab.active { background: #E2231A; color: #fff; border-color: #E2231A; z-index: 2; }
    .compare-section-tab.active:hover { background: #c01e16; border-color: #c01e16; color: #fff; }
    .compare-section-similar.collapsed .compare-section-body { display: none; }
    .compare-section-similar .btn-toggle-similar {
      padding: 10px 24px; font-size: 14px; color: #6b7280; background: #fff; border: 1px solid #d1d5db;
      border-radius: 8px; cursor: pointer; flex-shrink: 0; min-width: 100px;
    }
    .compare-section-similar .btn-toggle-similar:hover { border-color: #9ca3af; color: #374151; }
    .compare-section-body {
      display: flex; flex-wrap: wrap; gap: 12px; overflow-x: auto; overflow-y: hidden;
      min-height: 60px; align-items: flex-start;
    }
    .compare-card {
      flex-shrink: 0; width: 140px; background: #fff; border-radius: 8px;
      border: 1px solid #e5e7eb; overflow: hidden; transition: all 0.2s;
    }
    .compare-card:hover { border-color: #E2231A; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .compare-card .thumb { display: block; width: 100%; aspect-ratio: 16/10; object-fit: cover; background: #f3f4f6; }
    .compare-card .info { padding: 8px 10px; }
    .compare-card .name { font-size: 12px; color: #111827; line-height: 1.35; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .compare-card .supplier { font-size: 11px; color: #6b7280; margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .compare-card .price-row { display: flex; align-items: center; gap: 6px; flex-wrap: nowrap; margin-top: 4px; }
    .compare-card .price-row .price { margin: 0; }
    .compare-card .price { font-size: 13px; color: #E2231A; font-weight: 600; margin-top: 4px; }
    .compare-card.compare-card-checkable { cursor: pointer; }
    .compare-card .thumb-wrap { position: relative; display: block; }
    .compare-card.compare-card-checkable input[type="checkbox"] {
      position: absolute; top: 6px; right: 6px; width: 18px; height: 18px; z-index: 2;
      cursor: pointer; margin: 0;
    }
    .compare-card .btn-remove {
      position: absolute; top: 6px; right: 6px; width: 22px; height: 22px; border-radius: 50%;
      background: rgba(0,0,0,0.5); color: #fff; border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center; font-size: 10px;
    }
    .compare-card .btn-remove:hover { background: #E2231A; }
    .compare-card.has-remove { position: relative; }
    .compare-section-actions { display: flex; flex-direction: column; gap: 12px; flex-shrink: 0; margin-left: 16px; }
    .compare-section-actions .btn-clear { padding: 10px 24px; font-size: 14px; color: #6b7280; background: #fff; border: 1px solid #d1d5db; border-radius: 8px; cursor: pointer; min-width: 100px; }
    .compare-section-actions .btn-clear:hover { border-color: #9ca3af; color: #374151; }
    .compare-section-actions .btn-do { padding: 10px 24px; font-size: 14px; color: #fff; background: #E2231A; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; min-width: 100px; }
    .compare-section-actions .btn-do:hover { background: #c01e16; }
    .compare-section.compare-section-with-actions { display: flex; flex-direction: column; }
    .compare-section.compare-section-with-actions .compare-section-row { display: flex; align-items: flex-start; margin-top: 0; flex: 1; min-height: 0; }
    .compare-section.compare-section-with-actions .compare-section-body { flex: 1; min-width: 0; }
    .compare-empty-hint { font-size: 12px; color: #9ca3af; padding: 12px 0; }

    /* ========== AI 智能助手悬浮按钮（科技感） ========== */
    .float-item-ai {
      width: 76px;
      height: 76px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #E2231A 100%);
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4), 0 0 30px rgba(118, 75, 162, 0.2);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #fff;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .float-item-ai::before {
      content: '';
      position: absolute;
      inset: -2px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2, #E2231A, #667eea);
      z-index: -1;
      animation: ai-glow 3s linear infinite;
    }
    .float-item-ai::after {
      content: '';
      position: absolute;
      inset: 2px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #E2231A 100%);
      z-index: -1;
    }
    @keyframes ai-glow {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .float-item-ai:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 30px rgba(102, 126, 234, 0.5), 0 0 40px rgba(118, 75, 162, 0.3);
    }
    .float-item-ai i { font-size: 24px; margin-bottom: 2px; }
    .float-item-ai span { font-size: 13px; font-weight: 500; letter-spacing: 0.5px; }

    /* ========== AI 助手弹窗（贴右侧按钮） ========== */
    .ai-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.2);
      z-index: 800;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    .ai-modal-overlay.show { opacity: 1; visibility: visible; }

    .ai-modal {
      position: fixed;
      right: 90px; /* 贴着浮动菜单左侧 */
      bottom: 20px;
      width: 380px;
      height: 600px;
      max-height: calc(100vh - 40px);
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0,0,0,0.05);
      z-index: 850;
      display: flex;
      flex-direction: column;
      opacity: 0;
      visibility: hidden;
      transform: translateY(20px) scale(0.95);
      transition: all 0.3s ease;
      overflow: hidden;
    }
    .ai-modal.show { 
      opacity: 1; 
      visibility: visible; 
      transform: translateY(0) scale(1); 
    }

    .ai-modal-header {
      padding: 14px 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }
    .ai-modal-header h3 { font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
    .ai-modal-header h3 i { font-size: 18px; }
    .ai-modal-close {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      border: none;
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      font-size: 12px;
    }
    .ai-modal-close:hover { background: rgba(255,255,255,0.3); }

    .ai-modal-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
    }

    .ai-chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    /* ========== AI 功能弹窗（独立弹窗，显示在对话弹窗左侧） ========== */
    .ai-func-modal {
      position: fixed;
      right: 480px; /* 对话弹窗左侧 */
      bottom: 20px;
      width: 360px;
      max-height: calc(100vh - 40px);
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0,0,0,0.05);
      z-index: 840;
      display: flex;
      flex-direction: column;
      opacity: 0;
      visibility: hidden;
      transform: translateX(20px) scale(0.95);
      transition: all 0.3s ease;
      overflow: hidden;
    }
    .ai-func-modal.show {
      opacity: 1;
      visibility: visible;
      transform: translateX(0) scale(1);
    }
    .ai-func-modal-header {
      padding: 12px 16px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }
    .ai-func-modal-header h4 { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
    .ai-func-modal-header h4 i { font-size: 16px; }
    .ai-func-modal-close {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      border: none;
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      font-size: 11px;
    }
    .ai-func-modal-close:hover { background: rgba(255,255,255,0.3); }
    .ai-func-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      background: #fafafa;
      max-height: 520px;
    }

    .ai-chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .ai-message {
      max-width: 90%;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .ai-message.user { align-self: flex-end; }
    .ai-message.assistant { align-self: flex-start; }

    .ai-message-bubble {
      padding: 10px 14px;
      border-radius: 14px;
      font-size: 13px;
      line-height: 1.6;
      word-break: break-word;
    }
    .ai-message.user .ai-message-bubble {
      background: linear-gradient(135deg, #E2231A 0%, #c01e16 100%);
      color: #fff;
      border-bottom-right-radius: 4px;
    }
    .ai-message.assistant .ai-message-bubble {
      background: #f3f4f6;
      color: #374151;
      border-bottom-left-radius: 4px;
    }

    .ai-message-options {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }
    .ai-option-btn {
      padding: 5px 12px;
      border-radius: 14px;
      font-size: 12px;
      border: 1px solid #e5e7eb;
      background: #fff;
      color: #374151;
      cursor: pointer;
      transition: all 0.2s;
    }
    .ai-option-btn:hover { border-color: #E2231A; color: #E2231A; background: #fff5f4; }

    .ai-input-area {
      padding: 12px;
      border-top: 1px solid #e5e7eb;
      background: #fff;
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }
    .ai-input-area input {
      flex: 1;
      height: 40px;
      padding: 0 14px;
      border: 1px solid #e5e7eb;
      border-radius: 20px;
      font-size: 13px;
      outline: none;
      transition: border-color 0.2s;
    }
    .ai-input-area input:focus { border-color: #667eea; }
    .ai-input-area button {
      height: 40px;
      padding: 0 18px;
      border-radius: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      border: none;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .ai-input-area button:hover { transform: scale(1.02); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }

    /* AI 功能弹窗内的商品卡片 */
    .ai-product-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 10px;
      transition: all 0.2s;
    }
    .ai-product-card:hover { border-color: #E2231A; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .ai-product-card-img { width: 100%; aspect-ratio: 16/10; object-fit: cover; border-radius: 6px; margin-bottom: 8px; background: #f3f4f6; }
    .ai-product-card-name { font-size: 12px; color: #111827; line-height: 1.4; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .ai-product-card-info { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; flex-wrap: wrap; gap: 4px; }
    .ai-product-card-price { font-size: 14px; color: #E2231A; font-weight: 600; }
    .ai-product-card-score { font-size: 11px; color: #6b7280; }
    .ai-product-card-actions { display: flex; gap: 6px; flex-wrap: wrap; }
    .ai-btn-primary {
      flex: 1;
      min-width: 70px;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      background: #E2231A;
      color: #fff;
    }
    .ai-btn-primary:hover { background: #c01e16; }
    .ai-btn-secondary {
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      background: #f3f4f6;
      color: #374151;
    }
    .ai-btn-secondary:hover { background: #e5e7eb; }

    /* 加载动画 */
    .ai-loading {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #6b7280;
      font-size: 14px;
    }
    .ai-loading-dots {
      display: flex;
      gap: 4px;
    }
    .ai-loading-dots span {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #667eea;
      animation: ai-dot-bounce 1.4s infinite ease-in-out both;
    }
    .ai-loading-dots span:nth-child(1) { animation-delay: -0.32s; }
    .ai-loading-dots span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes ai-dot-bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    /* 比质比价表格 */
    .ai-compare-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-bottom: 12px;
    }
    .ai-compare-table th, .ai-compare-table td {
      padding: 8px 10px;
      border: 1px solid #e5e7eb;
      text-align: center;
    }
    .ai-compare-table th { background: #f3f4f6; font-weight: 600; color: #374151; }
    .ai-compare-table td { color: #4b5563; }

    /* 评价列表 */
    .ai-review-item {
      padding: 12px;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .ai-review-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
    .ai-review-user { font-size: 13px; color: #374151; font-weight: 500; }
    .ai-review-tag { padding: 2px 8px; border-radius: 10px; font-size: 11px; }
    .ai-review-tag.positive { background: #dcfce7; color: #166534; }
    .ai-review-tag.negative { background: #fee2e2; color: #991b1b; }
    .ai-review-content { font-size: 13px; color: #6b7280; line-height: 1.5; }

    /* 预算标识 */
    .ai-budget-tag {
      display: inline-block;
      padding: 2px 8px;
      background: #dcfce7;
      color: #166534;
      font-size: 11px;
      border-radius: 10px;
      margin-bottom: 6px;
    }

    /* 收藏心形 */
    .ai-favorite-icon { color: #E2231A; }

    /* Toast 提示 */
    .ai-toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 12px 24px;
      background: rgba(0,0,0,0.75);
      color: #fff;
      border-radius: 8px;
      font-size: 14px;
      z-index: 900;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    .ai-toast.show { opacity: 1; visibility: visible; }

    /* ========== 批量采购：列表文字与垂直居中 ========== */
    .bp-table-center tbody tr td,
    .bp-table-center thead tr th { vertical-align: middle; }

    /* ========== 批量采购：选品弹窗位置修正 ========== */
    #bpPickModal {
      right: 50%;
      bottom: 20px;
      transform: translate(50%, 20px) scale(0.95) !important;
      width: 980px;
      height: 640px;
      max-height: calc(100vh - 40px);
    }
    #bpPickModal.show {
      transform: translate(50%, 0) scale(1) !important;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;">
  
  <!-- ==================== 红色主栏：Logo + 搜索 ==================== -->
  <div class="top-red text-white">
    <div class="max-w-[1400px] mx-auto px-4 py-4">
      <div class="flex items-center justify-center relative">
        <a href="home.html" class="absolute left-4 flex items-center gap-3">
          <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center"><i class="fas fa-sun text-xl"></i></div>
          <div>
            <div class="text-xl font-bold">阳光甄选</div>
            <div class="text-xs text-white/80">SUNSHINE PROCUREMENT</div>
          </div>
        </a>
        <div class="flex items-center max-w-2xl w-full">
          <select class="h-10 px-5 pr-8 bg-white text-gray-700 rounded-l-lg border-0 text-sm min-w-[100px]" id="searchType" style="background-image: url('data:image/svg+xml;charset=UTF-8,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'12\' height=\'12\' viewBox=\'0 0 12 12\'%3E%3Cpath fill=\'%236B7280\' d=\'M6 9L1 4h10z\'/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 10px center;">
            <option value="product">商品</option>
            <option value="store">店铺</option>
          </select>
          <input type="text" id="searchInput" placeholder="请输入您想查找的商品" class="flex-1 h-10 px-4 text-gray-900 search-input rounded-none text-sm" onkeypress="if(event.key==='Enter')handleSearch()">
          <button type="button" onclick="handleSearch()" class="h-10 px-6 bg-white text-primary rounded-r-lg font-medium hover:bg-gray-50 transition-colors"><i class="fas fa-search mr-1"></i>搜索</button>
        </div>
        <div id="topUserBar" class="absolute right-0 flex items-center gap-3 hidden">
          <span class="w-8 h-8 rounded-full bg-white/25 flex items-center justify-center flex-shrink-0" title="用户头像"><i class="fas fa-user text-white text-sm"></i></span>
          <span id="topGreet" class="text-base text-white/95 font-bold"></span>
          <button type="button" onclick="handleLogout()" class="px-3 py-1.5 text-xs font-medium text-white border border-white/80 rounded-md hover:bg-white/20 transition-colors" title="退出登录">退出</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ==================== Tab 页切换区 ==================== -->
  <div class="bg-white border-b border-gray-200">
    <div class="max-w-[1400px] mx-auto px-4">
      <div class="flex items-center gap-4" id="tabNav">
        <button class="tab-btn active" data-tab="home">首页</button>
        <button class="tab-btn" data-tab="announce">平台公告</button>
        <button class="tab-btn" data-tab="witness">阳光见证链</button>
        <button class="tab-btn" data-tab="batch">批量采购</button>
      </div>
    </div>
  </div>
  
  <!-- ==================== 主内容区 ==================== -->
  <div class="max-w-[1400px] mx-auto px-4 py-4">
    <!-- 首页 Tab 内容 -->
    <div id="tabContentHome">
      <!-- 核心展示区：左侧分类 + 右侧轮播 + 悬停浮层 -->
      <div class="core-display flex gap-4 mb-4" id="coreDisplay">
        <!-- 左侧商品分类 -->
        <aside class="category-panel cat-left rounded-lg overflow-hidden">
          <a href="#" class="block py-3 px-4 bg-primary text-white text-center font-medium hover:bg-primary/90" onclick="return false;"><i class="fas fa-shopping-bag mr-2"></i>全部商品</a>
          <nav class="category-list py-2" id="categoryList">
            <!-- 分类列表由 JS 渲染 -->
          </nav>
        </aside>

        <!-- 推广轮播页 -->
        <div class="flex-1 min-w-0">
          <div class="carousel" id="carousel">
            <div class="carousel-slides" id="carouselSlides"></div>
            <div class="carousel-arrow left" id="carouselPrev"><i class="fas fa-chevron-left"></i></div>
            <div class="carousel-arrow right" id="carouselNext"><i class="fas fa-chevron-right"></i></div>
            <div class="carousel-dots" id="carouselDots"></div>
          </div>
        </div>

        <!-- 悬停展开浮层（二级/三级分类 + 热门商品） -->
        <div class="mega-panel hidden" id="megaPanel">
          <div class="mega-left" id="megaCategories"></div>
          <div class="mega-right" id="megaHotProducts"></div>
        </div>
      </div>

      <!-- ==================== 分类推荐区 ==================== -->
    <!-- 分类推荐 1：办公用品 电脑数码 -->
    <section class="bg-white rounded-lg border border-gray-200 overflow-hidden mb-4 reco-section">
      <div class="font-semibold text-gray-900 px-4 py-3 border-b border-gray-100">分类推荐</div>
      <div class="flex min-h-[300px]">
        <div class="reco-panel w-56 shrink-0 flex flex-col justify-between p-4">
          <div>
            <h3 class="text-lg font-bold text-white mb-2">办公用品 电脑数码</h3>
            <div class="w-24 h-24 mx-auto my-4 bg-white/10 rounded flex items-center justify-center"><i class="fas fa-print text-4xl text-white/90"></i></div>
          </div>
          <a href="#" class="block w-full py-2 text-center bg-primary text-white text-sm rounded hover:bg-primary/90" onclick="return false;">查看更多 <i class="fas fa-chevron-right text-xs"></i></a>
        </div>
        <div class="flex-1 p-4">
          <div class="flex flex-wrap items-center gap-2 mb-3">
            <button type="button" class="tab-2nd active px-4 py-2 rounded text-sm" data-block="0" data-tab="all">全部</button>
            <button type="button" class="tab-2nd px-4 py-2 rounded text-sm" data-block="0" data-tab="paper">复印纸</button>
            <button type="button" class="tab-2nd px-4 py-2 rounded text-sm" data-block="0" data-tab="printer">打印机</button>
            <button type="button" class="tab-2nd px-4 py-2 rounded text-sm" data-block="0" data-tab="file">文件管理</button>
            <button type="button" class="tab-2nd px-4 py-2 rounded text-sm" data-block="0" data-tab="write">书写/修正用品</button>
            <a href="#" class="ml-auto px-4 py-2 text-primary text-sm font-medium hover:underline" onclick="return false;">查看更多</a>
          </div>
          <div class="grid grid-cols-5 gap-3" id="recoProducts0">
            <!-- 5 个商品卡片由 JS 渲染 -->
          </div>
        </div>
      </div>
    </section>
    
    <!-- 分类推荐 2：个人防护 安全防护 -->
    <section class="bg-white rounded-lg border border-gray-200 overflow-hidden mb-4 reco-section">
      <div class="flex min-h-[300px]">
        <div class="reco-panel sec2 w-56 shrink-0 flex flex-col justify-between p-4">
          <div>
            <h3 class="text-lg font-bold text-white mb-2">个人防护 安全防护</h3>
            <div class="w-24 h-24 mx-auto my-4 bg-white/10 rounded flex items-center justify-center"><i class="fas fa-hard-hat text-4xl text-white/90"></i></div>
          </div>
          <a href="#" class="block w-full py-2 text-center bg-primary text-white text-sm rounded hover:bg-primary/90" onclick="return false;">查看更多 <i class="fas fa-chevron-right text-xs"></i></a>
        </div>
        <div class="flex-1 p-4">
          <div class="flex flex-wrap items-center gap-2 mb-3">
            <button type="button" class="tab-2nd active px-4 py-2 rounded text-sm" data-block="1" data-tab="all">全部</button>
            <button type="button" class="tab-2nd px-4 py-2 rounded text-sm" data-block="1" data-tab="head">头部防护</button>
            <button type="button" class="tab-2nd px-4 py-2 rounded text-sm" data-block="1" data-tab="resp">呼吸防护</button>
            <button type="button" class="tab-2nd px-4 py-2 rounded text-sm" data-block="1" data-tab="hand">手部防护</button>
            <button type="button" class="tab-2nd px-4 py-2 rounded text-sm" data-block="1" data-tab="road">道路安全</button>
            <a href="#" class="ml-auto px-4 py-2 text-primary text-sm font-medium hover:underline" onclick="return false;">查看更多</a>
          </div>
          <div class="grid grid-cols-5 gap-3" id="recoProducts1">
            <!-- 5 个商品卡片由 JS 渲染 -->
          </div>
        </div>
      </div>
    </section>

    <!-- 分类推荐 3：工具耗材 机床数控 -->
    <section class="bg-white rounded-lg border border-gray-200 overflow-hidden reco-section">
      <div class="flex min-h-[300px]">
        <div class="reco-panel sec3 w-56 shrink-0 flex flex-col justify-between p-4">
          <div>
            <h3 class="text-lg font-bold text-white mb-2">工具耗材 机床数控</h3>
            <div class="w-24 h-24 mx-auto my-4 bg-white/10 rounded flex items-center justify-center"><i class="fas fa-wrench text-4xl text-white/90"></i></div>
          </div>
          <a href="#" class="block w-full py-2 text-center bg-primary text-white text-sm rounded hover:bg-primary/90" onclick="return false;">查看更多 <i class="fas fa-chevron-right text-xs"></i></a>
        </div>
        <div class="flex-1 p-4">
          <div class="flex flex-wrap items-center gap-2 mb-3">
            <button type="button" class="tab-2nd active px-4 py-2 rounded text-sm" data-block="2" data-tab="all">全部</button>
            <button type="button" class="tab-2nd px-4 py-2 rounded text-sm" data-block="2" data-tab="manual">手动工具</button>
            <button type="button" class="tab-2nd px-4 py-2 rounded text-sm" data-block="2" data-tab="electric">电动工具</button>
            <button type="button" class="tab-2nd px-4 py-2 rounded text-sm" data-block="2" data-tab="machine">机床配件</button>
            <button type="button" class="tab-2nd px-4 py-2 rounded text-sm" data-block="2" data-tab="measure">测量工具</button>
            <a href="#" class="ml-auto px-4 py-2 text-primary text-sm font-medium hover:underline" onclick="return false;">查看更多</a>
          </div>
          <div class="grid grid-cols-5 gap-3" id="recoProducts2">
            <!-- 5 个商品卡片由 JS 渲染 -->
          </div>
        </div>
      </div>
    </section>
      
      <!-- ==================== 入驻供应商 ==================== -->
      <section class="bg-white rounded-lg border border-gray-200 mt-4">
        <div class="px-4 py-3 text-center font-semibold text-primary text-lg">
          ———————— 入驻供应商 ————————
        </div>
        <div class="p-4">
          <div class="supplier-grid" id="supplierGrid"></div>
        </div>
      </section>

      <!-- ==================== 底部商城信息 ==================== -->
      <section class="footer-services rounded-lg mt-4 px-6 py-5">
        <div class="footer-inner">
          <div class="footer-left">
            <div class="footer-quick-links" id="footerQuickLinks">
              <a href="home.html">首页</a><span class="sep">|</span><a href="#">行业专区</a><span class="sep">|</span><a href="sourcing_inquiry.html">寻源询价</a><span class="sep">|</span><a href="#">询价报价</a><span class="sep">|</span><a href="#">风险查询</a><span class="sep">|</span><a href="#">供应商信用认证</a>
            </div>
            <div class="footer-org" id="footerMeta">
              主办单位：中资数据科技有限公司 &nbsp;&nbsp; 技术单位：中富通集团股份有限公司 &nbsp;&nbsp; 网站备案：京ICP备2020043237号-4
            </div>
          </div>
          <div class="footer-right" id="footerServices">
            <!-- 5 个图标+文字由 JS 渲染 -->
          </div>
        </div>
      </section>
    </div>

    <!-- 平台公告 Tab 内容 -->
    <div id="tabContentAnnounce" class="hidden">
      <div class="bg-white rounded-lg border border-gray-200 p-4">
        <div class="font-semibold text-gray-900 mb-3">平台公告</div>
        <ul class="text-sm text-gray-600 space-y-2">
          <li>• 阳光甄选平台隐私政策</li>
          <li>• 阳光甄选平台用户服务协议</li>
          <li>• 阳光甄选平台采购规则说明</li>
        </ul>
      </div>
    </div>

    <!-- 阳光见证链 Tab 内容 -->
    <div id="tabContentWitness" class="hidden">
      <div class="bg-white rounded-lg border border-gray-200 p-4">
        <div class="font-semibold text-gray-900 mb-3">阳光见证链</div>
        <div class="text-sm text-gray-600">展示阳光见证链入口与可信溯源说明（占位）。</div>
      </div>
    </div>

    <!-- 批量采购 Tab 内容 -->
    <div id="tabContentBatch" class="hidden">
      <div class="bg-white rounded-lg border border-gray-200 p-4">
        <div class="flex items-start justify-between gap-3 flex-wrap">
          <div>
            <div class="font-semibold text-gray-900">批量采购</div>
            <div class="text-xs text-gray-500 mt-1">支持导入采购单（xlsx/xls/csv），逐行匹配商城商品。任一校验错误将导致整单不导入。</div>
          </div>
          <div class="flex items-center gap-2 flex-wrap">
            <div class="relative" id="bpTemplateWrap">
              <button type="button" class="px-3 h-9 rounded-md border border-gray-200 bg-white text-gray-700 text-sm hover:border-primary hover:text-primary transition-colors inline-flex items-center gap-2" id="bpBtnTemplate">
                <i class="fas fa-download text-xs"></i>采购单模板下载<i class="fas fa-chevron-down text-[10px] opacity-70"></i>
              </button>
              <div class="hidden absolute right-0 mt-2 w-52 bg-white border border-gray-200 rounded-md shadow-lg overflow-hidden z-[60]" id="bpTemplateMenu">
                <button type="button" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50" data-bp-template="xlsx">Excel模板（.xlsx）</button>
                <button type="button" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50" data-bp-template="xls">Excel模板（.xls）</button>
                <button type="button" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50" data-bp-template="csv">CSV模板（.csv）</button>
                <button type="button" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50 border-t border-gray-100" data-bp-template="fields">字段说明</button>
              </div>
            </div>

            <input type="file" id="bpImportInput" accept=".xlsx,.xls,.csv" class="hidden">
            <button type="button" class="px-3 h-9 rounded-md bg-primary text-white text-sm hover:bg-primary/90 transition-colors inline-flex items-center gap-2" id="bpBtnImport">
              <i class="fas fa-file-import text-xs"></i>导入采购单
            </button>
          </div>
        </div>

        <!-- 拖拽上传区 -->
        <div class="mt-4 border-2 border-dashed border-gray-200 rounded-lg p-6 bg-gray-50 text-center" id="bpDropZone">
          <div class="text-gray-700 text-sm font-medium"><i class="fas fa-cloud-upload-alt mr-1 text-gray-500"></i>拖拽文件到此处，或点击上方“导入采购单”</div>
          <div class="text-xs text-gray-500 mt-2">支持：xlsx / xls / csv（模板含示例行，导入时会自动忽略以“【示例】”开头的行）</div>
        </div>

        <!-- 错误原因（只展示原因） -->
        <div class="mt-4 hidden" id="bpErrorBox">
          <div class="border border-red-200 bg-red-50 rounded-lg p-4">
            <div class="flex items-center gap-2 text-red-700 font-semibold text-sm"><i class="fas fa-triangle-exclamation"></i>导入失败</div>
            <div class="text-xs text-red-700/90 mt-2">发现以下问题，本次采购单未导入：</div>
            <ul class="mt-2 text-sm text-red-800 list-disc pl-5" id="bpErrorList"></ul>
          </div>
        </div>

        <!-- 字段说明 -->
        <div class="mt-4 hidden" id="bpFieldsBox">
          <div class="border border-gray-200 bg-white rounded-lg p-4">
            <div class="flex items-center justify-between gap-2">
              <div class="text-sm font-semibold text-gray-900">字段说明（不含税）</div>
              <button type="button" class="text-xs text-gray-500 hover:text-gray-700" id="bpBtnCloseFields"><i class="fas fa-times"></i></button>
            </div>
            <div class="mt-2 text-xs text-gray-600 leading-6">
              <div><span class="font-semibold text-gray-800">商品名称*</span>、<span class="font-semibold text-gray-800">品牌*</span>、<span class="font-semibold text-gray-800">供应商*</span>、<span class="font-semibold text-gray-800">数量*</span>：均为必填。数量须为大于 0 的整数。</div>
            </div>
          </div>
        </div>

        <!-- 汇总栏 -->
        <div class="mt-4 hidden" id="bpSummaryBar">
          <div class="flex items-center justify-between gap-3 flex-wrap border border-gray-200 bg-white rounded-lg px-4 py-3">
            <div class="text-sm text-gray-700">总行数：<span class="font-semibold text-gray-900" id="bpSumTotal">0</span></div>
          </div>
        </div>

        <!-- 清单表格（文字增大、垂直居中） -->
        <div class="mt-4 hidden" id="bpTableWrap">
          <div class="overflow-x-auto border border-gray-200 rounded-lg">
            <table class="min-w-[800px] w-full text-base bp-table-center">
              <thead class="bg-gray-50 text-gray-700">
                <tr class="align-middle">
                  <th class="text-left px-3 py-3 w-14">行号</th>
                  <th class="text-left px-3 py-3">商品名称</th>
                  <th class="text-left px-3 py-3 w-24">品牌</th>
                  <th class="text-left px-3 py-3 w-32">供应商</th>
                  <th class="text-right px-3 py-3 w-20">数量</th>
                  <th class="text-right px-3 py-3 w-24">价格</th>
                  <th class="text-left px-3 py-3 w-40">商品卡片</th>
                  <th class="text-left px-3 py-3 w-28 min-w-[7rem]">状态</th>
                  <th class="text-left px-3 py-3 w-28">操作</th>
                </tr>
              </thead>
              <tbody class="bg-white" id="bpTbody"></tbody>
            </table>
          </div>
        </div>

        <!-- 右下角：提交采购单 -->
        <div class="mt-4 hidden flex justify-end" id="bpSubmitWrap">
          <button type="button" class="px-6 h-10 rounded-md bg-primary text-white text-sm font-medium hover:bg-primary/90 transition-colors" id="bpBtnSubmit">
            提交采购单
          </button>
        </div>
      </div>

      <!-- 导入模拟弹窗：选择 导入成功 / 导入失败 -->
      <div class="ai-modal-overlay hidden" id="bpImportDemoOverlay" style="z-index: 880;"></div>
      <div class="ai-modal hidden" id="bpImportDemoModal" style="z-index: 890; right: 50%; transform: translate(50%, -50%); top: 50%; width: 360px;">
        <div class="ai-modal-header" style="background: linear-gradient(135deg, #E2231A 0%, #c01e16 100%);">
          <h3><i class="fas fa-file-import"></i> 原型演示</h3>
          <button class="ai-modal-close" type="button" id="bpImportDemoClose"><i class="fas fa-times"></i></button>
        </div>
        <div class="ai-modal-body" style="padding: 20px; background: #fafafa;">
          <div class="text-sm text-gray-700 mb-4">请选择导入结果以模拟演示：</div>
          <div class="flex flex-col gap-3">
            <button type="button" class="w-full h-11 rounded-lg bg-green-600 text-white font-medium hover:bg-green-700 transition-colors" id="bpBtnImportSuccess">导入成功</button>
            <button type="button" class="w-full h-11 rounded-lg bg-red-600 text-white font-medium hover:bg-red-700 transition-colors" id="bpBtnImportFail">导入失败</button>
          </div>
        </div>
      </div>

      <!-- 校验不通过弹窗（导入失败时展示理由） -->
      <div class="ai-modal-overlay hidden" id="bpValidateFailOverlay" style="z-index: 900;"></div>
      <div class="ai-modal hidden" id="bpValidateFailModal" style="z-index: 910; right: 50%; transform: translate(50%, -50%); top: 50%; width: 440px;">
        <div class="ai-modal-header" style="background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);">
          <h3><i class="fas fa-triangle-exclamation"></i> 校验不通过</h3>
          <button class="ai-modal-close" type="button" id="bpValidateFailClose"><i class="fas fa-times"></i></button>
        </div>
        <div class="ai-modal-body" style="padding: 20px; background: #fff;">
          <div class="text-sm text-gray-700 mb-3">导入表格校验未通过，请根据以下理由修正后重新导入：</div>
          <ul class="text-sm text-red-800 list-disc pl-5 space-y-1" id="bpValidateFailList"></ul>
        </div>
      </div>

      <!-- 选品弹窗（保留 DOM，导入成功后流程中不再使用） -->
      <div class="ai-modal-overlay" id="bpPickOverlay" style="z-index: 880;" onclick="bpClosePickModal()"></div>
      <div class="ai-modal" id="bpPickModal" style="z-index: 890; right: 50%; transform: translate(50%, 20px) scale(0.95); width: 980px; height: 640px;">
        <div class="ai-modal-header" style="background: linear-gradient(135deg, #E2231A 0%, #c01e16 100%);">
          <h3><i class="fas fa-list-check"></i> 选择对应商品</h3>
          <button class="ai-modal-close" onclick="bpClosePickModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="ai-modal-body" style="padding: 16px; background: #fafafa;">
          <div class="grid grid-cols-12 gap-3">
            <div class="col-span-4 bg-white border border-gray-200 rounded-lg p-3">
              <div class="text-sm font-semibold text-gray-900">待采购信息</div>
              <div class="text-xs text-gray-600 mt-2 leading-6" id="bpPickNeedInfo"></div>
              <div class="mt-3 border-t border-gray-100 pt-3">
                <div class="text-sm font-semibold text-gray-900">搜索条件</div>
                <div class="mt-2 space-y-2">
                  <div>
                    <div class="text-xs text-gray-500 mb-1">关键词</div>
                    <input type="text" id="bpPickKeyword" class="w-full h-9 px-3 rounded-md border border-gray-200 text-sm focus:border-primary" placeholder="商品名称 / 规格 / 品牌">
                  </div>
                  <div>
                    <div class="text-xs text-gray-500 mb-1">店铺名（模糊匹配）</div>
                    <input type="text" id="bpPickShop" class="w-full h-9 px-3 rounded-md border border-gray-200 text-sm focus:border-primary" placeholder="例如：震坤行">
                  </div>
                  <div class="grid grid-cols-2 gap-2">
                    <div>
                      <div class="text-xs text-gray-500 mb-1">最低价（不含税）</div>
                      <input type="text" id="bpPickMin" class="w-full h-9 px-3 rounded-md border border-gray-200 text-sm focus:border-primary" placeholder="可不填">
                    </div>
                    <div>
                      <div class="text-xs text-gray-500 mb-1">最高价（不含税）</div>
                      <input type="text" id="bpPickMax" class="w-full h-9 px-3 rounded-md border border-gray-200 text-sm focus:border-primary" placeholder="可不填">
                    </div>
                  </div>
                  <div class="flex gap-2">
                    <button type="button" class="flex-1 h-9 rounded-md bg-primary text-white text-sm hover:bg-primary/90" id="bpPickSearchBtn"><i class="fas fa-magnifying-glass text-xs mr-1"></i>搜索</button>
                    <button type="button" class="h-9 px-3 rounded-md border border-gray-200 bg-white text-sm hover:border-gray-300" id="bpPickClearShopBtn">清空店铺</button>
                  </div>
                  <div class="text-[11px] text-gray-500 leading-5">
                    - 默认带入：关键词 + 店铺名 + 最高/最低价<br>
                    - 选择范围外商品：仅在清单行提示，不拦截提交
                  </div>
                </div>
              </div>
            </div>
            <div class="col-span-8 bg-white border border-gray-200 rounded-lg p-3 flex flex-col min-h-0">
              <div class="flex items-center justify-between gap-2">
                <div class="text-sm font-semibold text-gray-900">候选商品</div>
                <div class="text-xs text-gray-500" id="bpPickCount">0 条</div>
              </div>
              <div class="mt-2 flex-1 overflow-y-auto" id="bpPickList"></div>
              <div class="mt-2 text-xs text-gray-500" id="bpPickEmptyHint">输入关键词后点击搜索。</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Toast -->
      <div class="ai-toast" id="bpToast" style="z-index: 910;"></div>
    </div>
  </div>

  <!-- ==================== 比质比价弹窗（全宽贴底、上下两块，无遮罩） ==================== -->
  <div class="compare-modal" id="compareModal">
    <div class="compare-modal-header">
      <button type="button" class="compare-modal-close" onclick="closeCompareModal()" title="关闭"><i class="fas fa-times"></i></button>
    </div>
    <!-- 上方：同品同规 / 相近品规 Tab 切换（可收起/展开） -->
    <div class="compare-section compare-section-similar" id="compareSectionSimilar">
      <div class="compare-section-head">
        <div class="compare-section-tabs">
          <button type="button" class="compare-section-tab" data-compare-tab="same" onclick="switchCompareUpperTab('same')">同品同规商品</button>
          <button type="button" class="compare-section-tab active" data-compare-tab="similar" onclick="switchCompareUpperTab('similar')">相近品规商品</button>
        </div>
        <button type="button" class="btn-toggle-similar" id="btnToggleSimilar" onclick="toggleCompareSimilarSection()">收起</button>
      </div>
      <div class="compare-section-body" id="compareUpperBody"></div>
    </div>
    <!-- 下方：比质比价（按钮在右侧上下排列） -->
    <div class="compare-section compare-section-with-actions">
      <div class="compare-section-title">比质比价</div>
      <div class="compare-section-row">
        <div class="compare-section-body" id="comparePendingList"></div>
        <div class="compare-section-actions">
          <button type="button" class="btn-clear" onclick="clearPendingCompare()">清空</button>
          <button type="button" class="btn-do" onclick="doCompare()">比质比价</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== 浮动菜单 ==================== -->
  <div class="float-menu flex flex-col gap-2 no-print">
    <a href="javascript:void(0)" class="float-item float-item-login" id="floatLoginOrWorkbench" title="登录">
      <i class="fas fa-sign-in-alt" id="floatLoginOrWorkbenchIcon"></i>
      <span id="floatLoginOrWorkbenchText">登录</span>
    </a>
    <a href="#" class="float-item text-gray-600 relative" title="购物车" onclick="return false;">
      <i class="fas fa-shopping-cart"></i>
      <span>购物车</span>
      <span id="cartBadge" class="absolute -top-1 -right-1 min-w-[18px] h-[18px] flex items-center justify-center bg-primary text-white text-[10px] rounded-full hidden">0</span>
    </a>
    <a href="sourcing_inquiry.html" class="float-item text-gray-600" title="寻源询价">
      <i class="fas fa-search"></i>
      <span>寻源询价</span>
    </a>
    <a href="#" class="float-item text-gray-600" title="返回顶部" onclick="window.scrollTo({top:0,behavior:'smooth'});return false;">
      <i class="fas fa-chevron-up"></i>
      <span>返回顶部</span>
    </a>
    <!-- AI 智能助手悬浮按钮（科技感样式） -->
    <div class="float-item-ai" id="aiAssistantBtn" title="AI 智能助手" onclick="openAiAssistant()">
      <i class="fas fa-robot"></i>
      <span>AI助手</span>
    </div>
  </div>

  <!-- ==================== AI 智能助手弹窗（对话窗口） ==================== -->
  <div class="ai-modal-overlay" id="aiModalOverlay" onclick="closeAiModal()"></div>
  <div class="ai-modal" id="aiModal">
    <div class="ai-modal-header">
      <h3><i class="fas fa-robot"></i> AI 智能助手</h3>
      <button class="ai-modal-close" onclick="closeAiModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="ai-modal-body">
      <div class="ai-chat-area" id="aiChatArea">
        <div class="ai-chat-messages" id="aiChatMessages">
          <!-- 欢迎消息 -->
          <div class="ai-message assistant">
            <div class="ai-message-bubble">
              您好！我是阳光甄选智能助手，可以帮您：<br>
              <strong>• 找商品</strong>：推荐商品、预算筛选、查看评价<br>
              <strong>• 做决策</strong>：比质比价、收藏商品、快速下单<br>
              <strong>• 解疑问</strong>：平台规则咨询<br><br>
              请问有什么可以帮您的？
            </div>
            <div class="ai-message-options">
              <button class="ai-option-btn" onclick="aiSendQuickMsg('有没有好用的复印纸？')">找复印纸</button>
              <button class="ai-option-btn" onclick="aiSendQuickMsg('200元内采购10箱A4复印纸')">预算内采购</button>
              <button class="ai-option-btn" onclick="aiSendQuickMsg('商品如何结算？')">规则咨询</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="ai-input-area">
      <input type="text" id="aiInput" placeholder="请输入您的问题..." onkeypress="if(event.key==='Enter')aiSendMessage()">
      <button onclick="aiSendMessage()">发送</button>
    </div>
  </div>

  <!-- ==================== AI 功能弹窗（商品推荐/比价/评价等） ==================== -->
  <div class="ai-func-modal" id="aiFuncModal">
    <div class="ai-func-modal-header">
      <h4><i class="fas fa-box-open"></i> <span id="aiFuncTitle">推荐商品</span></h4>
      <button class="ai-func-modal-close" onclick="closeFuncModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="ai-func-modal-body" id="aiFuncBody">
      <!-- 功能区内容由 JS 动态渲染 -->
    </div>
  </div>

  <!-- AI Toast 提示 -->
  <div class="ai-toast" id="aiToast"></div>
  
  <!-- SheetJS：用于解析/导出 xlsx/xls（批量采购原型） -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // ---------- 首页数据加载 ----------
    let homeData = null;
    function loadHomeData() {
      if (typeof initHomePageData === 'function') {
        homeData = initHomePageData();
      } else {
        homeData = { tabTabs: [], categories: [], carousel: [], settledSuppliers: [], footerServices: [] };
      }
    }

    // ---------- Tab 切换 ----------
    function switchTab(tabId) {
      document.querySelectorAll('#tabNav .tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabId);
      });
      document.getElementById('tabContentHome').classList.toggle('hidden', tabId !== 'home');
      document.getElementById('tabContentAnnounce').classList.toggle('hidden', tabId !== 'announce');
      document.getElementById('tabContentWitness').classList.toggle('hidden', tabId !== 'witness');
      document.getElementById('tabContentBatch').classList.toggle('hidden', tabId !== 'batch');
    }

    function bindTabEvents() {
      document.querySelectorAll('#tabNav .tab-btn').forEach(btn => {
        if (btn.tagName === 'A') return;
        btn.addEventListener('click', () => switchTab(btn.dataset.tab));
      });
    }

    // ---------- 左侧分类 & 悬停浮层 ----------
    let hideTimer = null;

    function renderCategoryList() {
      const container = document.getElementById('categoryList');
      if (!container || !homeData) return;
      container.innerHTML = homeData.categories.map((cat, idx) => `
        <a href="${cat.link || '#'}" class="cat-item block py-2.5 px-4 text-sm border-l-2 border-transparent ${idx === 0 ? 'active' : ''}" data-index="${idx}" onclick="return false;">
          <i class="fas ${cat.icon || 'fa-box'} w-5 text-center mr-1 text-gray-500"></i>${cat.name}
        </a>
      `).join('');

      container.querySelectorAll('[data-index]').forEach(item => {
        item.addEventListener('mouseenter', () => showMegaPanel(Number(item.dataset.index)));
        item.addEventListener('click', (e) => e.preventDefault());
      });
      container.addEventListener('mouseenter', () => clearTimeout(hideTimer));
      container.addEventListener('mouseleave', () => scheduleHideMega());
    }

    function showMegaPanel(index) {
      const panel = document.getElementById('megaPanel');
      if (!panel || !homeData) return;
      clearTimeout(hideTimer);
      document.querySelectorAll('#categoryList .cat-item').forEach((el, idx) => {
        el.classList.toggle('active', idx === index);
      });
      renderMegaPanel(homeData.categories[index]);
      panel.classList.remove('hidden');
    }

    function scheduleHideMega() {
      const panel = document.getElementById('megaPanel');
      if (!panel) return;
      hideTimer = setTimeout(() => panel.classList.add('hidden'), 180);
    }

    function renderMegaPanel(category) {
      const left = document.getElementById('megaCategories');
      const right = document.getElementById('megaHotProducts');
      if (!left || !right) return;

      const childCols = (category.children || []).map(child => {
        const subItems = (Array.isArray(child.children) ? child.children : []).map(name => `<a href="#" class="mega-item" onclick="return false;">${name}</a>`).join('');
        return `
          <div class="mega-col">
            <div class="mega-col-title">${child.name} <span class="text-gray-400">></span></div>
            <div>${subItems || `<a href="#" class="mega-item" onclick="return false;">查看</a>`}</div>
          </div>
        `;
      }).join('');

      left.innerHTML = childCols || '<div class="text-sm text-gray-500">暂无二级分类</div>';

      const hotProducts = category.hotProducts || [];
      const productCards = hotProducts.slice(0, 3).map(p => `
        <a href="${p.link || '#'}" class="mega-product-card" onclick="return false;">
          <img src="${p.image || ''}" alt="" onerror="this.src='https://placehold.co/56/eee/999?text=+'">
          <div class="info">
            <div class="name">${p.name || ''}</div>
            <div class="price">¥${(p.price != null ? Number(p.price).toFixed(2) : '0.00')}</div>
          </div>
        </a>
      `).join('');

      right.innerHTML = `
        <div class="mega-hot-header">
          <span class="font-semibold text-gray-900">热门商品</span>
        </div>
        <div class="mega-hot-products flex-1 min-h-0 overflow-y-auto">${productCards || '<div class="text-sm text-gray-500">暂无热门商品</div>'}</div>
      `;
    }

    // ---------- 推广轮播 ----------
    let carouselIndex = 0;
    let carouselTimer = null;

    function renderCarousel() {
      const slidesEl = document.getElementById('carouselSlides');
      const dotsEl = document.getElementById('carouselDots');
      if (!slidesEl || !dotsEl || !homeData) return;

      const slides = homeData.carousel || [];
      if (!slides.length) {
        slidesEl.innerHTML = `<div class="carousel-slide" style="background-image: none; background: #e5e7eb;">
          <div class="carousel-text">
            <div class="text-xl font-bold text-gray-800">推广轮播占位</div>
            <div class="text-sm text-gray-600">请在 Mock 数据中补充轮播图片与文案</div>
          </div>
        </div>`;
        dotsEl.innerHTML = '';
        return;
      }
      const defaultCarouselImg = 'https://images.unsplash.com/photo-1607082348824-0a96f2a4b9da?w=1200&h=675&fit=crop';
      slidesEl.innerHTML = slides.map(s => `
        <div class="carousel-slide" style="background-image: url('${s.image || defaultCarouselImg}');">
          <div class="carousel-overlay"></div>
          <div class="carousel-text">
            ${s.tag ? `<div class="carousel-tag">${s.tag}</div>` : ''}
            <div class="text-2xl font-bold mb-2">${s.title || ''}</div>
            <div class="text-sm text-white/90">${s.subTitle || ''}</div>
          </div>
        </div>
      `).join('');

      dotsEl.innerHTML = slides.map((_, i) => `<div class="carousel-dot ${i===0?'active':''}" data-index="${i}"></div>`).join('');

      dotsEl.querySelectorAll('.carousel-dot').forEach(dot => {
        dot.addEventListener('click', () => goToSlide(Number(dot.dataset.index)));
      });
      updateCarousel();
      startCarouselAuto();
    }

    function updateCarousel() {
      const slidesEl = document.getElementById('carouselSlides');
      const dots = document.querySelectorAll('.carousel-dot');
      if (!slidesEl) return;
      slidesEl.style.transform = `translateX(-${carouselIndex * 100}%)`;
      dots.forEach((d, i) => d.classList.toggle('active', i === carouselIndex));
    }

    function goToSlide(index) {
      const slidesCount = (homeData.carousel || []).length;
      if (!slidesCount) return;
      carouselIndex = (index + slidesCount) % slidesCount;
      updateCarousel();
    }

    function nextSlide() { goToSlide(carouselIndex + 1); }
    function prevSlide() { goToSlide(carouselIndex - 1); }

    function startCarouselAuto() {
      clearInterval(carouselTimer);
      carouselTimer = setInterval(nextSlide, 5000);
    }

    function bindCarouselEvents() {
      const prev = document.getElementById('carouselPrev');
      const next = document.getElementById('carouselNext');
      const carousel = document.getElementById('carousel');
      if (prev) prev.addEventListener('click', prevSlide);
      if (next) next.addEventListener('click', nextSlide);
      if (carousel) {
        carousel.addEventListener('mouseenter', () => clearInterval(carouselTimer));
        carousel.addEventListener('mouseleave', startCarouselAuto);
      }
    }

    // ---------- 入驻供应商（两行，每行 6 个：图片 + 名称 + 主营业务） ----------
    function renderSuppliers() {
      const el = document.getElementById('supplierGrid');
      if (!el || !homeData) return;
      const list = (homeData.settledSuppliers || []).slice(0, 12);
      el.innerHTML = list.map(s => `
        <a href="${s.link || '#'}" class="supplier-card block">
          <div class="supplier-card-img-wrap">
            <img src="${s.image || s.logo || 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=400&h=250&fit=crop'}" alt="${s.name}" class="supplier-card-img" loading="lazy">
            <div class="supplier-card-overlay">
              <div class="supplier-card-name line-clamp-2">${s.name}</div>
              <div class="supplier-card-business line-clamp-2">${s.business || s.subName || ''}</div>
            </div>
          </div>
        </a>
      `).join('');
    }

    // ---------- 底部商城信息（右侧 5 个图标+文字） ----------
    function renderFooterServices() {
      const el = document.getElementById('footerServices');
      if (!el || !homeData) return;
      const list = (homeData.footerServices || []).slice(0, 5);
      el.innerHTML = list.map(s => `
        <div class="footer-icon-item">
          <div class="icon-wrap"><i class="fas ${s.icon || 'fa-shield-alt'}"></i></div>
          <span class="icon-text">${s.text}</span>
        </div>
      `).join('');
    }

    // ---------- Mock：分类推荐商品（含最低价 min 用于合理性横条） ----------
    const recoMock = {
      0: { // 办公用品 电脑数码（同品同规：台×4、盒×3、包×3）
        all: [
          { id: 1, name: 'FUJIFILM/富士胶片 A4黑白激光打印机 ApeosPort Print  C4572', price: 1653.46, unit: '台', supplier: '震坤行工业超市(上海)有限公司', ref: 1986.35, min: 1580, img: 'https://images.unsplash.com/photo-1612815154858-60aa4c59eaa6?w=400&h=300&fit=crop' },
          { id: 2, name: '晨光 M&G 中性笔 GP1163(盒) 0.5mm 中性笔 黑色 12支/盒', price: 19.46, unit: '盒', supplier: '咸亨国际科技股份有限公司', ref: 24.94, min: 16, img: 'https://images.unsplash.com/photo-1585338107529-13afc5f02586?w=400&h=300&fit=crop' },
          { id: 3, name: '天章复印纸 A5 80g 白色 500张/包 10包/箱 新绿天章', price: 123, unit: '件', supplier: '苏宁易购集团股份有限公司', ref: 139.67, min: 98, img: 'https://images.unsplash.com/photo-1586281380349-632531db7ed4?w=400&h=300&fit=crop' },
          { id: 4, name: '齐心 C3674-5 A4复印纸白色 70g 500张/包 白色/70g/50', price: 25.92, unit: '包', supplier: '鑫方盛数智科技股份有限公司', ref: 33.87, min: 22, img: 'https://images.unsplash.com/photo-1586281380349-632531db7ed4?w=400&h=300&fit=crop' },
          { id: 9, name: '得力 文件夹 A4 文件袋 资料袋 透明塑料文件夹 10个装', price: 28.50, unit: '套', supplier: '得力集团股份有限公司', ref: 35.80, min: 24, img: 'https://images.unsplash.com/photo-1586281380349-632531db7ed4?w=400&h=300&fit=crop' },
          { id: 10, name: '惠普 HP LaserJet Pro 激光打印机 无线打印 自动双面', price: 1899.00, unit: '台', supplier: '惠普(中国)有限公司', ref: 2299.00, min: 2100, img: 'https://images.unsplash.com/photo-1612815154858-60aa4c59eaa6?w=400&h=300&fit=crop' },
          { id: 13, name: '佳能 Canon 激光打印机 商用 A4 黑白', price: 1299.00, unit: '台', supplier: '佳能(中国)有限公司', ref: 1599.00, min: 1100, img: 'https://images.unsplash.com/photo-1612815154858-60aa4c59eaa6?w=400&h=300&fit=crop' },
          { id: 14, name: '联想 小新 激光打印机 家用 无线', price: 899.00, unit: '台', supplier: '联想(北京)有限公司', ref: 1099.00, min: 750, img: 'https://images.unsplash.com/photo-1612815154858-60aa4c59eaa6?w=400&h=300&fit=crop' },
          { id: 15, name: '白雪 中性笔 12支/盒 0.5mm 多色', price: 12.80, unit: '盒', supplier: '白雪文具股份有限公司', ref: 15.60, min: 10, img: 'https://images.unsplash.com/photo-1585338107529-13afc5f02586?w=400&h=300&fit=crop' },
          { id: 16, name: '得力 A4复印纸 70g 500张/包 5包/箱', price: 22.50, unit: '包', supplier: '得力集团股份有限公司', ref: 28.00, min: 18, img: 'https://images.unsplash.com/photo-1586281380349-632531db7ed4?w=400&h=300&fit=crop' },
          { id: 17, name: '晨光 A4复印纸 80g 500张/包 白色', price: 28.00, unit: '包', supplier: '晨光文具股份有限公司', ref: 34.00, min: 24, img: 'https://images.unsplash.com/photo-1586281380349-632531db7ed4?w=400&h=300&fit=crop' }
        ],
        paper: [ 2, 3, 4, 1, 9 ], printer: [ 1, 10, 13, 14, 2 ], file: [ 9, 3, 4, 1, 2 ], write: [ 2, 15, 4, 1, 9 ]
      },
      1: { // 个人防护 安全防护（同品同规：顶×3、只×3、盒×3）
        all: [
          { id: 5, name: '唐丰 安全帽 TF/唐丰ABS-V 安全帽 蓝 售卖规格:1顶', price: 17.70, unit: '顶', supplier: '西域智慧供应链(上海)股份公司', ref: 19.09, min: 15, img: 'https://images.unsplash.com/photo-1582555172866-f73bb12a2ab3?w=400&h=300&fit=crop' },
          { id: 6, name: 'CM/朝美 含活性炭颗粒物防护口罩 活性炭净化加厚型口罩', price: 1.24, unit: '只', supplier: '震坤行工业超市(上海)有限公司', ref: 1.44, min: 1.0, img: 'https://images.unsplash.com/photo-1584036561566-baf8f5f1b34b?w=400&h=300&fit=crop' },
          { id: 7, name: '星宇 劳保手套300#毛圈加绒加厚pvc浸胶发泡防滑防水耐', price: 59.10, unit: '双', supplier: '欧菲斯集团股份有限公司', ref: 59.41, min: 52, img: 'https://images.unsplash.com/photo-1553062407-98eeb64c6a62?w=400&h=300&fit=crop' },
          { id: 8, name: '安赛瑞 310075 安赛瑞基坑护栏网 建筑工地施工围栏隔离', price: 239, unit: '个', supplier: '深圳市怡亚通供应链股份有限公司', ref: 288.76, min: 210, img: 'https://images.unsplash.com/photo-1504307651254-35680f356dfd?w=400&h=300&fit=crop' },
          { id: 11, name: '3M 防护眼镜 防冲击护目镜 防雾防尘 工业安全眼镜', price: 45.80, unit: '副', supplier: '3M中国有限公司', ref: 58.00, min: 42, img: 'https://images.unsplash.com/photo-1582555172866-f73bb12a2ab3?w=400&h=300&fit=crop' },
          { id: 12, name: '霍尼韦尔 防尘口罩 KN95 防护口罩 50只装', price: 89.90, unit: '盒', supplier: '霍尼韦尔(中国)有限公司', ref: 109.90, min: 95, img: 'https://images.unsplash.com/photo-1584036561566-baf8f5f1b34b?w=400&h=300&fit=crop' },
          { id: 18, name: '梅思安 安全帽 黄色 V型 透气', price: 22.00, unit: '顶', supplier: '梅思安(中国)安全设备有限公司', ref: 26.00, min: 18, img: 'https://images.unsplash.com/photo-1582555172866-f73bb12a2ab3?w=400&h=300&fit=crop' },
          { id: 19, name: '霍尼韦尔 安全帽 H7 白色 带帽檐', price: 28.50, unit: '顶', supplier: '霍尼韦尔(中国)有限公司', ref: 34.00, min: 24, img: 'https://images.unsplash.com/photo-1582555172866-f73bb12a2ab3?w=400&h=300&fit=crop' },
          { id: 20, name: '3M  KN95 防护口罩 10只/包', price: 15.80, unit: '只', supplier: '3M中国有限公司', ref: 19.00, min: 12, img: 'https://images.unsplash.com/photo-1584036561566-baf8f5f1b34b?w=400&h=300&fit=crop' },
          { id: 27, name: '朝美 防尘口罩 一次性 50只/盒', price: 12.00, unit: '只', supplier: '建德市朝美日化有限公司', ref: 15.00, min: 9, img: 'https://images.unsplash.com/photo-1584036561566-baf8f5f1b34b?w=400&h=300&fit=crop' },
          { id: 28, name: '稳健 医用外科口罩 50只/盒', price: 25.00, unit: '盒', supplier: '稳健医疗用品股份有限公司', ref: 32.00, min: 20, img: 'https://images.unsplash.com/photo-1584036561566-baf8f5f1b34b?w=400&h=300&fit=crop' },
          { id: 29, name: '振德 KN95 防护口罩 25只/盒', price: 38.00, unit: '盒', supplier: '振德医疗用品股份有限公司', ref: 48.00, min: 32, img: 'https://images.unsplash.com/photo-1584036561566-baf8f5f1b34b?w=400&h=300&fit=crop' }
        ],
        head: [ 5, 18, 19, 11, 6 ], resp: [ 6, 12, 20, 27, 7 ], hand: [ 7, 5, 6, 8, 11 ], road: [ 8, 5, 6, 7, 12 ]
      },
      2: { // 工具耗材 机床数控（同品同规：台×4、套×3、把×3）
        all: [
          { id: 21, name: '博世 GSR 手电钻 13mm 家用电动螺丝刀', price: 299, unit: '台', supplier: '博世(中国)有限公司', ref: 359, min: 260, img: 'https://images.unsplash.com/photo-1504148455328-c376907d081c?w=400&h=300&fit=crop' },
          { id: 22, name: '世达 32件套筒扳手套装 公制', price: 268, unit: '套', supplier: '世达工具(上海)有限公司', ref: 318, min: 240, img: 'https://images.unsplash.com/photo-1530124566582-a618bc2615dc?w=400&h=300&fit=crop' },
          { id: 23, name: '三丰 数显游标卡尺 150mm', price: 158, unit: '把', supplier: '三丰精密量仪(上海)有限公司', ref: 188, min: 140, img: 'https://images.unsplash.com/photo-1504307651254-35680f356dfd?w=400&h=300&fit=crop' },
          { id: 24, name: '牧田 角磨机 100mm 750W', price: 398, unit: '台', supplier: '牧田(中国)有限公司', ref: 458, min: 360, img: 'https://images.unsplash.com/photo-1504148455328-c376907d081c?w=400&h=300&fit=crop' },
          { id: 25, name: '史丹利 羊角锤 0.5kg 木柄', price: 45, unit: '把', supplier: '史丹利工具(上海)有限公司', ref: 55, min: 38, img: 'https://images.unsplash.com/photo-1530124566582-a618bc2615dc?w=400&h=300&fit=crop' },
          { id: 26, name: '得伟 锂电钻 12V 双电版', price: 588, unit: '套', supplier: '得伟(中国)有限公司', ref: 688, min: 620, img: 'https://images.unsplash.com/photo-1504148455328-c376907d081c?w=400&h=300&fit=crop' },
          { id: 30, name: '东成 角磨机 720W 100型', price: 168.00, unit: '台', supplier: '江苏东成电动工具有限公司', ref: 198.00, min: 140, img: 'https://images.unsplash.com/photo-1504148455328-c376907d081c?w=400&h=300&fit=crop' },
          { id: 31, name: '锐奇 电锤 两用 26mm', price: 358.00, unit: '台', supplier: '上海锐奇工具股份有限公司', ref: 428.00, min: 300, img: 'https://images.unsplash.com/photo-1504148455328-c376907d081c?w=400&h=300&fit=crop' },
          { id: 32, name: '博世 46件套筒扳手套装', price: 398.00, unit: '套', supplier: '博世(中国)有限公司', ref: 468.00, min: 350, img: 'https://images.unsplash.com/photo-1530124566582-a618bc2615dc?w=400&h=300&fit=crop' },
          { id: 33, name: '世达 十字螺丝刀 6件套', price: 35.00, unit: '把', supplier: '世达工具(上海)有限公司', ref: 42.00, min: 28, img: 'https://images.unsplash.com/photo-1530124566582-a618bc2615dc?w=400&h=300&fit=crop' },
          { id: 34, name: '史丹利 活动扳手 300mm', price: 68.00, unit: '把', supplier: '史丹利工具(上海)有限公司', ref: 82.00, min: 55, img: 'https://images.unsplash.com/photo-1530124566582-a618bc2615dc?w=400&h=300&fit=crop' }
        ],
        manual: [ 22, 25, 33, 34, 21 ], electric: [ 21, 24, 30, 31, 26 ], machine: [ 23, 24, 21, 22, 26 ], measure: [ 23, 22, 21, 24, 25 ]
      }
    };

    function getPriceEvaluation(price, minPrice, refPrice) {
      if (refPrice <= minPrice) return '价格合理';
      var ratio = (price - minPrice) / (refPrice - minPrice);
      if (ratio <= 0.25) return '高性价比';
      if (ratio <= 0.5) return '价格适中';
      if (ratio <= 1) return '价格合理';
      return '价格偏高';
    }
    
    function getProductByBlockIndex(block, tab) {
      const d = recoMock[block];
      if (tab === 'all' || !d[tab]) return d.all.slice(0, 5);
      return d[tab].map(id => d.all.find(p => p.id === id)).filter(Boolean).slice(0, 5);
    }
    
    function renderProductCard(p, blockId) {
      var bid = (blockId != null ? blockId : 0);
      return `<div class="product-card rounded-lg overflow-hidden bg-white border border-gray-200 cursor-pointer" data-product-id="${p.id}" data-block-id="${bid}" onclick="event.preventDefault(); event.stopPropagation(); openCompareModal(this);" role="button" title="AI比质比价">
        <img src="picture/商品卡片.png" alt="商品卡片" class="w-full h-auto block object-cover" loading="lazy">
      </div>`;
    }
    
    function renderBlock(blockId) {
      const tab = document.querySelector(`[data-block="${blockId}"].tab-2nd.active`)?.dataset.tab || 'all';
      const list = getProductByBlockIndex(Number(blockId), tab);
      const el = document.getElementById('recoProducts' + blockId);
if (el) el.innerHTML = list.map(p => renderProductCard(p, blockId)).join('');
    }

    // ---------- 比质比价弹窗 ----------
    var compareSimilarProducts = [];
    var compareSameSpecProducts = [];
    var comparePendingList = [];
    var compareUpperTab = 'similar';
    var compareMaxItems = 10;

    function getCurrentCompareSourceList() {
      return compareUpperTab === 'same' ? compareSameSpecProducts : compareSimilarProducts;
    }

    function updateCompareUpperTabButtons() {
      document.querySelectorAll('.compare-section-tab').forEach(function(btn) {
        btn.classList.toggle('active', btn.dataset.compareTab === compareUpperTab);
      });
    }

    function switchCompareUpperTab(tab) {
      compareUpperTab = tab;
      updateCompareUpperTabButtons();
      renderCompareUpperContent();
    }

    function getProductById(blockId, productId) {
      var d = recoMock[blockId];
      if (!d || !d.all) return null;
      return d.all.find(function(p) { return p.id === productId || p.id === Number(productId); });
    }

    function openCompareModal(btn) {
      var card = btn.closest('.product-card');
      if (!card) return;
      var productId = card.dataset.productId;
      var blockId = card.dataset.blockId;
      var product = getProductById(Number(blockId), productId);
      if (!product) return;
      comparePendingList = [{ id: product.id, name: product.name, price: product.price, img: product.img, unit: product.unit }];
      var allInBlock = recoMock[Number(blockId)] ? (recoMock[Number(blockId)].all || []) : [];
      compareSimilarProducts = allInBlock.filter(function(p) { return p.id !== product.id && String(p.id) !== String(productId); });
      compareSameSpecProducts = allInBlock.filter(function(p) { return p.id !== product.id && String(p.id) !== String(productId) && (p.unit === product.unit); });
      compareUpperTab = 'same';
      updateCompareUpperTabButtons();
      renderCompareUpperContent();
      renderComparePendingList();
      var sectionSimilar = document.getElementById('compareSectionSimilar');
      if (sectionSimilar) sectionSimilar.classList.remove('collapsed');
      var btnToggle = document.getElementById('btnToggleSimilar');
      if (btnToggle) btnToggle.textContent = '收起';
      document.getElementById('compareModal').classList.add('show');
    }

    function toggleCompareSimilarSection() {
      var section = document.getElementById('compareSectionSimilar');
      var btn = document.getElementById('btnToggleSimilar');
      if (!section || !btn) return;
      section.classList.toggle('collapsed');
      btn.textContent = section.classList.contains('collapsed') ? '展开' : '收起';
    }

    function closeCompareModal() {
      document.getElementById('compareModal').classList.remove('show');
    }

    function renderCompareUpperContent() {
      var el = document.getElementById('compareUpperBody');
      if (!el) return;
      var list = getCurrentCompareSourceList();
      var emptyText = compareUpperTab === 'same' ? '暂无同品同规商品' : '暂无相近品规商品';
      if (!list.length) {
        el.innerHTML = '<span class="compare-empty-hint">' + emptyText + '</span>';
        return;
      }
      el.innerHTML = list.map(function(p) {
        var checked = comparePendingList.some(function(x) { return x.id === p.id; }) ? ' checked' : '';
        var nameEsc = (p.name || '').replace(/"/g, '&quot;');
        var supplierEsc = (p.supplier || '').replace(/"/g, '&quot;');
        return '<label class="compare-card compare-card-checkable">' +
          '<span class="thumb-wrap">' +
          '<img src="' + (p.img || '') + '" alt="" class="thumb" onerror="this.src=\'https://placehold.co/140/eee/999?text=+\'">' +
          '<input type="checkbox" data-product-id="' + p.id + '" onchange="toggleComparePending(' + p.id + ', this.checked, this)"' + checked + '>' +
          '</span>' +
          '<div class="info"><div class="name" title="' + nameEsc + '">' + (p.name || '') + '</div><div class="supplier" title="' + supplierEsc + '">' + (p.supplier || '') + '</div><div class="price-row"><span class="price">¥' + (p.price != null ? Number(p.price).toFixed(2) : '0.00') + '</span><span class="reco-card-price-tag">合规</span></div></div>' +
          '</label>';
      }).join('');
    }

    function renderComparePendingList() {
      var el = document.getElementById('comparePendingList');
      if (!el) return;
      if (!comparePendingList.length) {
        el.innerHTML = '<span class="compare-empty-hint">待比质比价（已选商品）</span>';
        return;
      }
      el.innerHTML = comparePendingList.map(function(p) {
        var nameEsc = (p.name || '').replace(/"/g, '&quot;');
        return '<div class="compare-card has-remove">' +
          '<button type="button" class="btn-remove" onclick="removeFromComparePending(' + p.id + ')" title="移除"><i class="fas fa-times"></i></button>' +
          '<img src="' + (p.img || '') + '" alt="" class="thumb" onerror="this.src=\'https://placehold.co/140/eee/999?text=+\'">' +
          '<div class="info"><div class="name" title="' + nameEsc + '">' + (p.name || '') + '</div><div class="price-row"><span class="price">¥' + (p.price != null ? Number(p.price).toFixed(2) : '0.00') + '</span><span class="reco-card-price-tag">合规</span></div></div>' +
          '</div>';
      }).join('');
    }

    function toggleComparePending(productId, checked, checkboxEl) {
      var list = getCurrentCompareSourceList();
      if (checked) {
        if (comparePendingList.length >= compareMaxItems) {
          alert('最多可添加' + compareMaxItems + '个商品');
          if (checkboxEl) checkboxEl.checked = false;
          return;
        }
        var p = list.find(function(x) { return x.id === productId; });
        if (p && !comparePendingList.some(function(x) { return x.id === productId; })) {
          comparePendingList.push({ id: p.id, name: p.name, price: p.price, img: p.img, unit: p.unit });
        }
      } else {
        comparePendingList = comparePendingList.filter(function(x) { return x.id !== productId; });
      }
      renderCompareUpperContent();
      renderComparePendingList();
    }

    function removeFromComparePending(productId) {
      comparePendingList = comparePendingList.filter(function(x) { return x.id !== productId; });
      renderCompareUpperContent();
      renderComparePendingList();
    }

    function clearPendingCompare() {
      comparePendingList = [];
      renderCompareUpperContent();
      renderComparePendingList();
    }

    function doCompare() {
      if (comparePendingList.length < 2) {
        alert('请至少添加2个商品进行比质比价');
        return;
      }
      closeCompareModal();
      alert('原型演示：比质比价功能（已选' + comparePendingList.length + '个商品）');
    }

    // 二级分类标签切换
    document.querySelectorAll('.tab-2nd').forEach(btn => {
      btn.addEventListener('click', function() {
        const block = this.dataset.block;
        this.parentElement.querySelectorAll('.tab-2nd').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        renderBlock(block);
      });
    });
    
    function handleSearch() {
      const type = document.getElementById('searchType').value;
      const kw = (document.getElementById('searchInput').value || '').trim();
      if (type === 'store' && kw) { window.location.href = 'store/store_list.html?keyword=' + encodeURIComponent(kw); return; }
      if (type === 'product') { window.location.href = '#'; /* category.html?q= */ return; }
    }
    
    function showLogin() { alert('原型演示：登录功能暂未实现'); }
    
    function isProtoLoggedIn() { return localStorage.getItem('protoLoggedIn') === '1'; }
    function updateFloatMenuLoginState() {
      var link = document.getElementById('floatLoginOrWorkbench');
      var icon = document.getElementById('floatLoginOrWorkbenchIcon');
      var text = document.getElementById('floatLoginOrWorkbenchText');
      if (!link || !icon || !text) return;
      if (isProtoLoggedIn()) {
        link.href = 'workbench/workbench_home.html';
        link.title = '工作台';
        link.classList.remove('float-item-login');
        link.removeAttribute('onclick');
        link.onclick = null;
        icon.className = 'fas fa-tachometer-alt';
        text.textContent = '工作台';
      } else {
        link.href = 'javascript:void(0)';
        link.title = '登录';
        link.classList.add('float-item-login');
        link.onclick = function(e) { e.preventDefault(); handleFloatLoginClick(); return false; };
        icon.className = 'fas fa-sign-in-alt';
        text.textContent = '登录';
      }
    }
    function handleFloatLoginClick() {
      if (isProtoLoggedIn()) return;
      localStorage.setItem('protoLoggedIn', '1');
      updateFloatMenuLoginState();
      updateGreet();
    }
    
    function getCurrentRole() { return localStorage.getItem('role') || 'guest'; }
    function switchRole(v) { localStorage.setItem('role', v); updateGreet(); }
    function updateGreet() {
      var r = getCurrentRole();
      var proto = localStorage.getItem('protoLoggedIn') === '1';
      var greet = document.getElementById('topGreet');
      var topUserBar = document.getElementById('topUserBar');
      if (topUserBar) topUserBar.classList.toggle('hidden', !proto);
      if (!proto && r === 'guest') { if (greet) greet.textContent = ''; }
      else { if (greet) greet.textContent = '张三（' + (r==='buyer'?'采购专员':r==='buyer-user'?'普通采购用户':r==='supplier'?'供应商':r==='admin'?'管理员':'普通采购用户') + '）'; }
    }
    function handleLogout() {
      localStorage.removeItem('protoLoggedIn');
      updateFloatMenuLoginState();
      updateGreet();
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      localStorage.removeItem('protoLoggedIn');
      loadHomeData();
      bindTabEvents();
      switchTab('home');
      renderCategoryList();
      renderCarousel();
      bindCarouselEvents();
      renderSuppliers();
      renderFooterServices();

      const megaPanel = document.getElementById('megaPanel');
      if (megaPanel) {
        megaPanel.addEventListener('mouseenter', () => clearTimeout(hideTimer));
        megaPanel.addEventListener('mouseleave', scheduleHideMega);
      }

      var r = getCurrentRole();
      var sel = document.getElementById('roleSelect'); if (sel) sel.value = r;
      updateFloatMenuLoginState();
      updateGreet();
      renderBlock(0);
      renderBlock(1);
      renderBlock(2);

      // 批量采购
      if (typeof initBatchPurchase === 'function') initBatchPurchase();
    });

    // ==================== AI 智能助手逻辑 ====================
    
    // Mock 商品数据
    const aiMockProducts = [
      { id: 1, name: '齐心 C3674-5 A4复印纸 70g 500张/包', brand: '齐心', price: 25.92, unit: '包', sales: 8520, score: 4.8, img: 'https://images.unsplash.com/photo-1586281380349-632531db7ed4?w=400&h=300&fit=crop' },
      { id: 2, name: '天章复印纸 A4 80g 白色 500张/包 10包/箱', brand: '天章', price: 28.50, unit: '包', sales: 6230, score: 4.7, img: 'https://images.unsplash.com/photo-1586281380349-632531db7ed4?w=400&h=300&fit=crop' },
      { id: 3, name: '得力 A4复印纸 70g 办公用纸 500张/包', brand: '得力', price: 23.80, unit: '包', sales: 12350, score: 4.9, img: 'https://images.unsplash.com/photo-1586281380349-632531db7ed4?w=400&h=300&fit=crop' },
      { id: 4, name: '星宇 劳保手套 防穿刺 防滑耐磨 12双/包', brand: '星宇', price: 59.10, unit: '包', sales: 3280, score: 4.6, img: 'https://images.unsplash.com/photo-1553062407-98eeb64c6a62?w=400&h=300&fit=crop' },
      { id: 5, name: '唐丰 安全帽 ABS-V型 蓝色 1顶', brand: '唐丰', price: 17.70, unit: '顶', sales: 5620, score: 4.5, img: 'https://images.unsplash.com/photo-1582555172866-f73bb12a2ab3?w=400&h=300&fit=crop' },
    ];
    
    // Mock 评价数据
    const aiMockReviews = {
      positive: [
        { user: '采购员小李', content: '纸张质量很好，打印清晰，物流很快！', tag: 'positive' },
        { user: '办公室王经理', content: '一直用这个牌子，性价比很高，推荐！', tag: 'positive' },
        { user: '张先生', content: '包装完好，纸张厚度合适，非常满意。', tag: 'positive' },
      ],
      negative: [
        { user: '匿名用户', content: '物流有点慢，等了5天才到。', tag: 'negative' },
        { user: '采购部小陈', content: '有一包纸边角有点破损，希望加强包装。', tag: 'negative' },
      ]
    };
    
    // 当前对话上下文
    let aiContext = {
      lastProducts: [],
      lastIntent: null,
      favorites: []
    };
    
    // 打开 AI 智能助手（新窗口）
    function openAiAssistant() {
      // 检查登录状态
      if (!isProtoLoggedIn()) {
        // 未登录，提示用户登录
        if (confirm('请先登录后使用 AI 智能助手。\n\n点击「确定」进行登录。')) {
          // 模拟登录
          localStorage.setItem('protoLoggedIn', '1');
          updateFloatMenuLoginState();
          updateGreet();
          // 登录成功后打开 AI 助手
          window.open('ai_assistant.html', '_blank');
        }
        return;
      }
      // 已登录，在新窗口打开 AI 交互页面
      window.open('ai_assistant.html', '_blank');
    }
    
    // 保留原弹窗函数（兼容）
    function openAiModal() {
      openAiAssistant();
    }
    
    // 关闭 AI 弹窗（兼容）
    function closeAiModal() {
      const overlay = document.getElementById('aiModalOverlay');
      const modal = document.getElementById('aiModal');
      if (overlay) overlay.classList.remove('show');
      if (modal) modal.classList.remove('show');
      closeFuncModal();
    }
    
    // 关闭功能弹窗
    function closeFuncModal() {
      const funcModal = document.getElementById('aiFuncModal');
      if (funcModal) funcModal.classList.remove('show');
    }
    
    // 发送快捷消息
    function aiSendQuickMsg(msg) {
      document.getElementById('aiInput').value = msg;
      aiSendMessage();
    }
    
    // 发送消息
    function aiSendMessage() {
      const input = document.getElementById('aiInput');
      const msg = (input.value || '').trim();
      if (!msg) return;
      
      // 添加用户消息
      aiAddMessage(msg, 'user');
      input.value = '';
      
      // 显示加载
      aiShowLoading();
      
      // 模拟延迟后响应
      setTimeout(() => {
        aiHideLoading();
        aiProcessMessage(msg);
      }, 800 + Math.random() * 400);
    }
    
    // 添加消息到对话区
    function aiAddMessage(content, type, options = null) {
      const container = document.getElementById('aiChatMessages');
      const msgDiv = document.createElement('div');
      msgDiv.className = `ai-message ${type}`;
      
      let html = `<div class="ai-message-bubble">${content}</div>`;
      if (options && options.length) {
        html += `<div class="ai-message-options">${options.map(o => 
          `<button class="ai-option-btn" onclick="${o.action}">${o.label}</button>`
        ).join('')}</div>`;
      }
      msgDiv.innerHTML = html;
      container.appendChild(msgDiv);
      container.scrollTop = container.scrollHeight;
    }
    
    // 显示/隐藏加载
    function aiShowLoading() {
      const container = document.getElementById('aiChatMessages');
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'ai-message assistant';
      loadingDiv.id = 'aiLoading';
      loadingDiv.innerHTML = `<div class="ai-loading"><div class="ai-loading-dots"><span></span><span></span><span></span></div><span>正在思考...</span></div>`;
      container.appendChild(loadingDiv);
      container.scrollTop = container.scrollHeight;
    }
    
    function aiHideLoading() {
      const loading = document.getElementById('aiLoading');
      if (loading) loading.remove();
    }
    
    // 显示功能弹窗（独立弹窗，显示在对话弹窗左侧）
    function aiShowFuncPanel(content, title = '推荐商品', icon = 'fa-box-open') {
      const modal = document.getElementById('aiFuncModal');
      const body = document.getElementById('aiFuncBody');
      const titleEl = document.getElementById('aiFuncTitle');
      
      // 更新标题和图标
      titleEl.innerHTML = title;
      modal.querySelector('.ai-func-modal-header h4 i').className = `fas ${icon}`;
      
      // 更新内容
      body.innerHTML = content;
      
      // 显示弹窗
      modal.classList.add('show');
    }
    
    // 隐藏功能弹窗
    function aiHideFuncPanel() {
      document.getElementById('aiFuncModal').classList.remove('show');
    }
    
    // 显示 Toast
    function aiShowToast(msg) {
      const toast = document.getElementById('aiToast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }
    
    // 处理消息 - 意图识别与响应
    function aiProcessMessage(msg) {
      const msgLower = msg.toLowerCase();
      
      // 1.1 商品推荐（模糊查询）
      if (msgLower.includes('复印纸') || msgLower.includes('打印纸') || msgLower.includes('纸')) {
        aiContext.lastIntent = 'product_recommend';
        aiContext.lastProducts = aiMockProducts.filter(p => p.name.includes('纸')).slice(0, 3);
        
        // 追问规格
        aiAddMessage('请问您需要什么规格的复印纸？', 'assistant', [
          { label: 'A4 70g', action: "aiSelectSpec('A4', '70g')" },
          { label: 'A4 80g', action: "aiSelectSpec('A4', '80g')" },
          { label: 'A5 70g', action: "aiSelectSpec('A5', '70g')" },
        ]);
        return;
      }
      
      if (msgLower.includes('手套') || msgLower.includes('防穿刺') || msgLower.includes('劳保')) {
        aiContext.lastIntent = 'product_recommend';
        aiContext.lastProducts = aiMockProducts.filter(p => p.name.includes('手套')).slice(0, 3);
        aiShowProductRecommend('为您找到以下劳保手套：', aiContext.lastProducts);
        return;
      }
      
      // 1.2 预算内商品筛选
      if (msgLower.includes('元') && (msgLower.includes('采购') || msgLower.includes('预算'))) {
        aiContext.lastIntent = 'budget_filter';
        const budgetMatch = msg.match(/(\d+)\s*元/);
        const budget = budgetMatch ? parseInt(budgetMatch[1]) : 200;
        const quantityMatch = msg.match(/(\d+)\s*箱/);
        const quantity = quantityMatch ? parseInt(quantityMatch[1]) : 10;
        
        const products = aiMockProducts.filter(p => p.name.includes('纸') && p.price * quantity <= budget);
        if (products.length > 0) {
          aiContext.lastProducts = products;
          aiShowBudgetProducts(budget, quantity, products);
        } else {
          aiAddMessage(`未找到预算 ${budget} 元内的商品，是否提高预算至 ${budget + 100} 元？`, 'assistant', [
            { label: '是', action: `aiSendQuickMsg('${budget + 100}元内采购${quantity}箱A4复印纸')` },
            { label: '否', action: "aiAddMessage('好的，您可以尝试其他搜索条件。', 'assistant')" },
          ]);
        }
        return;
      }
      
      // 1.3 商品评价查询
      if (msgLower.includes('评价') || msgLower.includes('好评') || msgLower.includes('差评')) {
        aiContext.lastIntent = 'review_query';
        aiShowReviews();
        return;
      }
      
      // 2.1 比质比价
      if (msgLower.includes('比') || msgLower.includes('对比') || msgLower.includes('哪个更好')) {
        aiContext.lastIntent = 'compare';
        if (aiContext.lastProducts.length >= 2) {
          aiShowCompare(aiContext.lastProducts.slice(0, 3));
        } else {
          aiAddMessage('请先搜索商品后再进行比较。您可以问我"有没有好用的复印纸？"', 'assistant');
        }
        return;
      }
      
      // 2.2 收藏商品
      if (msgLower.includes('收藏')) {
        aiContext.lastIntent = 'favorite';
        if (aiContext.lastProducts.length > 0) {
          const product = aiContext.lastProducts[0];
          if (aiContext.favorites.includes(product.id)) {
            aiAddMessage(`<i class="fas fa-heart ai-favorite-icon"></i> "${product.name}" 已在收藏夹中，无需重复收藏。`, 'assistant', [
              { label: '取消收藏', action: `aiRemoveFavorite(${product.id})` },
              { label: '前往我的收藏', action: "aiShowToast('跳转到收藏页面...')" },
            ]);
          } else {
            aiContext.favorites.push(product.id);
            aiAddMessage(`<i class="fas fa-heart ai-favorite-icon"></i> 已收藏 "${product.name}"`, 'assistant', [
              { label: '前往我的收藏', action: "aiShowToast('跳转到收藏页面...')" },
            ]);
          }
        } else {
          aiAddMessage('未找到该商品，请先搜索商品后再收藏。', 'assistant');
        }
        return;
      }
      
      // 2.3 下单
      if (msgLower.includes('下单') || msgLower.includes('购买') || msgLower.includes('订单')) {
        aiContext.lastIntent = 'order';
        if (aiContext.lastProducts.length > 0) {
          const product = aiContext.lastProducts[0];
          aiShowOrderConfirm(product);
        } else {
          aiAddMessage('请先搜索并选择商品后再下单。您可以问我"有没有好用的复印纸？"', 'assistant');
        }
        return;
      }
      
      // 3. 规则咨询
      if (msgLower.includes('结算') || msgLower.includes('付款') || msgLower.includes('支付')) {
        aiContext.lastIntent = 'rule_consult';
        aiAddMessage(`<strong>商品结算方式：</strong><br><br>
          <strong>1. 在线支付</strong><br>
          支持支付宝、微信支付、银联等多种支付方式，支付成功后订单自动确认。<br><br>
          <strong>2. 对公转账</strong><br>
          适用于企业客户，下单后生成对公账户信息，转账后上传凭证，财务确认后发货。<br><br>
          <strong>3. 账期结算</strong><br>
          通过信用评估的企业客户可申请账期，支持月结、季结等方式。`, 'assistant', [
          { label: '查看详情', action: "aiShowToast('跳转到结算规则页面...')" },
        ]);
        aiHideFuncPanel();
        return;
      }
      
      if (msgLower.includes('退货') || msgLower.includes('退换') || msgLower.includes('退款')) {
        aiContext.lastIntent = 'rule_consult';
        aiAddMessage(`<strong>退货规则说明：</strong><br><br>
          <strong>1. 退货时限</strong><br>
          签收后 <strong>7 天内</strong> 可申请无理由退货（部分特殊商品除外）。<br><br>
          <strong>2. 退货条件</strong><br>
          商品需保持原包装完好，不影响二次销售。<br><br>
          <strong>3. 退款时效</strong><br>
          退货审核通过后，<strong>3-5 个工作日</strong> 内原路退回。`, 'assistant', [
          { label: '查看详情', action: "aiShowToast('跳转到退货规则页面...')" },
        ]);
        aiHideFuncPanel();
        return;
      }
      
      // 默认回复
      aiAddMessage('抱歉，我没有理解您的问题。您可以尝试：<br>• 找商品：如"有没有好用的复印纸？"<br>• 预算筛选：如"200元内采购10箱A4复印纸"<br>• 查评价：如"齐心复印纸有负面评价吗？"<br>• 规则咨询：如"商品如何结算？"', 'assistant');
      aiHideFuncPanel();
    }
    
    // 选择规格后显示推荐
    function aiSelectSpec(size, weight) {
      aiAddMessage(`${size} ${weight}`, 'user');
      setTimeout(() => {
        aiShowProductRecommend(`为您推荐以下 ${size} ${weight} 复印纸：`, aiContext.lastProducts);
      }, 500);
    }
    
    // 显示商品推荐
    function aiShowProductRecommend(text, products) {
      aiAddMessage(text, 'assistant');
      
      const cardsHtml = products.map((p, idx) => `
        <div class="ai-product-card">
          <img src="${p.img}" class="ai-product-card-img" alt="${p.name}">
          <div class="ai-product-card-name">${p.name}</div>
          <div class="ai-product-card-info">
            <span class="ai-product-card-price">¥${p.price.toFixed(2)}/${p.unit}</span>
            <span class="ai-product-card-score">销量 ${p.sales} | 评分 ${p.score}</span>
          </div>
          <div class="ai-product-card-actions">
            <button class="ai-btn-primary" onclick="aiAddToCart(${p.id})"><i class="fas fa-cart-plus"></i> 加入购物车</button>
            <button class="ai-btn-secondary" onclick="aiFavorite(${p.id})"><i class="fas fa-heart"></i></button>
            <button class="ai-btn-secondary" onclick="aiShowToast('跳转到商品详情页...')">详情</button>
          </div>
        </div>
      `).join('');
      
      aiShowFuncPanel(cardsHtml, '推荐商品', 'fa-box-open');
    }
    
    // 显示预算内商品
    function aiShowBudgetProducts(budget, quantity, products) {
      const product = products[0];
      const totalPrice = (product.price * quantity).toFixed(2);
      
      aiAddMessage(`为您找到预算 ${budget} 元内的商品，采购 ${quantity} 箱总价约 ¥${totalPrice}：`, 'assistant');
      
      const cardsHtml = products.map(p => `
        <div class="ai-product-card">
          <div class="ai-budget-tag"><i class="fas fa-check-circle"></i> 预算内</div>
          <img src="${p.img}" class="ai-product-card-img" alt="${p.name}">
          <div class="ai-product-card-name">${p.name}</div>
          <div class="ai-product-card-info">
            <span class="ai-product-card-price">¥${p.price.toFixed(2)}/${p.unit}</span>
            <span class="ai-product-card-score">总价 ¥${(p.price * quantity).toFixed(2)}（≤${budget}元）</span>
          </div>
          <div class="ai-product-card-actions">
            <button class="ai-btn-primary" onclick="aiAddToCart(${p.id})">加入购物车</button>
            <button class="ai-btn-primary" onclick="aiQuickOrder(${p.id}, ${quantity})">一键下单</button>
          </div>
        </div>
      `).join('');
      
      aiShowFuncPanel(cardsHtml, '预算内商品', 'fa-wallet');
    }
    
    // 显示评价
    function aiShowReviews() {
      aiAddMessage('该商品好评率 <strong>92%</strong>，负面评价主要集中在物流速度方面。', 'assistant', [
        { label: '查看全部评价', action: "aiShowToast('跳转到商品详情页评价标签...')" },
      ]);
      
      const positiveHtml = aiMockReviews.positive.map(r => `
        <div class="ai-review-item">
          <div class="ai-review-header">
            <span class="ai-review-user">${r.user}</span>
            <span class="ai-review-tag positive">好评</span>
          </div>
          <div class="ai-review-content">${r.content}</div>
        </div>
      `).join('');
      
      const negativeHtml = aiMockReviews.negative.map(r => `
        <div class="ai-review-item">
          <div class="ai-review-header">
            <span class="ai-review-user">${r.user}</span>
            <span class="ai-review-tag negative">差评</span>
          </div>
          <div class="ai-review-content">${r.content}</div>
        </div>
      `).join('');
      
      aiShowFuncPanel(`
        <div style="display: flex; gap: 8px; margin-bottom: 12px;">
          <button class="ai-option-btn" style="background: #dcfce7; border-color: #166534; color: #166534;" onclick="document.getElementById('reviewPositive').style.display='block';document.getElementById('reviewNegative').style.display='none';">正面 (${aiMockReviews.positive.length})</button>
          <button class="ai-option-btn" style="background: #fee2e2; border-color: #991b1b; color: #991b1b;" onclick="document.getElementById('reviewPositive').style.display='none';document.getElementById('reviewNegative').style.display='block';">负面 (${aiMockReviews.negative.length})</button>
        </div>
        <div id="reviewPositive">${positiveHtml}</div>
        <div id="reviewNegative" style="display: none;">${negativeHtml}</div>
      `, '商品评价', 'fa-star');
    }
    
    // 显示比质比价
    function aiShowCompare(products) {
      const p1 = products[0], p2 = products[1], p3 = products[2] || products[0];
      
      aiAddMessage(`根据对比分析，<strong>${p1.name}</strong> 在性价比方面表现最佳，推荐您优先选择。`, 'assistant');
      
      const tableHtml = `
        <table class="ai-compare-table">
          <tr><th>维度</th><th>商品1</th><th>商品2</th>${p3 !== p1 ? '<th>商品3</th>' : ''}</tr>
          <tr><td>品牌</td><td>${p1.brand}</td><td>${p2.brand}</td>${p3 !== p1 ? `<td>${p3.brand}</td>` : ''}</tr>
          <tr><td>价格</td><td style="color:#E2231A;">¥${p1.price}</td><td>¥${p2.price}</td>${p3 !== p1 ? `<td>¥${p3.price}</td>` : ''}</tr>
          <tr><td>销量</td><td>${p1.sales}</td><td>${p2.sales}</td>${p3 !== p1 ? `<td>${p3.sales}</td>` : ''}</tr>
          <tr><td>评分</td><td style="color:#166534;">${p1.score}</td><td>${p2.score}</td>${p3 !== p1 ? `<td>${p3.score}</td>` : ''}</tr>
        </table>
        <div style="text-align: center; padding: 20px; background: #f9fafb; border-radius: 8px; margin-bottom: 12px;">
          <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">雷达图（示意）</div>
          <svg width="120" height="120" viewBox="0 0 120 120">
            <polygon points="60,10 110,40 95,100 25,100 10,40" fill="none" stroke="#e5e7eb" stroke-width="1"/>
            <polygon points="60,25 90,45 80,85 40,85 30,45" fill="none" stroke="#e5e7eb" stroke-width="1"/>
            <polygon points="60,40 70,50 65,70 55,70 50,50" fill="rgba(102,126,234,0.3)" stroke="#667eea" stroke-width="2"/>
          </svg>
        </div>
        <div style="display: flex; gap: 8px;">
          <button class="ai-btn-primary" style="flex:1;" onclick="aiAddToCart(${p1.id})">选择商品1</button>
          <button class="ai-btn-secondary" style="flex:1;" onclick="aiAddToCart(${p2.id})">选择商品2</button>
          ${p3 !== p1 ? `<button class="ai-btn-secondary" style="flex:1;" onclick="aiAddToCart(${p3.id})">选择商品3</button>` : ''}
        </div>
      `;
      
      aiShowFuncPanel(tableHtml, '比质比价', 'fa-balance-scale');
    }
    
    // 显示订单确认
    function aiShowOrderConfirm(product) {
      const quantity = 2;
      const totalPrice = (product.price * quantity).toFixed(2);
      
      // 模拟库存检查
      const stock = 5;
      if (quantity > stock) {
        aiAddMessage(`库存仅 ${stock} ${product.unit}，是否调整数量？`, 'assistant', [
          { label: `调整为 ${stock} ${product.unit}`, action: `aiConfirmOrder(${product.id}, ${stock})` },
          { label: '取消', action: "aiAddMessage('好的，已取消下单。', 'assistant')" },
        ]);
        return;
      }
      
      aiAddMessage(`即将为您创建订单：<br>商品：${product.name}<br>数量：${quantity} ${product.unit}<br>总价：¥${totalPrice}`, 'assistant');
      
      aiShowFuncPanel(`
        <div class="ai-product-card">
          <img src="${product.img}" class="ai-product-card-img" alt="${product.name}">
          <div class="ai-product-card-name">${product.name}</div>
          <div style="display: flex; justify-content: space-between; margin: 10px 0; font-size: 13px;">
            <span>数量：${quantity} ${product.unit}</span>
            <span style="color: #E2231A; font-weight: 600;">¥${totalPrice}</span>
          </div>
          <button class="ai-btn-primary" style="width: 100%;" onclick="aiConfirmOrder(${product.id}, ${quantity})">
            <i class="fas fa-check"></i> 确认下单
          </button>
        </div>
      `, '订单确认', 'fa-shopping-cart');
    }
    
    // 加入购物车
    function aiAddToCart(productId) {
      const product = aiMockProducts.find(p => p.id === productId);
      if (product) {
        aiShowToast(`已将 "${product.name}" 加入购物车`);
        // 更新购物车角标
        const badge = document.getElementById('cartBadge');
        if (badge) {
          const count = parseInt(badge.textContent || '0') + 1;
          badge.textContent = count;
          badge.classList.remove('hidden');
        }
      }
    }
    
    // 收藏商品
    function aiFavorite(productId) {
      const product = aiMockProducts.find(p => p.id === productId);
      if (product) {
        if (aiContext.favorites.includes(productId)) {
          aiShowToast(`"${product.name}" 已在收藏夹中`);
        } else {
          aiContext.favorites.push(productId);
          aiShowToast(`已收藏 "${product.name}"`);
        }
      }
    }
    
    // 取消收藏
    function aiRemoveFavorite(productId) {
      aiContext.favorites = aiContext.favorites.filter(id => id !== productId);
      aiShowToast('已取消收藏');
    }
    
    // 快速下单
    function aiQuickOrder(productId, quantity) {
      const product = aiMockProducts.find(p => p.id === productId);
      if (product) {
        aiShowToast('正在跳转到订单创建页...');
        setTimeout(() => {
          aiAddMessage(`订单已创建，商品：${product.name}，数量：${quantity}，正在跳转到订单提交页...`, 'assistant');
        }, 1000);
      }
    }
    
    // 确认下单
    function aiConfirmOrder(productId, quantity) {
      const product = aiMockProducts.find(p => p.id === productId);
      if (product) {
        aiShowToast('订单创建成功，正在跳转...');
        aiHideFuncPanel();
        setTimeout(() => {
          aiAddMessage(`<i class="fas fa-check-circle" style="color: #10B981;"></i> 订单创建成功！商品：${product.name}，数量：${quantity} ${product.unit}，总价：¥${(product.price * quantity).toFixed(2)}`, 'assistant');
        }, 500);
      }
    }
  </script>

  <script>
    // ==================== 批量采购（原型逻辑） ====================
    function initBatchPurchase() {
      // ----- DOM -----
      const btnTemplate = document.getElementById('bpBtnTemplate');
      const templateMenu = document.getElementById('bpTemplateMenu');
      const templateWrap = document.getElementById('bpTemplateWrap');
      const btnImport = document.getElementById('bpBtnImport');
      const importInput = document.getElementById('bpImportInput');
      const dropZone = document.getElementById('bpDropZone');

      const errorBox = document.getElementById('bpErrorBox');
      const errorList = document.getElementById('bpErrorList');
      const fieldsBox = document.getElementById('bpFieldsBox');
      const btnCloseFields = document.getElementById('bpBtnCloseFields');

      const summaryBar = document.getElementById('bpSummaryBar');
      const sumTotal = document.getElementById('bpSumTotal');
      const btnSubmit = document.getElementById('bpBtnSubmit');
      const submitWrap = document.getElementById('bpSubmitWrap');
      const importDemoOverlay = document.getElementById('bpImportDemoOverlay');
      const importDemoModal = document.getElementById('bpImportDemoModal');
      const importDemoClose = document.getElementById('bpImportDemoClose');
      const btnImportSuccess = document.getElementById('bpBtnImportSuccess');
      const btnImportFail = document.getElementById('bpBtnImportFail');
      const validateFailOverlay = document.getElementById('bpValidateFailOverlay');
      const validateFailModal = document.getElementById('bpValidateFailModal');
      const validateFailClose = document.getElementById('bpValidateFailClose');
      const validateFailList = document.getElementById('bpValidateFailList');

      const tableWrap = document.getElementById('bpTableWrap');
      const tbody = document.getElementById('bpTbody');

      // pick modal
      const pickOverlay = document.getElementById('bpPickOverlay');
      const pickModal = document.getElementById('bpPickModal');
      const pickNeedInfo = document.getElementById('bpPickNeedInfo');
      const pickKeyword = document.getElementById('bpPickKeyword');
      const pickShop = document.getElementById('bpPickShop');
      const pickMin = document.getElementById('bpPickMin');
      const pickMax = document.getElementById('bpPickMax');
      const pickSearchBtn = document.getElementById('bpPickSearchBtn');
      const pickClearShopBtn = document.getElementById('bpPickClearShopBtn');
      const pickList = document.getElementById('bpPickList');
      const pickCount = document.getElementById('bpPickCount');
      const pickEmptyHint = document.getElementById('bpPickEmptyHint');
      const toast = document.getElementById('bpToast');

      // ----- state -----
      /** @type {{id:string,rowNo:number,name:string,brand:string,shop:string,qty:number,price:number,productUrl:string,image:string}[]} */
      let bpRows = [];
      let bpPickRowId = null;

      // ----- mock products（含店铺、库存、商品链接，用于校验与导入成功列表） -----
      const bpProducts = [
        { id: 'SKU-1001', name: 'A4复印纸 70g 500张/包', brand: '得力', shop: '震坤行', price: 25.92, stock: 100, productUrl: 'store/store_detail.html?id=1001', image: 'https://images.unsplash.com/photo-1586281380349-632531db7ed4?w=200&h=200&fit=crop' },
        { id: 'SKU-1002', name: 'A4复印纸 70g 500张/包', brand: '齐心', shop: '震坤行', price: 23.50, stock: 80, productUrl: 'store/store_detail.html?id=1002', image: 'https://images.unsplash.com/photo-1586281380349-632531db7ed4?w=200&h=200&fit=crop' },
        { id: 'SKU-1003', name: 'A4复印纸 80g 500张/包', brand: '天章', shop: '苏宁易购', price: 28.50, stock: 200, productUrl: 'store/store_detail.html?id=1003', image: 'https://images.unsplash.com/photo-1586281380349-632531db7ed4?w=200&h=200&fit=crop' },
        { id: 'SKU-1004', name: '中性笔 0.5mm 黑色 12支/盒', brand: '晨光', shop: '晨光文具旗舰店', price: 19.46, stock: 500, productUrl: 'store/store_detail.html?id=1004', image: 'https://images.unsplash.com/photo-1585338107529-13afc5f02586?w=200&h=200&fit=crop' },
        { id: 'SKU-1005', name: '中性笔 0.5mm 黑色 12支/盒', brand: '百乐', shop: '欧菲斯', price: 29.00, stock: 120, productUrl: 'store/store_detail.html?id=1005', image: 'https://images.unsplash.com/photo-1585338107529-13afc5f02586?w=200&h=200&fit=crop' },
        { id: 'SKU-1006', name: '黑白激光打印机（自动双面/无线）', brand: '惠普', shop: '苏宁易购', price: 1899.00, stock: 15, productUrl: 'store/store_detail.html?id=1006', image: 'https://images.unsplash.com/photo-1612815154858-60aa4c59eaa6?w=200&h=200&fit=crop' },
        { id: 'SKU-1007', name: '黑白激光打印机（双面/网络）', brand: '佳能', shop: '京东企业购', price: 1699.00, stock: 8, productUrl: 'store/store_detail.html?id=1007', image: 'https://images.unsplash.com/photo-1612815154858-60aa4c59eaa6?w=200&h=200&fit=crop' },
        { id: 'SKU-1008', name: '羊角锤 0.5kg 木柄', brand: '史丹利', shop: '鑫方盛', price: 45.00, stock: 60, productUrl: 'store/store_detail.html?id=1008', image: 'https://images.unsplash.com/photo-1530124566582-a618bc2615dc?w=200&h=200&fit=crop' },
        { id: 'SKU-1009', name: '套筒扳手套装 32件/套', brand: '世达', shop: '鑫方盛', price: 268.00, stock: 30, productUrl: 'store/store_detail.html?id=1009', image: 'https://images.unsplash.com/photo-1530124566582-a618bc2615dc?w=200&h=200&fit=crop' },
        { id: 'SKU-1010', name: 'KN95 防护口罩 50只/盒', brand: '霍尼韦尔', shop: '震坤行', price: 89.90, stock: 200, productUrl: 'store/store_detail.html?id=1010', image: 'https://images.unsplash.com/photo-1584036561566-baf8f5f1b34b?w=200&h=200&fit=crop' },
      ];

      // 导入成功时的 10 条模拟数据（与 bpProducts 一一对应），状态默认「待采购」
      function getMockSuccessRows() {
        return bpProducts.map((p, i) => ({
          id: 'BP-' + p.id,
          rowNo: i + 1,
          name: p.name,
          brand: p.brand,
          shop: p.shop,
          qty: [10, 5, 20, 5, 3, 1, 1, 2, 1, 4][i],
          price: p.price,
          productUrl: p.productUrl,
          image: p.image,
          status: 'pending'  // 'pending' 待采购 | 'skipped' 暂不采购
        }));
      }

      // 导入失败时展示的 4 条校验理由（覆盖四项检索内容）
      const bpValidateFailReasons = [
        '未检索到「石墨烯电池」。',
        '未检索到「A4复印纸」的「南极人」品牌。',
        '未检索到「中性笔 0.5mm 黑色」的「某某小卖部」供应商。',
        '「震坤行」的「得力 A4复印纸 70g 500张/包」库存仅为 5 个，不足 10 个。'
      ];

      // ----- utils -----
      function bpShowToast(msg, withUndo) {
        if (!toast) return;
        toast.innerHTML = withUndo ? msg : (msg || '');
        toast.classList.add('show');
        clearTimeout(bpShowToast._timer);
        bpShowToast._timer = setTimeout(() => toast.classList.remove('show'), 2200);
      }

      function bpHideErrors() {
        if (errorBox) errorBox.classList.add('hidden');
        if (errorList) errorList.innerHTML = '';
      }

      function bpShowErrors(reasons) {
        bpHideErrors();
        if (!errorBox || !errorList) return;
        const uniq = Array.from(new Set((reasons || []).filter(Boolean)));
        errorList.innerHTML = uniq.map(r => `<li>${escapeHtml(r)}</li>`).join('');
        errorBox.classList.remove('hidden');
        // 清空导入状态
        bpRows = [];
        bpRenderAll();
      }

      function bpToggleFields(show) {
        if (!fieldsBox) return;
        fieldsBox.classList.toggle('hidden', !show);
      }

      function escapeHtml(s) {
        return String(s ?? '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function toNumOrNull(v) {
        if (v == null) return null;
        const s = String(v).trim();
        if (!s) return null;
        const n = Number(s);
        return Number.isFinite(n) ? n : NaN;
      }

      function normalizeText(v) {
        return String(v ?? '').trim().replace(/\s+/g, ' ');
      }

      function isEmptyRow(obj) {
        const keys = ['商品名称', '品牌', '供应商', '数量'];
        return keys.every(k => !normalizeText(obj[k]));
      }

      // ----- template generation（4 列均必填） -----
      const bpTemplateHeaders = ['商品名称', '品牌', '供应商', '数量'];
      const bpTemplateExample = ['【示例】A4复印纸', '得力', '震坤行', 10];

      function bpDownloadCsvTemplate() {
        const lines = [
          bpTemplateHeaders.join(','),
          bpTemplateExample.map(x => csvEscape(x)).join(',')
        ];
        const csv = '\ufeff' + lines.join('\r\n');
        downloadBlob(new Blob([csv], { type: 'text/csv;charset=utf-8;' }), '采购单模板.csv');
      }

      function bpDownloadExcelTemplate(bookType) {
        if (typeof XLSX === 'undefined') {
          alert('原型演示：Excel 导出库未加载，请稍后重试');
          return;
        }
        const aoa = [bpTemplateHeaders, bpTemplateExample];
        const ws = XLSX.utils.aoa_to_sheet(aoa);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, '采购明细');
        const ext = bookType === 'xls' ? 'xls' : 'xlsx';
        const out = XLSX.write(wb, { bookType: bookType, type: 'array' });
        downloadBlob(new Blob([out], { type: 'application/octet-stream' }), `采购单模板.${ext}`);
      }

      function csvEscape(v) {
        const s = String(v ?? '');
        if (/[",\r\n]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
        return s;
      }

      function downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 500);
      }

      // ----- import parse -----
      async function bpHandleFile(file) {
        if (!file) return;
        bpHideErrors();
        bpToggleFields(false);

        const name = file.name || '';
        const ext = (name.split('.').pop() || '').toLowerCase();
        if (!['xlsx', 'xls', 'csv'].includes(ext)) {
          bpShowErrors(['不支持的文件格式，请使用 xlsx/xls/csv']);
          return;
        }

        try {
          let rows;
          if (ext === 'csv') rows = await parseCsvFile(file);
          else rows = await parseExcelFile(file);

          const result = validateAndBuild(rows);
          if (result.errors.length) {
            bpShowErrors(result.errors);
            return;
          }
          // 原型：文件解析仅做格式校验，展示列表请使用「导入成功」按钮以获取带价格与商品卡片的模拟数据
          if (result.rows.length) {
            bpShowToast('格式校验通过。原型演示请点击「导入采购单」后选择「导入成功」查看列表。');
          }
        } catch (e) {
          console.error(e);
          bpShowErrors(['解析文件失败，请检查文件内容或重试']);
        }
      }

      function mapHeaderName(h) {
        return normalizeText(h);
      }

      function ensureHeaders(headers) {
        const mapped = (headers || []).map(mapHeaderName);
        const hasName = mapped.includes('商品名称');
        const hasBrand = mapped.includes('品牌');
        const hasShop = mapped.includes('供应商');
        const hasQty = mapped.includes('数量');
        const ok = hasName && hasBrand && hasShop && hasQty;
        return { ok, headers: mapped };
      }

      async function parseExcelFile(file) {
        if (typeof XLSX === 'undefined') throw new Error('XLSX not loaded');
        const buf = await file.arrayBuffer();
        const wb = XLSX.read(buf, { type: 'array' });
        const sheetName = wb.SheetNames.includes('采购明细') ? '采购明细' : wb.SheetNames[0];
        const ws = wb.Sheets[sheetName];
        const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, blankrows: false, defval: '' });
        const headerRowIdx = findHeaderRowIndex(aoa);
        if (headerRowIdx < 0) return { __header_error: true };
        const rawHeaders = (aoa[headerRowIdx] || []).map(x => normalizeText(x));
        const hdr = ensureHeaders(rawHeaders);
        if (!hdr.ok) return { __header_error: true };

        const body = aoa.slice(headerRowIdx + 1);
        return body.map(line => {
          const obj = {};
          hdr.headers.forEach((h, i) => { if (h) obj[h] = line[i] != null ? String(line[i]).trim() : ''; });
          return obj;
        });
      }

      function findHeaderRowIndex(aoa) {
        for (let i = 0; i < Math.min(10, aoa.length); i++) {
          const row = aoa[i] || [];
          const normalized = row.map(x => mapHeaderName(x));
          if (normalized.includes('商品名称') && normalized.includes('品牌') && normalized.includes('供应商') && normalized.includes('数量')) return i;
        }
        return -1;
      }

      async function parseCsvFile(file) {
        const text = await file.text();
        const lines = parseCsvText(text);
        if (!lines.length) return [];
        const rawHeaders = (lines[0] || []).map(x => normalizeText(x));
        const hdr = ensureHeaders(rawHeaders);
        if (!hdr.ok) return { __header_error: true };
        return lines.slice(1).map(arr => {
          const obj = {};
          hdr.headers.forEach((h, i) => { if (h) obj[h] = arr[i] != null ? String(arr[i]).trim() : ''; });
          return obj;
        });
      }

      function parseCsvText(text) {
        const rows = [];
        let row = [];
        let cur = '';
        let i = 0;
        let inQuotes = false;
        const s = String(text ?? '').replace(/\r\n/g, '\n').replace(/\r/g, '\n');
        while (i < s.length) {
          const ch = s[i];
          if (inQuotes) {
            if (ch === '"') {
              if (s[i + 1] === '"') { cur += '"'; i += 2; continue; }
              inQuotes = false; i++; continue;
            }
            cur += ch; i++; continue;
          }
          if (ch === '"') { inQuotes = true; i++; continue; }
          if (ch === ',') { row.push(cur); cur = ''; i++; continue; }
          if (ch === '\n') { row.push(cur); rows.push(row); row = []; cur = ''; i++; continue; }
          cur += ch; i++;
        }
        row.push(cur);
        rows.push(row);
        // 去掉尾部全空行
        return rows.filter(r => r.some(x => String(x ?? '').trim() !== ''));
      }

      function validateAndBuild(rows) {
        const errors = [];
        if (rows && rows.__header_error) {
          return { errors: ['文件表头不正确，请使用模板（商品名称、品牌、供应商、数量）'], rows: [] };
        }
        if (!Array.isArray(rows) || !rows.length) {
          return { errors: ['文件为空或仅包含空行'], rows: [] };
        }

        const built = [];
        const seen = new Set();
        let anyData = false;

        for (const raw of rows) {
          if (!raw || typeof raw !== 'object') continue;
          const obj = {};
          Object.keys(raw).forEach(k => { obj[mapHeaderName(k)] = raw[k]; });
          if (isEmptyRow(obj)) continue;

          const name = normalizeText(obj['商品名称']);
          if (!name) { errors.push('商品名称必填'); continue; }
          if (name.startsWith('【示例】')) { continue; }
          const brand = normalizeText(obj['品牌']);
          if (!brand) { errors.push('品牌必填'); continue; }
          const shop = normalizeText(obj['供应商']);
          if (!shop) { errors.push('供应商必填'); continue; }
          anyData = true;

          const qtyRaw = normalizeText(obj['数量']);
          if (!qtyRaw) { errors.push('数量必须为大于0的整数'); continue; }
          const qtyN = Number(qtyRaw);
          if (!Number.isFinite(qtyN) || !Number.isInteger(qtyN) || qtyN <= 0) { errors.push('数量必须为大于0的整数'); continue; }

          const key = [name, brand, shop].join('|');
          if (seen.has(key)) { errors.push('存在重复明细，请合并后再导入'); continue; }
          seen.add(key);

          built.push({
            id: 'BP-' + Math.random().toString(36).slice(2, 10),
            rowNo: built.length + 1,
            name,
            brand,
            shop,
            qty: qtyN
          });
        }

        if (!anyData) errors.push('文件为空或仅包含空行');
        return { errors: Array.from(new Set(errors)), rows: errors.length ? [] : built };
      }

      // ----- render -----
      function bpRenderAll() {
        bpRenderTable();
        bpRenderSummary();
      }

      function bpRenderTable() {
        if (!tbody || !tableWrap) return;
        if (!bpRows.length) {
          tableWrap.classList.add('hidden');
          return;
        }
        tableWrap.classList.remove('hidden');
        tbody.innerHTML = bpRows.map(r => {
          const isSkipped = r.status === 'skipped';
          const statusText = isSkipped ? '暂不采购' : '待采购';
          const statusCls = isSkipped ? 'text-amber-700 bg-amber-50 border-amber-200' : 'text-green-700 bg-green-50 border-green-200';
          const price = r.price != null ? Number(r.price).toFixed(2) : '-';
          const cardUrl = (r.productUrl || '').trim() || '#';
          const cardImg = (r.image || '').trim() ? r.image : 'https://placehold.co/80/eee/999?text=+';
          const cardHtml = `<a href="${escapeHtml(cardUrl)}" target="_blank" class="inline-flex items-center gap-2 p-2 border border-gray-200 rounded-lg hover:border-primary hover:bg-red-50/30 transition-colors" title="点击跳转商品详情">
            <img src="${escapeHtml(cardImg)}" alt="" class="w-14 h-14 object-cover rounded" onerror="this.src='https://placehold.co/80/eee/999?text=+'">
            <span class="text-sm text-gray-700 max-w-[80px] truncate">${escapeHtml(r.name)}</span>
          </a>`;
          const actionBtn = isSkipped
            ? `<button type="button" class="h-8 px-3 rounded-md border border-green-600 bg-green-600 text-white text-sm hover:bg-green-700 hover:border-green-700 transition-colors" onclick="bpResumeRow('${r.id}')">采购</button>`
            : `<button type="button" class="h-8 px-3 rounded-md border border-red-600 bg-red-600 text-white text-sm hover:bg-red-700 hover:border-red-700 transition-colors" onclick="bpSkipRow('${r.id}')">暂不采购</button>`;

          return `
            <tr class="border-t border-gray-100 align-middle">
              <td class="px-3 py-3 text-gray-900">${r.rowNo}</td>
              <td class="px-3 py-3">
                <div class="text-gray-900 font-medium">${escapeHtml(r.name)}</div>
              </td>
              <td class="px-3 py-3 text-gray-700">${escapeHtml(r.brand || '-')}</td>
              <td class="px-3 py-3 text-gray-700">${escapeHtml(r.shop || '-')}</td>
              <td class="px-3 py-3 text-right text-gray-900">${r.qty}</td>
              <td class="px-3 py-3 text-right text-gray-700">${price === '-' ? '-' : '¥' + price}</td>
              <td class="px-3 py-3">${cardHtml}</td>
              <td class="px-3 py-3 whitespace-nowrap">
                <span class="inline-flex items-center px-2 py-1 rounded-full border text-sm whitespace-nowrap ${statusCls}">${statusText}</span>
              </td>
              <td class="px-3 py-3">${actionBtn}</td>
            </tr>
          `;
        }).join('');

        summaryBar?.classList.remove('hidden');
        if (submitWrap) submitWrap.classList.remove('hidden');
      }

      function bpRenderSummary() {
        if (!summaryBar) return;
        if (!bpRows.length) {
          summaryBar.classList.add('hidden');
          if (submitWrap) submitWrap.classList.add('hidden');
          if (tbody) tbody.innerHTML = '';
          if (tableWrap) tableWrap.classList.add('hidden');
          return;
        }
        if (sumTotal) sumTotal.textContent = String(bpRows.length);
      }

      // ----- row actions（暂不采购：行保留，状态改为暂不采购，按钮变为「采购」） -----
      window.bpSkipRow = function(rowId) {
        const row = bpRows.find(r => r.id === rowId);
        if (!row) return;
        row.status = 'skipped';
        bpRenderAll();
        bpShowToast('已设为暂不采购');
      };

      window.bpResumeRow = function(rowId) {
        const row = bpRows.find(r => r.id === rowId);
        if (!row) return;
        row.status = 'pending';
        bpRenderAll();
        bpShowToast('已恢复为待采购');
      };

      function bpReindexRowNo() {
        bpRows.forEach((r, i) => { r.rowNo = i + 1; });
      }

      // ----- pick modal -----
      window.bpOpenPickModal = function(rowId) {
        const row = bpRows.find(r => r.id === rowId);
        if (!row) return;
        bpPickRowId = rowId;

        if (pickNeedInfo) {
          pickNeedInfo.innerHTML = `
            <div><span class="text-gray-500">商品：</span><span class="font-semibold text-gray-900">${escapeHtml(row.name)}</span></div>
            <div><span class="text-gray-500">规格：</span>${escapeHtml(row.spec || '-')}</div>
            <div><span class="text-gray-500">品牌：</span>${escapeHtml(row.brand || '-')}</div>
            <div><span class="text-gray-500">店铺：</span>${escapeHtml(row.shop || '-')}</div>
            <div><span class="text-gray-500">数量：</span>${row.qty}</div>
            <div><span class="text-gray-500">价格范围：</span>${row.minPrice==null?'-':Number(row.minPrice).toFixed(2)} ~ ${row.maxPrice==null?'-':Number(row.maxPrice).toFixed(2)}（不含税）</div>
          `;
        }

        if (pickKeyword) pickKeyword.value = [row.name, row.spec, row.brand].filter(Boolean).join(' ');
        if (pickShop) pickShop.value = row.shop || '';
        if (pickMin) pickMin.value = row.minPrice == null ? '' : String(row.minPrice);
        if (pickMax) pickMax.value = row.maxPrice == null ? '' : String(row.maxPrice);
        bpRenderPickList([]);
        if (pickEmptyHint) pickEmptyHint.textContent = '输入关键词后点击搜索。';

        bpOpenPickModalUi();
        // 默认触发一次搜索（更像真实体验）
        setTimeout(bpDoPickSearch, 0);
      };

      function bpOpenPickModalUi() {
        if (pickOverlay) pickOverlay.classList.add('show');
        if (pickModal) pickModal.classList.add('show');
      }

      window.bpClosePickModal = function() {
        if (pickOverlay) pickOverlay.classList.remove('show');
        if (pickModal) pickModal.classList.remove('show');
        bpPickRowId = null;
      };

      function bpDoPickSearch() {
        const kw = normalizeText(pickKeyword?.value);
        const shopQ = normalizeText(pickShop?.value);
        const minV = toNumOrNull(pickMin?.value);
        const maxV = toNumOrNull(pickMax?.value);

        let list = bpProducts.slice();
        if (kw) {
          const tokens = kw.split(' ').filter(Boolean);
          list = list.filter(p => tokens.every(t => (p.name + ' ' + p.spec + ' ' + p.brand).toLowerCase().includes(t.toLowerCase())));
        }
        if (shopQ) list = list.filter(p => String(p.shop || '').toLowerCase().includes(shopQ.toLowerCase()));
        if (minV != null && !Number.isNaN(minV)) list = list.filter(p => p.price >= minV);
        if (maxV != null && !Number.isNaN(maxV)) list = list.filter(p => p.price <= maxV);

        // 排序：价格更接近区间更靠前（简单策略）
        const minN = (minV != null && !Number.isNaN(minV)) ? minV : null;
        const maxN = (maxV != null && !Number.isNaN(maxV)) ? maxV : null;
        list.sort((a, b) => scoreProduct(a, minN, maxN) - scoreProduct(b, minN, maxN));

        bpRenderPickList(list);
      }

      function scoreProduct(p, minN, maxN) {
        const price = Number(p.price || 0);
        if (minN == null && maxN == null) return price;
        if (minN != null && price < minN) return (minN - price) * 10 + 1000;
        if (maxN != null && price > maxN) return (price - maxN) * 10 + 1000;
        // in range
        if (minN != null && maxN != null) {
          const mid = (minN + maxN) / 2;
          return Math.abs(price - mid);
        }
        return 0;
      }

      function bpRenderPickList(list) {
        if (pickList) {
          pickList.innerHTML = (list || []).map(p => `
            <div class="border border-gray-200 rounded-lg p-3 mb-2 hover:border-primary transition-colors">
              <div class="flex items-start justify-between gap-2">
                <div class="min-w-0">
                  <div class="text-sm font-semibold text-gray-900 truncate" title="${escapeHtml(p.name)}">${escapeHtml(p.name)}</div>
                  <div class="text-xs text-gray-500 mt-1">${escapeHtml(p.spec)}｜${escapeHtml(p.brand)}｜${escapeHtml(p.shop)}</div>
                </div>
                <div class="text-right flex-shrink-0">
                  <div class="text-primary font-bold">¥${Number(p.price).toFixed(2)}</div>
                  <div class="text-[11px] text-gray-500">不含税</div>
                </div>
              </div>
              <div class="mt-2 flex justify-end">
                <button type="button" class="h-8 px-3 rounded-md bg-primary text-white text-sm hover:bg-primary/90" onclick="bpSelectProduct('${escapeHtml(p.id)}')">选为对应商品</button>
              </div>
            </div>
          `).join('');
        }
        const count = (list || []).length;
        if (pickCount) pickCount.textContent = `${count} 条`;
        if (pickEmptyHint) pickEmptyHint.textContent = count ? '' : '未找到候选商品，可清空店铺筛选或调整关键词/价格范围。';
      }

      window.bpSelectProduct = function(productId) {
        const row = bpRows.find(r => r.id === bpPickRowId);
        const p = bpProducts.find(x => x.id === productId);
        if (!row || !p) return;

        row.selectedProduct = p;
        row.status = 'matched';
        row.overPrice = false;
        const minN = row.minPrice;
        const maxN = row.maxPrice;
        if (minN != null && p.price < minN) row.overPrice = true;
        if (maxN != null && p.price > maxN) row.overPrice = true;

        bpRenderAll();
        bpClosePickModal();
        bpShowToast('已完成匹配');
      };

      // ----- submit -----
      function bpSubmit() {
        if (!bpRows.length) return;
        const totalQty = bpRows.reduce((sum, r) => sum + (Number(r.qty) || 0), 0);
        bpShowToast('已提交采购单');
        alert('原型演示：已提交采购单（共 ' + bpRows.length + ' 条，数量 ' + totalQty + '）');
      }

      // ----- 导入演示弹窗 -----
      function bpShowImportDemoModal() {
        if (importDemoOverlay) { importDemoOverlay.classList.remove('hidden'); importDemoOverlay.classList.add('show'); }
        if (importDemoModal) { importDemoModal.classList.remove('hidden'); importDemoModal.classList.add('show'); }
      }
      function bpCloseImportDemoModal() {
        if (importDemoOverlay) { importDemoOverlay.classList.add('hidden'); importDemoOverlay.classList.remove('show'); }
        if (importDemoModal) { importDemoModal.classList.add('hidden'); importDemoModal.classList.remove('show'); }
      }
      function bpShowValidateFailModal() {
        if (validateFailList) validateFailList.innerHTML = bpValidateFailReasons.map(r => `<li>${escapeHtml(r)}</li>`).join('');
        if (validateFailOverlay) { validateFailOverlay.classList.remove('hidden'); validateFailOverlay.classList.add('show'); }
        if (validateFailModal) { validateFailModal.classList.remove('hidden'); validateFailModal.classList.add('show'); }
      }
      function bpCloseValidateFailModal() {
        if (validateFailOverlay) { validateFailOverlay.classList.add('hidden'); validateFailOverlay.classList.remove('show'); }
        if (validateFailModal) { validateFailModal.classList.add('hidden'); validateFailModal.classList.remove('show'); }
      }

      // ----- menu / events -----
      function toggleTemplateMenu(show) {
        if (!templateMenu) return;
        templateMenu.classList.toggle('hidden', !show);
      }

      btnTemplate?.addEventListener('click', function(e) {
        e.stopPropagation();
        toggleTemplateMenu(templateMenu.classList.contains('hidden'));
      });
      document.addEventListener('click', function(e) {
        if (!templateWrap) return;
        if (!templateWrap.contains(e.target)) toggleTemplateMenu(false);
      });
      templateMenu?.addEventListener('click', function(e) {
        const t = e.target.closest('[data-bp-template]');
        if (!t) return;
        const type = t.dataset.bpTemplate;
        toggleTemplateMenu(false);
        if (type === 'fields') { bpToggleFields(true); return; }
        if (type === 'csv') { bpDownloadCsvTemplate(); return; }
        if (type === 'xlsx') { bpDownloadExcelTemplate('xlsx'); return; }
        if (type === 'xls') { bpDownloadExcelTemplate('xls'); return; }
      });
      btnCloseFields?.addEventListener('click', () => bpToggleFields(false));

      // 点击「导入采购单」时弹出原型演示（导入成功 / 导入失败）
      btnImport?.addEventListener('click', () => {
        bpHideErrors();
        bpShowImportDemoModal();
      });
      importDemoClose?.addEventListener('click', bpCloseImportDemoModal);
      importDemoOverlay?.addEventListener('click', bpCloseImportDemoModal);
      btnImportSuccess?.addEventListener('click', () => {
        bpRows = getMockSuccessRows();
        bpRenderAll();
        bpCloseImportDemoModal();
        bpShowToast('导入成功：' + bpRows.length + ' 条');
      });
      btnImportFail?.addEventListener('click', () => {
        bpCloseImportDemoModal();
        bpShowValidateFailModal();
      });
      validateFailClose?.addEventListener('click', bpCloseValidateFailModal);
      validateFailOverlay?.addEventListener('click', bpCloseValidateFailModal);

      // 可选：仍支持选择文件导入（格式校验通过后需有表格校验与匹配逻辑，此处仅解析）
      importInput?.addEventListener('change', function() {
        const file = this.files && this.files[0];
        this.value = '';
        bpHandleFile(file);
      });

      // drag & drop（同上，可选）
      if (dropZone) {
        ['dragenter', 'dragover'].forEach(evt => dropZone.addEventListener(evt, (e) => {
          e.preventDefault(); e.stopPropagation();
          dropZone.classList.add('border-primary', 'bg-white');
        }));
        ['dragleave', 'drop'].forEach(evt => dropZone.addEventListener(evt, (e) => {
          e.preventDefault(); e.stopPropagation();
          dropZone.classList.remove('border-primary', 'bg-white');
        }));
        dropZone.addEventListener('drop', (e) => {
          const file = e.dataTransfer?.files?.[0];
          if (file) bpHandleFile(file);
        });
      }

      pickSearchBtn?.addEventListener('click', bpDoPickSearch);
      pickClearShopBtn?.addEventListener('click', function() {
        if (pickShop) pickShop.value = '';
        bpDoPickSearch();
      });
      pickKeyword?.addEventListener('keypress', function(ev) { if (ev.key === 'Enter') bpDoPickSearch(); });
      pickShop?.addEventListener('keypress', function(ev) { if (ev.key === 'Enter') bpDoPickSearch(); });

      btnSubmit?.addEventListener('click', bpSubmit);
    }
  </script>
</body>
</html>
