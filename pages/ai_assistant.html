<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>阳光甄选AI助手</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="../assets/custom.css">
  
  <style>
    :root {
      --color-primary: #2563eb;
      --color-primary-light: #3b82f6;
      --color-primary-bg: #dbeafe;
      --color-primary-border: #93c5fd;
      --color-accent: #6366f1;
      --color-red: #E2231A;
      --gradient-ai: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      /* 整个页面底部背景：浅蓝渐变 + 轻微几何图案，与参考图简洁蓝白风格一致 */
      background: linear-gradient(160deg, #f8fafc 0%, #f1f5f9 25%, #e8ecf4 50%, #e0e7ff 75%, #dbeafe 100%);
      background-image:
        radial-gradient(ellipse 80% 50% at 50% 100%, rgba(59, 130, 246, 0.08) 0%, transparent 55%),
        radial-gradient(circle at 20% 85%, rgba(99, 102, 241, 0.06) 0%, transparent 45%),
        radial-gradient(circle at 80% 90%, rgba(59, 130, 246, 0.05) 0%, transparent 40%),
        repeating-linear-gradient(
          90deg,
          transparent,
          transparent 24px,
          rgba(59, 130, 246, 0.03) 24px,
          rgba(59, 130, 246, 0.03) 25px
        ),
        repeating-linear-gradient(
          0deg,
          transparent,
          transparent 24px,
          rgba(99, 102, 241, 0.02) 24px,
          rgba(99, 102, 241, 0.02) 25px
        ),
        linear-gradient(160deg, #f8fafc 0%, #f1f5f9 25%, #e8ecf4 50%, #e0e7ff 75%, #dbeafe 100%);
      background-size: 100% 100%, 100% 100%, 100% 100%, 100% 100%, 100% 100%, 100% 100%;
    }
    
    /* ==================== 顶部导航 ==================== */
    .ai-header {
      background: #fff;
      color: #1e293b;
      padding: 0 24px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      border-bottom: 1px solid #e2e8f0;
    }
    
    .ai-header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .ai-logo {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: var(--color-primary);
    }
    
    .ai-logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
      color: #fff;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    
    .ai-logo-text {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.5px;
      color: #1e293b;
    }
    
    .ai-header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .ai-user-info {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #475569;
    }
    
    .ai-user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--color-primary-bg);
      color: var(--color-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    
    /* ==================== 主体布局 ==================== */
    .ai-main {
      flex: 1;
      display: flex;
      min-height: 0;
      padding: 16px;
      gap: 16px;
    }
    
    /* 中+右+底条 整体 */
    .ai-middle-right {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      min-width: 0;
    }
    
    .ai-middle-right-top {
      flex: 1;
      display: flex;
      min-height: 0;
      gap: 16px;
    }
    
    /* 右侧列：AI寻源 + AI询价，与中间 3:4 填满整行 */
    .ai-right-column {
      flex: 3 1 0;
      display: flex;
      flex-direction: column;
      gap: 16px;
      min-height: 0;
      min-width: 0;
    }
    
    .ai-util-panel {
      flex: 1;
      min-height: 0;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      border: 1px solid #e2e8f0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .ai-util-panel-header {
      padding: 12px 16px;
      border-bottom: 1px solid #e2e8f0;
      background: #f8fafc;
      font-size: 14px;
      font-weight: 600;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .ai-util-panel-header i {
      color: var(--color-primary);
    }
    
    .ai-util-panel-body {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      font-size: 13px;
      color: #64748b;
    }
    
    /* 左侧：AI对话导购 */
    .ai-chat-panel {
      flex: 0 0 30%;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      border: 1px solid #e2e8f0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .ai-panel-header {
      padding: 0 20px;
      min-height: 56px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      gap: 12px;
      background: #f8fafc;
    }
    
    .ai-panel-header-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }
    
    .ai-panel-header-text h3 {
      font-size: 15px;
      font-weight: 600;
      color: #1e293b;
      margin: 0;
    }
    
    .ai-chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .ai-message {
      display: flex;
      gap: 10px;
      max-width: 90%;
    }
    
    .ai-message.user {
      align-self: flex-end;
      flex-direction: row-reverse;
    }
    
    .ai-message.assistant {
      align-self: flex-start;
    }
    
    .ai-message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    
    .ai-message.user .ai-message-avatar {
      background: var(--color-primary-bg);
      color: var(--color-primary);
    }
    
    .ai-message.assistant .ai-message-avatar {
      background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
      color: #fff;
    }
    
    .ai-message-content {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .ai-message-bubble {
      padding: 12px 16px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.6;
      word-break: break-word;
    }
    
    .ai-message.user .ai-message-bubble {
      background: var(--color-primary-bg);
      color: #1e40af;
      border: 1px solid var(--color-primary-border);
      border-bottom-right-radius: 4px;
    }
    
    .ai-message.assistant .ai-message-bubble {
      background: #f1f5f9;
      color: #334155;
      border: 1px solid #e2e8f0;
      border-bottom-left-radius: 4px;
    }
    
    .ai-message-options-label {
      font-size: 12px;
      color: #64748b;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .ai-message-options-label i {
      font-size: 10px;
      color: #94a3b8;
    }
    
    .ai-message-options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .ai-option-btn {
      padding: 8px 14px;
      border-radius: 16px;
      font-size: 13px;
      border: 1px solid #e2e8f0;
      background: #fff;
      color: #475569;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .ai-option-btn:hover {
      border-color: var(--color-primary);
      color: var(--color-primary);
      background: var(--color-primary-bg);
    }
    
    .ai-chat-input-wrap {
      padding: 16px;
      border-top: 1px solid #e2e8f0;
      background: #fff;
    }
    
    .ai-chat-input {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }
    
    .ai-chat-input input {
      flex: 1;
      min-height: 48px;
      padding: 12px 18px;
      border: 1px solid #e2e8f0;
      border-radius: 24px;
      font-size: 14px;
      outline: none;
      transition: all 0.2s;
      background: #f8fafc;
    }
    
    .ai-chat-input input:focus {
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
      background: #fff;
    }
    
    .ai-chat-input button {
      width: 48px;
      height: 48px;
      min-width: 48px;
      border-radius: 50%;
      background: var(--color-primary);
      color: #fff;
      border: none;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.35);
    }
    
    .ai-chat-input button:hover {
      background: var(--color-primary-light);
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    
    .ai-chat-input-upload {
      flex-shrink: 0;
      width: 48px;
      height: 48px;
      min-width: 48px;
      border-radius: 50%;
      background: #f1f5f9;
      color: #64748b;
      border: 1px solid #e2e8f0;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .ai-chat-input-upload:hover {
      background: var(--color-primary-bg);
      color: var(--color-primary);
      border-color: var(--color-primary-border);
    }
    
    .ai-chat-input-upload input[type="file"] {
      position: absolute;
      width: 0;
      height: 0;
      opacity: 0;
      overflow: hidden;
    }
    
    /* 中间：智能分析页（搜索结果），与右侧 4:3 填满整行 */
    .ai-analysis-panel {
      flex: 4 1 0;
      min-width: 0;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      border: 1px solid #e2e8f0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .ai-analysis-header {
      padding: 0 20px;
      min-height: 56px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      background: #f8fafc;
    }
    
    .ai-page-hint {
      font-size: 11px;
      color: #94a3b8;
      background: #f1f5f9;
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: normal;
      white-space: nowrap;
    }
    
    .ai-util-panel-header .ai-page-hint {
      margin-left: 8px;
    }
    
    .ai-analysis-header .ai-panel-header-icon {
      background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
    }
    
    .ai-analysis-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    
    .ai-analysis-empty {
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #9ca3af;
      text-align: center;
      padding: 40px;
    }
    
    .ai-analysis-empty-icon {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #e0e7ff 0%, #dbeafe 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      color: var(--color-primary-border);
      margin-bottom: 16px;
    }
    
    .ai-analysis-empty h4 {
      font-size: 16px;
      color: #6b7280;
      margin-bottom: 8px;
    }
    
    .ai-analysis-empty p {
      font-size: 13px;
      line-height: 1.6;
    }
    
    /* 推荐商品：标题固定不随滚动 */
    .ai-reco-header {
      position: sticky;
      top: 0;
      z-index: 2;
      background: #fff;
      padding-bottom: 12px;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    
    .ai-reco-header .ai-section-title {
      margin-bottom: 0;
    }
    
    .ai-reco-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .ai-reco-refresh {
      flex-shrink: 0;
      padding: 6px 14px;
      font-size: 13px;
      font-weight: 500;
      color: var(--color-primary);
      background: var(--color-primary-bg);
      border: 1px solid var(--color-primary-border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .ai-reco-refresh:hover {
      background: #bfdbfe;
    }
    
    /* 分析页面四：智能分析按钮（与 Tab/返回等区分） */
    .ai-page4-smart-analyze-btn {
      padding: 8px 20px;
      font-size: 13px;
      font-weight: 600;
      color: #fff;
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-accent) 100%);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.35);
    }
    .ai-page4-smart-analyze-btn:hover {
      background: linear-gradient(135deg, var(--color-primary-light) 0%, #818cf8 100%);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.45);
      transform: translateY(-1px);
    }
    
    /* 分析页面四：已勾选数量提示 */
    .ai-page4-selected-hint {
      font-size: 13px;
      color: #64748b;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .ai-page4-selected-hint strong {
      color: var(--color-primary);
      font-weight: 600;
    }
    
    .ai-reco-compliance {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #64748b;
    }
    
    .ai-reco-compliance i {
      color: #22c55e;
      font-size: 14px;
    }
    
    /* 分析页面 Tab 切换（分析页面一/二用） */
    .ai-analysis-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .ai-analysis-tab {
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 500;
      color: #64748b;
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .ai-analysis-tab:hover {
      color: var(--color-primary);
      border-color: var(--color-primary-border);
      background: var(--color-primary-bg);
    }
    
    .ai-analysis-tab.active {
      color: #fff;
      background: var(--color-primary);
      border-color: var(--color-primary);
    }
    
    /* 商品卡片勾选框 */
    .ai-product-card-checkbox {
      position: absolute;
      top: 8px;
      left: 8px;
      z-index: 2;
    }
    
    .ai-product-card-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--color-primary);
    }
    
    .ai-product-card.selected {
      border-color: var(--color-primary);
      box-shadow: 0 0 0 2px var(--color-primary-bg);
    }
    
    /* 比质比价按钮栏 */
    .ai-compare-action-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: #f8fafc;
      border-radius: 10px;
      margin-bottom: 16px;
      border: 1px solid #e2e8f0;
    }
    
    .ai-compare-action-bar .selected-count {
      font-size: 13px;
      color: #64748b;
    }
    
    .ai-compare-action-bar .selected-count strong {
      color: var(--color-primary);
    }
    
    .ai-compare-action-bar .compare-btn {
      padding: 8px 20px;
      font-size: 13px;
      font-weight: 500;
      color: #fff;
      background: var(--color-primary);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .ai-compare-action-bar .compare-btn:hover {
      background: var(--color-primary-light);
    }
    
    .ai-compare-action-bar .compare-btn:disabled {
      background: #cbd5e1;
      cursor: not-allowed;
    }
    
    /* 分析内容 - 商品卡片 3x3 */
    .ai-product-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    
    .ai-product-card {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 12px;
      transition: all 0.2s;
      cursor: pointer;
      position: relative;
      display: flex;
      flex-direction: column;
    }
    
    .ai-product-card:hover {
      border-color: var(--color-primary-border);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.12);
    }
    
    .ai-product-card-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 12px;
      border-radius: 12px;
      background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%);
      color: var(--color-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
    }
    
    .ai-product-card-img {
      width: 100%;
      aspect-ratio: 4 / 3;
      object-fit: cover;
      border-radius: 8px;
      background: #f3f4f6;
      margin-bottom: 8px;
    }
    
    .ai-product-card-name {
      font-size: 12px;
      color: #1f2937;
      line-height: 1.4;
      margin-bottom: 4px;
      display: -webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .ai-product-card-supplier-name {
      font-size: 12px;
      color: #64748b;
      margin-bottom: 6px;
    }
    
    .ai-product-card-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    
    .ai-product-card-price {
      font-size: 15px;
      color: var(--color-primary);
      font-weight: 600;
    }
    
    .ai-product-card-sales {
      font-size: 12px;
      color: #64748b;
    }
    
    .ai-product-card-suppliers {
      font-size: 12px;
      color: #64748b;
    }
    
    .ai-product-card-footer {
      margin-top: auto;
    }
    
    .ai-product-card-detail-btn {
      width: 100%;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      color: var(--color-primary);
      background: var(--color-primary-bg);
      border: 1px solid var(--color-primary-border);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .ai-product-card-detail-btn:hover {
      background: #bfdbfe;
    }
    
    /* 悬停时整卡显示四按钮 */
    .ai-product-card-hover {
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      background: rgba(255,255,255,0.98);
      border-radius: 12px;
      padding: 12px;
      display: none;
      flex-direction: column;
      gap: 8px;
      z-index: 1;
    }
    
    .ai-product-card:hover .ai-product-card-hover {
      display: flex;
    }
    
    /* 悬停层内四个按钮样式统一：同高度、同圆角、同内边距 */
    .ai-product-card-hover .ai-btn-sm,
    .ai-product-card-hover .ai-product-card-detail-btn {
      margin: 0;
      width: 100%;
      min-height: 36px;
      height: 36px;
      padding: 0 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid var(--color-primary-border);
      background: var(--color-primary-bg);
      color: var(--color-primary);
    }
    
    .ai-product-card-hover .ai-btn-sm:hover,
    .ai-product-card-hover .ai-product-card-detail-btn:hover {
      background: var(--color-primary);
      color: #fff;
      border-color: var(--color-primary);
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.35);
    }
    
    .ai-product-card-hover .ai-product-card-detail-btn {
      margin-top: auto;
    }
    
    .ai-product-card-score {
      font-size: 12px;
      color: #6b7280;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .ai-product-card-score i {
      color: #fbbf24;
    }
    
    .ai-product-card-actions {
      display: flex;
      gap: 8px;
    }
    
    .ai-btn-sm {
      flex: 1;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }
    
    .ai-btn-sm.primary {
      background: var(--color-primary);
      color: #fff;
    }
    
    .ai-btn-sm.primary:hover {
      background: var(--color-primary-light);
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.35);
    }
    
    .ai-btn-sm.secondary {
      background: #f3f4f6;
      color: #374151;
    }
    
    .ai-btn-sm.secondary:hover {
      background: #e5e7eb;
    }
    
    /* 比价表格 */
    .ai-compare-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-bottom: 16px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #e5e7eb;
    }
    
    .ai-compare-table th,
    .ai-compare-table td {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .ai-compare-table th {
      background: linear-gradient(135deg, #f8f9ff 0%, #f3f4f6 100%);
      font-weight: 600;
      color: #374151;
    }
    
    .ai-compare-table td {
      color: #4b5563;
    }
    
    .ai-compare-table tr:last-child td {
      border-bottom: none;
    }
    
    .ai-compare-table .highlight {
      color: var(--color-primary);
      font-weight: 600;
    }
    
    /* 评价列表 */
    .ai-review-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .ai-review-tab {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .ai-review-tab.positive {
      background: #dcfce7;
      color: #166534;
    }
    
    .ai-review-tab.positive.active {
      background: #10b981;
      color: #fff;
    }
    
    .ai-review-tab.negative {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .ai-review-tab.negative.active {
      background: #ef4444;
      color: #fff;
    }
    
    .ai-review-item {
      padding: 12px;
      background: #f9fafb;
      border-radius: 10px;
      margin-bottom: 10px;
    }
    
    .ai-review-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .ai-review-user {
      font-size: 13px;
      color: #374151;
      font-weight: 500;
    }
    
    .ai-review-tag {
      padding: 2px 10px;
      border-radius: 10px;
      font-size: 11px;
    }
    
    .ai-review-tag.positive {
      background: #dcfce7;
      color: #166534;
    }
    
    .ai-review-tag.negative {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .ai-review-content {
      font-size: 13px;
      color: #6b7280;
      line-height: 1.6;
    }
    
    /* 底条内商品项（复用原快捷项样式） */
    .ai-quick-item {
      display: flex;
      gap: 12px;
      padding: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      margin-bottom: 12px;
      transition: all 0.2s;
    }
    
    .ai-quick-item:hover {
      border-color: var(--color-primary-border);
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.12);
    }
    
    .ai-quick-item-img {
      width: 64px;
      height: 64px;
      border-radius: 8px;
      object-fit: cover;
      background: #f3f4f6;
      flex-shrink: 0;
    }
    
    .ai-quick-item-info {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    
    .ai-quick-item-name {
      font-size: 13px;
      color: #1f2937;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .ai-quick-item-bottom {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .ai-quick-item-price {
      font-size: 14px;
      color: var(--color-primary);
      font-weight: 600;
    }
    
    .ai-quick-item-send {
      padding: 6px 14px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 500;
      background: var(--color-primary);
      color: #fff;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .ai-quick-item-send:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.35);
    }
    
    /* 加载动画 */
    .ai-loading {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #9ca3af;
    }
    
    .ai-loading-dots {
      display: flex;
      gap: 4px;
    }
    
    .ai-loading-dots span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--color-primary);
      animation: ai-bounce 1.4s infinite ease-in-out both;
    }
    
    .ai-loading-dots span:nth-child(1) { animation-delay: -0.32s; }
    .ai-loading-dots span:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes ai-bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
    
    /* Toast 提示 */
    .ai-toast {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%) translateY(-20px);
      padding: 12px 24px;
      background: rgba(0,0,0,0.8);
      color: #fff;
      border-radius: 8px;
      font-size: 14px;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .ai-toast.show {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0);
    }
    
    /* 分析内容标题 */
    .ai-section-title {
      font-size: 14px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .ai-section-title i {
      color: var(--color-primary);
    }
    
    /* 预算标签 */
    .ai-budget-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: #dcfce7;
      color: #166534;
      font-size: 11px;
      border-radius: 12px;
      margin-bottom: 8px;
    }
    
    /* 评价摘要 */
    .ai-review-summary {
      padding: 16px;
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      border-radius: 12px;
      margin-bottom: 16px;
    }
    
    .ai-review-summary-title {
      font-size: 14px;
      font-weight: 600;
      color: #166534;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .ai-review-summary-content {
      font-size: 13px;
      color: #15803d;
      line-height: 1.6;
    }
    
    /* 订单确认卡片 */
    .ai-order-card {
      border: 2px solid #10b981;
      border-radius: 12px;
      padding: 16px;
      background: linear-gradient(135deg, #f0fdf4 0%, #fff 100%);
    }
    
    .ai-order-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding-bottom: 12px;
      border-bottom: 1px dashed #d1fae5;
      margin-bottom: 12px;
    }
    
    .ai-order-card-img {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
      background: #f3f4f6;
    }
    
    .ai-order-card-info {
      flex: 1;
    }
    
    .ai-order-card-name {
      font-size: 14px;
      color: #1f2937;
      margin-bottom: 8px;
      line-height: 1.4;
    }
    
    .ai-order-card-meta {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      color: #6b7280;
    }
    
    .ai-order-card-total {
      text-align: right;
      margin-bottom: 16px;
    }
    
    .ai-order-card-total span {
      font-size: 13px;
      color: #6b7280;
    }
    
    .ai-order-card-total strong {
      font-size: 20px;
      color: #E2231A;
      margin-left: 8px;
    }
    
    .ai-order-btn {
      width: 100%;
      padding: 14px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: #fff;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .ai-order-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(16, 185, 129, 0.4);
    }
    
    /* 底条：购物车/我的收藏（横跨中+右，左 Tab + 中内容 + 右收起/展开） */
    .ai-bottom-bar {
      flex-shrink: 0;
      margin-top: 16px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(226, 232, 240, 0.9);
      border-radius: 12px;
      display: flex;
      align-items: stretch;
      min-height: 116px;
      transition: min-height 0.25s ease;
      overflow: hidden;
    }
    
    .ai-bottom-bar.collapsed {
      min-height: 44px;
    }
    
    .ai-bottom-bar.collapsed .ai-bottom-bar-content {
      display: none;
    }
    
    /* 收起时：左侧两按钮横向排列 */
    .ai-bottom-bar.collapsed .ai-bottom-bar-tabs {
      flex-direction: row;
      align-items: center;
      padding: 0 16px;
    }
    
    .ai-bottom-bar-tabs {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 0 16px;
      border-right: 1px solid #e2e8f0;
      background: #f8fafc;
    }
    
    /* 展开时：左侧两按钮上下排列 */
    .ai-bottom-bar:not(.collapsed) .ai-bottom-bar-tabs {
      flex-direction: column;
      align-items: stretch;
      padding: 8px 16px;
      gap: 4px;
    }
    
    .ai-bottom-bar-tab {
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 500;
      color: #64748b;
      background: none;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .ai-bottom-bar-tab.active {
      color: var(--color-primary);
      background: var(--color-primary-bg);
    }
    
    .ai-bottom-bar-tab:hover:not(.active) {
      color: #475569;
      background: #f1f5f9;
    }
    
    .ai-bottom-bar-content {
      flex: 1;
      min-width: 0;
      overflow-x: auto;
      overflow-y: hidden;
      padding: 10px 12px;
      display: flex;
      align-items: stretch;
      gap: 12px;
    }
    
    .ai-bottom-bar-content #favoritesTab,
    .ai-bottom-bar-content #cartTab {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
      overflow-x: auto;
    }
    
    /* 收起/展开按钮始终在模块右侧：用 margin-left: auto 顶到右侧 */
    .ai-bottom-bar-toggle {
      flex-shrink: 0;
      margin-left: auto;
      padding: 0 16px;
      border-left: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
    }
    
    .ai-bottom-bar-toggle-btn {
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 500;
      color: #64748b;
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .ai-bottom-bar-toggle-btn:hover {
      color: var(--color-primary);
      border-color: var(--color-primary-border);
      background: var(--color-primary-bg);
    }
    
    /* 底条内商品项：展开时较大卡片，横向排列 */
    .ai-bottom-bar .ai-quick-item {
      flex-shrink: 0;
      width: 240px;
      margin-bottom: 0;
      padding: 12px 14px;
      align-items: center;
    }
    
    .ai-bottom-bar .ai-quick-item-img {
      width: 56px;
      height: 56px;
      border-radius: 8px;
    }
    
    .ai-bottom-bar .ai-quick-item-info {
      gap: 6px;
    }
    
    .ai-bottom-bar .ai-quick-item-name {
      -webkit-line-clamp: 2;
      font-size: 13px;
      line-height: 1.4;
    }
    
    .ai-bottom-bar .ai-quick-item-price {
      font-size: 14px;
    }
    
    .ai-bottom-bar .ai-quick-item-send {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    /* 底部商品勾选框 */
    .ai-quick-item-checkbox {
      flex-shrink: 0;
      width: 18px;
      height: 18px;
      margin-right: 8px;
      cursor: pointer;
      accent-color: var(--color-primary);
    }
    
    /* 底部下单按钮区 */
    .ai-bottom-bar-actions {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 16px;
      border-left: 1px solid #e2e8f0;
    }
    
    .ai-bottom-bar-actions .selected-info {
      font-size: 12px;
      color: #64748b;
      white-space: nowrap;
    }
    
    .ai-bottom-bar-actions .selected-info strong {
      color: var(--color-primary);
    }
    
    .ai-bottom-bar-actions .order-btn {
      padding: 8px 20px;
      font-size: 13px;
      font-weight: 500;
      color: #fff;
      background: var(--color-primary);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }
    
    .ai-bottom-bar-actions .order-btn:hover {
      background: var(--color-primary-light);
    }
    
    .ai-bottom-bar-actions .order-btn:disabled {
      background: #cbd5e1;
      cursor: not-allowed;
    }
    
    /* AI寻源：供应商卡片列表（每行3个、可滚动） */
    .ai-supplier-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      overflow-y: auto;
      padding: 2px;
    }
    
    .ai-supplier-card {
      position: relative;
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 10px;
      text-align: center;
      transition: all 0.2s;
      cursor: pointer;
      overflow: hidden;
    }
    
    .ai-supplier-card:hover {
      border-color: var(--color-primary-border);
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.12);
    }
    
    .ai-supplier-card-img {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      border-radius: 8px;
      background: #f3f4f6;
      margin-bottom: 8px;
    }
    
    .ai-supplier-card-name {
      font-size: 12px;
      color: #1e293b;
      line-height: 1.35;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .ai-supplier-card-hover-btn {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      height: 100%;
      background: rgba(255,255,255,0.96);
      display: none;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
    }
    
    .ai-supplier-card:hover .ai-supplier-card-hover-btn {
      display: flex;
    }
    
    .ai-supplier-card-hover-btn button {
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 500;
      color: #fff;
      background: var(--color-primary);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }
    
    .ai-supplier-card-hover-btn button:hover {
      background: var(--color-primary-light);
    }
    
    /* AI寻源：供应商详情 */
    .ai-supplier-detail {
      padding: 4px;
    }
    
    .ai-supplier-detail-img {
      width: 100%;
      max-height: 120px;
      object-fit: cover;
      border-radius: 8px;
      background: #f3f4f6;
      margin-bottom: 12px;
    }
    
    .ai-supplier-detail-name {
      font-size: 14px;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 8px;
    }
    
    .ai-supplier-detail-addr {
      font-size: 12px;
      color: #64748b;
      line-height: 1.5;
    }
    
    .ai-supplier-detail-btn {
      margin-top: 12px;
      width: 100%;
      padding: 8px 12px;
      font-size: 12px;
      font-weight: 500;
      color: var(--color-primary);
      background: var(--color-primary-bg);
      border: 1px solid var(--color-primary-border);
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .ai-supplier-detail-btn:hover {
      background: #bfdbfe;
    }
    
    /* AI询价：价格折线图区域 */
    .ai-inquiry-chart-wrap {
      position: relative;
      margin-bottom: 12px;
    }
    
    .ai-inquiry-chart-ref {
      position: absolute;
      top: 8px;
      right: 8px;
      font-size: 12px;
      color: #64748b;
      background: #f1f5f9;
      padding: 4px 10px;
      border-radius: 6px;
      z-index: 1;
    }
    
    .ai-inquiry-chart-ref strong {
      color: var(--color-primary);
      margin-left: 4px;
    }
    
    .ai-inquiry-chart {
      width: 100%;
      height: 160px;
      background: linear-gradient(180deg, rgba(59, 130, 246, 0.06) 0%, transparent 100%);
      border-radius: 8px;
      border: 1px solid #e2e8f0;
      padding: 12px 12px 24px;
      box-sizing: border-box;
    }
    
    .ai-inquiry-chart svg {
      width: 100%;
      height: 100%;
      display: block;
    }
    
    .ai-inquiry-placeholder {
      font-size: 13px;
      color: #64748b;
      text-align: center;
      padding: 20px 12px;
    }
  </style>
</head>
<body>
  <!-- ==================== 顶部导航 ==================== -->
  <header class="ai-header">
    <div class="ai-header-left">
      <a href="home.html" target="_blank" class="ai-logo">
        <div class="ai-logo-icon"><i class="fas fa-robot"></i></div>
        <span class="ai-logo-text">阳光甄选AI助手</span>
      </a>
    </div>
    <div class="ai-header-right">
      <div class="ai-user-info">
        <div class="ai-user-avatar"><i class="fas fa-user"></i></div>
        <span id="userNameDisplay">张三（采购专员）</span>
      </div>
    </div>
  </header>
  
  <!-- ==================== 主体三栏布局 ==================== -->
  <main class="ai-main">
    <!-- 左侧：对话页面 -->
    <section class="ai-chat-panel">
      <div class="ai-panel-header">
        <div class="ai-panel-header-icon"><i class="fas fa-infinity"></i></div>
        <div class="ai-panel-header-text">
          <h3>AI对话导购</h3>
        </div>
      </div>
      <div class="ai-chat-messages" id="chatMessages">
        <!-- 欢迎消息 -->
        <div class="ai-message assistant">
          <div class="ai-message-avatar"><i class="fas fa-robot"></i></div>
          <div class="ai-message-content">
            <div class="ai-message-bubble">
              您好！我是阳光优采智能助手。<br><br>
              我可以帮您：<br>
              <strong>• 找商品</strong>：推荐商品、预算筛选、查看评价<br>
              <strong>• 做决策</strong>：比质比价、收藏商品、快速下单<br>
              <strong>• 解疑问</strong>：平台规则咨询<br><br>
              请问有什么可以帮您的？
            </div>
            <div class="ai-message-options-label">
              <span>相关提问建议</span>
              <i class="fas fa-chevron-down"></i>
            </div>
            <div class="ai-message-options">
              <button class="ai-option-btn" onclick="sendQuickMsg('推荐好用的办公用品')" title="模糊问题：一级分类">模糊问题</button>
              <button class="ai-option-btn" onclick="sendQuickMsg('推荐好用的复印纸')" title="适中问题：二级分类">适中问题</button>
              <button class="ai-option-btn" onclick="sendQuickMsg('A4 70g 复印纸')" title="明确问题：三级分类+规格">明确问题</button>
            </div>
          </div>
        </div>
      </div>
      <div class="ai-chat-input-wrap">
        <div class="ai-chat-input">
          <label class="ai-chat-input-upload" title="上传采购单">
            <i class="fas fa-file-upload"></i>
            <input type="file" id="procurementFile" accept=".xlsx,.xls,.csv,.pdf,.txt" onchange="onProcurementFileChange(this)">
          </label>
          <input type="text" id="chatInput" placeholder="请输入问题..." onkeypress="if(event.key==='Enter')sendMessage()">
          <button type="button" onclick="sendMessage()" title="发送"><i class="fas fa-paper-plane"></i></button>
        </div>
      </div>
    </section>
    
    <!-- 中+右+底条 -->
    <div class="ai-middle-right">
      <div class="ai-middle-right-top">
    <!-- 中间：综合分析页 -->
    <section class="ai-analysis-panel">
      <div class="ai-analysis-header">
        <div style="display: flex; align-items: center; gap: 12px;">
          <div class="ai-panel-header-icon"><i class="fas fa-search"></i></div>
          <div class="ai-panel-header-text">
            <h3>综合分析</h3>
          </div>
        </div>
        <span class="ai-page-hint" id="analysisPageHint">分析页面一</span>
      </div>
      <div class="ai-analysis-content" id="analysisContent">
        <!-- 空状态 -->
        <div class="ai-analysis-empty" id="analysisEmpty">
          <div class="ai-analysis-empty-icon"><i class="fas fa-lightbulb"></i></div>
          <h4>等待您的提问</h4>
          <p>向 AI 提问后，这里将展示<br>相关商品推荐和数据分析</p>
        </div>
      </div>
    </section>
    
    <!-- 右侧：AI寻源 + AI询价 -->
    <div class="ai-right-column">
      <section class="ai-util-panel" id="aiSourcingPanel">
        <div class="ai-util-panel-header"><i class="fas fa-search-plus"></i> AI寻源 <span class="ai-page-hint" id="sourcingPageHint">寻源页面一</span></div>
        <div class="ai-util-panel-body" id="aiSourcingBody">根据对话内容智能推荐供应商与货源，结果将在此展示。</div>
      </section>
      <section class="ai-util-panel" id="aiInquiryPanel">
        <div class="ai-util-panel-header"><i class="fas fa-file-invoice-dollar"></i> AI询价</div>
        <div class="ai-util-panel-body" id="aiInquiryBody">询价记录与报价结果将在此展示。</div>
      </section>
    </div>
      </div>
      
      <!-- 底条：购物车/我的收藏（Tab 左 + 内容中 + 收起/展开 右） -->
      <div class="ai-bottom-bar" id="aiBottomBar">
        <div class="ai-bottom-bar-tabs">
          <button type="button" class="ai-bottom-bar-tab active" data-tab="cart" onclick="switchQuickTab('cart')"><i class="fas fa-shopping-cart"></i> 购物车</button>
          <button type="button" class="ai-bottom-bar-tab" data-tab="favorites" onclick="switchQuickTab('favorites')"><i class="fas fa-heart"></i> 我的收藏</button>
        </div>
        <div class="ai-bottom-bar-content" id="quickContent">
          <div id="cartTab" style="display: flex;">
            <div class="ai-quick-item" data-product-id="3" data-quantity="5">
              <input type="checkbox" class="ai-quick-item-checkbox" data-tab="cart" data-id="cart1" onchange="updateBottomBarSelection()">
              <img src="https://images.unsplash.com/photo-1586281380349-632531db7ed4?w=200&h=200&fit=crop" class="ai-quick-item-img" alt="">
              <div class="ai-quick-item-info">
                <div class="ai-quick-item-name">得力 A4复印纸 70g 办公用纸 500张/包</div>
                <div class="ai-quick-item-bottom">
                  <span class="ai-quick-item-price">¥23.80 × 5</span>
                  <button class="ai-quick-item-send" onclick="sendProductQuery('得力 A4复印纸')">发送</button>
                </div>
              </div>
            </div>
            <div class="ai-quick-item" data-product-id="5" data-quantity="10">
              <input type="checkbox" class="ai-quick-item-checkbox" data-tab="cart" data-id="cart2" onchange="updateBottomBarSelection()">
              <img src="https://images.unsplash.com/photo-1582555172866-f73bb12a2ab3?w=200&h=200&fit=crop" class="ai-quick-item-img" alt="">
              <div class="ai-quick-item-info">
                <div class="ai-quick-item-name">唐丰 安全帽 ABS-V型 蓝色</div>
                <div class="ai-quick-item-bottom">
                  <span class="ai-quick-item-price">¥17.70 × 10</span>
                  <button class="ai-quick-item-send" onclick="sendProductQuery('唐丰 安全帽')">发送</button>
                </div>
              </div>
            </div>
          </div>
          <div id="favoritesTab" style="display: none;">
            <div class="ai-quick-item" data-product-id="1" data-quantity="1">
              <input type="checkbox" class="ai-quick-item-checkbox" data-tab="favorites" data-id="fav1" onchange="updateBottomBarSelection()">
              <img src="https://images.unsplash.com/photo-1586281380349-632531db7ed4?w=200&h=200&fit=crop" class="ai-quick-item-img" alt="">
              <div class="ai-quick-item-info">
                <div class="ai-quick-item-name">齐心 C3674-5 A4复印纸 70g 500张/包</div>
                <div class="ai-quick-item-bottom">
                  <span class="ai-quick-item-price">¥25.92</span>
                  <button class="ai-quick-item-send" onclick="sendProductQuery('齐心 C3674-5 A4复印纸')">发送</button>
                </div>
              </div>
            </div>
            <div class="ai-quick-item" data-product-id="2" data-quantity="1">
              <input type="checkbox" class="ai-quick-item-checkbox" data-tab="favorites" data-id="fav2" onchange="updateBottomBarSelection()">
              <img src="https://images.unsplash.com/photo-1586281380349-632531db7ed4?w=200&h=200&fit=crop" class="ai-quick-item-img" alt="">
              <div class="ai-quick-item-info">
                <div class="ai-quick-item-name">天章复印纸 A4 80g 白色 500张/包</div>
                <div class="ai-quick-item-bottom">
                  <span class="ai-quick-item-price">¥28.50</span>
                  <button class="ai-quick-item-send" onclick="sendProductQuery('天章复印纸 A4 80g')">发送</button>
                </div>
              </div>
            </div>
            <div class="ai-quick-item" data-product-id="4" data-quantity="1">
              <input type="checkbox" class="ai-quick-item-checkbox" data-tab="favorites" data-id="fav3" onchange="updateBottomBarSelection()">
              <img src="https://images.unsplash.com/photo-1553062407-98eeb64c6a62?w=200&h=200&fit=crop" class="ai-quick-item-img" alt="">
              <div class="ai-quick-item-info">
                <div class="ai-quick-item-name">星宇 劳保手套 防穿刺 防滑耐磨</div>
                <div class="ai-quick-item-bottom">
                  <span class="ai-quick-item-price">¥59.10</span>
                  <button class="ai-quick-item-send" onclick="sendProductQuery('星宇 劳保手套')">发送</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="ai-bottom-bar-actions" id="bottomBarActions">
          <span class="selected-info">已选 <strong id="bottomSelectedCount">0</strong> 件</span>
          <button class="order-btn" id="bottomOrderBtn" disabled onclick="bottomBarOrder()"><i class="fas fa-shopping-bag"></i> 下单</button>
        </div>
        <div class="ai-bottom-bar-toggle">
          <button type="button" class="ai-bottom-bar-toggle-btn" id="aiBottomBarToggle" onclick="toggleBottomBar()"><i class="fas fa-chevron-down"></i> 收起</button>
        </div>
      </div>
    </div>
  </main>
  
  <!-- Toast 提示 -->
  <div class="ai-toast" id="toast"></div>
  
  <script>
    // ==================== Mock 数据 ====================
    // ==================== 分类数据 ====================
    const mockCategories = {
      '办公用品': {
        children: {
          '复印纸': ['A4 70g', 'A4 80g', 'A5 70g', 'A3 80g'],
          '文具': ['中性笔', '圆珠笔', '记号笔', '铅笔'],
          '办公耗材': ['墨盒', '硒鼓', '色带']
        }
      },
      '劳保用品': {
        children: {
          '手部防护': ['防穿刺手套', '绝缘手套', '耐高温手套'],
          '头部防护': ['ABS安全帽', 'PE安全帽', '防寒帽'],
          '呼吸防护': ['KN95口罩', 'N95口罩', '防尘面罩']
        }
      },
      '工具设备': {
        children: {
          '电动工具': ['角磨机', '电钻', '电锯'],
          '手动工具': ['扳手', '螺丝刀', '钳子']
        }
      }
    };
    
    const mockProducts = [
      { id: 1, name: '齐心 C3674-5 A4复印纸 70g 500张/包', brand: '齐心', price: 25.92, unit: '包', sales: 8520, score: 4.8, img: 'https://images.unsplash.com/photo-1586281380349-632531db7ed4?w=400&h=300&fit=crop', cat1: '办公用品', cat2: '复印纸', cat3: 'A4 70g', supplierId: 1 },
      { id: 2, name: '天章复印纸 A4 80g 白色 500张/包', brand: '天章', price: 28.50, unit: '包', sales: 6230, score: 4.7, img: 'https://images.unsplash.com/photo-1586281380349-632531db7ed4?w=400&h=300&fit=crop', cat1: '办公用品', cat2: '复印纸', cat3: 'A4 80g', supplierId: 4 },
      { id: 3, name: '得力 A4复印纸 70g 办公用纸 500张/包', brand: '得力', price: 23.80, unit: '包', sales: 12350, score: 4.9, img: 'https://images.unsplash.com/photo-1586281380349-632531db7ed4?w=400&h=300&fit=crop', cat1: '办公用品', cat2: '复印纸', cat3: 'A4 70g', supplierId: 5 },
      { id: 4, name: '星宇 劳保手套 防穿刺 防滑耐磨', brand: '星宇', price: 59.10, unit: '双', sales: 3280, score: 4.6, img: 'https://images.unsplash.com/photo-1553062407-98eeb64c6a62?w=400&h=300&fit=crop', cat1: '劳保用品', cat2: '手部防护', cat3: '防穿刺手套', supplierId: 2 },
      { id: 5, name: '唐丰 安全帽 ABS-V型 蓝色', brand: '唐丰', price: 17.70, unit: '顶', sales: 5620, score: 4.5, img: 'https://images.unsplash.com/photo-1582555172866-f73bb12a2ab3?w=400&h=300&fit=crop', cat1: '劳保用品', cat2: '头部防护', cat3: 'ABS安全帽', supplierId: 3 },
      { id: 6, name: '晨光 A4复印纸 70g 5包/提', brand: '晨光', price: 26.80, unit: '提', sales: 4520, score: 4.7, img: 'https://images.unsplash.com/photo-1586281380349-632531db7ed4?w=400&h=300&fit=crop', cat1: '办公用品', cat2: '复印纸', cat3: 'A4 70g', supplierId: 6 },
      { id: 7, name: '真彩 中性笔 0.5mm 黑色 12支/盒', brand: '真彩', price: 12.50, unit: '盒', sales: 8900, score: 4.6, img: 'https://images.unsplash.com/photo-1585338107529-13afc5f02586?w=400&h=300&fit=crop', cat1: '办公用品', cat2: '文具', cat3: '中性笔', supplierId: 6 },
      { id: 8, name: '博世 角磨机 手持 多功能', brand: '博世', price: 268.00, unit: '台', sales: 2100, score: 4.8, img: 'https://images.unsplash.com/photo-1504148455328-c376907d081c?w=400&h=300&fit=crop', cat1: '工具设备', cat2: '电动工具', cat3: '角磨机', supplierId: 1 },
      { id: 9, name: '3M 防尘口罩 KN95 10只/包', brand: '3M', price: 35.00, unit: '包', sales: 5600, score: 4.5, img: 'https://images.unsplash.com/photo-1584036561566-baf8f5f1b144?w=400&h=300&fit=crop', cat1: '劳保用品', cat2: '呼吸防护', cat3: 'KN95口罩', supplierId: 2 },
      { id: 10, name: '霍尼韦尔 绝缘手套 10KV', brand: '霍尼韦尔', price: 89.00, unit: '双', sales: 2100, score: 4.7, img: 'https://images.unsplash.com/photo-1553062407-98eeb64c6a62?w=400&h=300&fit=crop', cat1: '劳保用品', cat2: '手部防护', cat3: '绝缘手套', supplierId: 3 },
      { id: 11, name: '3M 防尘面罩 半面罩', brand: '3M', price: 68.00, unit: '个', sales: 3200, score: 4.6, img: 'https://images.unsplash.com/photo-1584036561566-baf8f5f1b144?w=400&h=300&fit=crop', cat1: '劳保用品', cat2: '呼吸防护', cat3: '防尘面罩', supplierId: 2 },
      { id: 12, name: '得力 圆珠笔 0.7mm 蓝色 50支/盒', brand: '得力', price: 18.00, unit: '盒', sales: 7500, score: 4.5, img: 'https://images.unsplash.com/photo-1585338107529-13afc5f02586?w=400&h=300&fit=crop', cat1: '办公用品', cat2: '文具', cat3: '圆珠笔', supplierId: 5 },
    ];
    
    const mockReviews = {
      positive: [
        { user: '采购员小李', content: '纸张质量很好，打印清晰，物流很快！' },
        { user: '办公室王经理', content: '一直用这个牌子，性价比很高，推荐！' },
        { user: '张先生', content: '包装完好，纸张厚度合适，非常满意。' },
      ],
      negative: [
        { user: '匿名用户', content: '物流有点慢，等了5天才到。' },
        { user: '采购部小陈', content: '有一包纸边角有点破损，希望加强包装。' },
      ]
    };
    
    const mockSuppliers = [
      { id: 1, name: '上海华沫实业有限公司', address: '浦东新区南汇新城镇环湖西二路8号', img: 'https://images.unsplash.com/photo-1560179707-f14e90ef3623?w=120&h=120&fit=crop' },
      { id: 2, name: '北京优采供应链管理有限公司', address: '朝阳区建国路88号', img: 'https://images.unsplash.com/photo-1600880292203-757bb62b4baf?w=120&h=120&fit=crop' },
      { id: 3, name: '广州齐心办公用品有限公司', address: '天河区体育西路123号', img: 'https://images.unsplash.com/photo-1556761175-b413da4baf72?w=120&h=120&fit=crop' },
      { id: 4, name: '深圳天章纸业有限公司', address: '南山区科技园南路45号', img: 'https://images.unsplash.com/photo-1557804506-669a67965ba0?w=120&h=120&fit=crop' },
      { id: 5, name: '杭州得力文具供应链', address: '余杭区五常大道66号', img: 'https://images.unsplash.com/photo-1542744173-8e7e53415bb0?w=120&h=120&fit=crop' },
      { id: 6, name: '南京晨光文化用品有限公司', address: '江宁区双龙大道100号', img: 'https://images.unsplash.com/photo-1517245386807-bb43f82c33c4?w=120&h=120&fit=crop' },
    ];
    
    function getMockPriceHistory() {
      var base = 24 + Math.random() * 6;
      var arr = [];
      for (var i = 6; i >= 0; i--) {
        var d = new Date();
        d.setDate(d.getDate() - i);
        arr.push({ date: (d.getMonth()+1) + '/' + d.getDate(), value: Math.round((base + (Math.random() - 0.5) * 2) * 100) / 100 });
      }
      return arr;
    }
    
    // ==================== 核心函数 ====================
    
    // 发送快捷消息
    function sendQuickMsg(msg) {
      document.getElementById('chatInput').value = msg;
      sendMessage();
    }
    
    // 发送商品查询（从右侧快捷操作发送）
    function sendProductQuery(productName) {
      addMessage(productName, 'user');
      showLoading();
      
      setTimeout(() => {
        hideLoading();
        // AI 回复
        addMessageWithOptions(
          `好的，我来帮您了解「${productName}」这款商品。请问您想：`,
          [
            { label: '查看商品详情', action: `showProductDetail('${(productName || '').replace(/'/g, "\\'")}', true)` },
            { label: '查看评价', action: `showReviews('${productName}')` },
            { label: '与其他商品比价', action: `showCompare('${productName}')` },
            { label: '直接下单', action: `showOrder('${productName}')` },
          ]
        );
        // 在分析区显示商品信息（从对话直接进入，不显示返回按钮）
        showProductAnalysis(productName, true);
      }, 600);
    }
    
    // 发送消息
    function sendMessage() {
      const input = document.getElementById('chatInput');
      const msg = (input.value || '').trim();
      if (!msg) return;
      
      addMessage(msg, 'user');
      input.value = '';
      
      showLoading();
      
      setTimeout(() => {
        hideLoading();
        processMessage(msg);
      }, 800 + Math.random() * 400);
    }
    
    // 上传采购单
    function onProcurementFileChange(inputEl) {
      var file = inputEl && inputEl.files && inputEl.files[0];
      if (!file) return;
      var fileName = file.name;
      addMessage('已上传采购单：' + fileName, 'user');
      showToast('已上传采购单：' + fileName);
      showLoading();
      setTimeout(function() {
        hideLoading();
        addMessageWithOptions(
          '已收到您的采购单「' + fileName + '」，正在为您解析。您可以：',
          [
            { label: '按采购单推荐商品', action: "sendQuickMsg('根据采购单推荐商品')" },
            { label: '比价询价', action: "sendQuickMsg('对采购单商品比价询价')" },
            { label: '查看解析结果', action: "sendQuickMsg('采购单解析结果')" },
          ]
        );
      }, 600);
      inputEl.value = '';
    }
    
    // 添加消息
    function addMessage(content, type) {
      const container = document.getElementById('chatMessages');
      const msgDiv = document.createElement('div');
      msgDiv.className = `ai-message ${type}`;
      
      const avatarIcon = type === 'user' ? 'fa-user' : 'fa-robot';
      
      msgDiv.innerHTML = `
        <div class="ai-message-avatar"><i class="fas ${avatarIcon}"></i></div>
        <div class="ai-message-content">
          <div class="ai-message-bubble">${content}</div>
        </div>
      `;
      
      container.appendChild(msgDiv);
      container.scrollTop = container.scrollHeight;
    }
    
    // 添加带选项的消息
    function addMessageWithOptions(content, options) {
      const container = document.getElementById('chatMessages');
      const msgDiv = document.createElement('div');
      msgDiv.className = 'ai-message assistant';
      
      const optionsHtml = options.map(o => 
        `<button class="ai-option-btn" onclick="${o.action}">${o.label}</button>`
      ).join('');
      
      msgDiv.innerHTML = `
        <div class="ai-message-avatar"><i class="fas fa-robot"></i></div>
        <div class="ai-message-content">
          <div class="ai-message-bubble">${content}</div>
          <div class="ai-message-options-label"><span>相关提问建议</span><i class="fas fa-chevron-down"></i></div>
          <div class="ai-message-options">${optionsHtml}</div>
        </div>
      `;
      
      container.appendChild(msgDiv);
      container.scrollTop = container.scrollHeight;
    }
    
    // 显示/隐藏加载
    function showLoading() {
      const container = document.getElementById('chatMessages');
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'ai-message assistant';
      loadingDiv.id = 'loadingMsg';
      loadingDiv.innerHTML = `
        <div class="ai-message-avatar"><i class="fas fa-robot"></i></div>
        <div class="ai-message-content">
          <div class="ai-loading">
            <div class="ai-loading-dots"><span></span><span></span><span></span></div>
            <span>正在思考...</span>
          </div>
        </div>
      `;
      container.appendChild(loadingDiv);
      container.scrollTop = container.scrollHeight;
    }
    
    function hideLoading() {
      const loading = document.getElementById('loadingMsg');
      if (loading) loading.remove();
    }
    
    // 当前分类状态
    var currentCat1 = '';
    var currentCat2 = '';
    var currentCat3 = '';
    var compareSourceProductId = null; // 从哪个商品进入比质比价（分析页面四）
    var comparePage4SelectedIds = { same: [], similar: [] }; // 分析页面四两个 Tab 下勾选的 id
    
    // 更新智能分析 / AI寻源 的页面提示标签（原型演示用）；空字符串时不展示标签
    function updatePageHints(analysisHint, sourcingHint) {
      var elAnalysis = document.getElementById('analysisPageHint');
      var elSourcing = document.getElementById('sourcingPageHint');
      if (elAnalysis) {
        if (analysisHint === '' || analysisHint === undefined || analysisHint === null) {
          elAnalysis.style.display = 'none';
          elAnalysis.textContent = '';
        } else {
          elAnalysis.textContent = analysisHint;
          elAnalysis.style.display = '';
        }
      }
      if (elSourcing) {
        if (sourcingHint === '' || sourcingHint === undefined || sourcingHint === null) {
          elSourcing.style.display = 'none';
          elSourcing.textContent = '';
        } else {
          elSourcing.textContent = sourcingHint;
          elSourcing.style.display = '';
        }
      }
    }
    
    // 明确问题对应文案（用于精确匹配，保证进入分析页面二）
    var SPECIFIC_QUESTION_TEXTS = ['A4 70g 复印纸', '给我推荐70g的A4纸', '推荐 A4 70g 复印纸'];
    
    function isSpecificQuestion(txt) {
      var t = (txt || '').trim();
      for (var i = 0; i < SPECIFIC_QUESTION_TEXTS.length; i++) {
        if (t === SPECIFIC_QUESTION_TEXTS[i]) return true;
      }
      return false;
    }
    
    // 处理消息
    function processMessage(msg) {
      var msgTrimmed = (msg || '').trim();
      const msgLower = msgTrimmed.toLowerCase();
      
      // ===== 明确问题（最先判断）：精确匹配后直接进入分析页面二 =====
      if (isSpecificQuestion(msgTrimmed)) {
        currentCat1 = '办公用品';
        currentCat2 = '复印纸';
        currentCat3 = 'A4 70g';
        addMessage('已为您推荐商品，请查看右侧分析区域。', 'assistant');
        renderAnalysisPage2('办公用品', '复印纸', 'A4 70g');
        return;
      }
      
      // ===== 一级分类模糊提问：推荐好用的办公用品/劳保用品/工具设备 =====
      if (msgLower.includes('办公') && !msgLower.includes('复印') && !msgLower.includes('纸') && !msgLower.includes('笔')) {
        currentCat1 = '办公用品';
        var cat2List = Object.keys(mockCategories['办公用品'].children);
        addMessageWithOptions(
          '请问您需要咨询哪类办公用品？',
          cat2List.map(c => ({ label: c, action: `selectCat2('办公用品', '${c}')` }))
        );
        return;
      }
      if (msgLower.includes('劳保') && !msgLower.includes('手套') && !msgLower.includes('安全帽') && !msgLower.includes('口罩')) {
        currentCat1 = '劳保用品';
        var cat2List = Object.keys(mockCategories['劳保用品'].children);
        addMessageWithOptions(
          '请问您需要咨询哪类劳保用品？',
          cat2List.map(c => ({ label: c, action: `selectCat2('劳保用品', '${c}')` }))
        );
        return;
      }
      if (msgLower.includes('工具') || msgLower.includes('设备')) {
        currentCat1 = '工具设备';
        var cat2List = Object.keys(mockCategories['工具设备'].children);
        addMessageWithOptions(
          '请问您需要咨询哪类工具设备？',
          cat2List.map(c => ({ label: c, action: `selectCat2('工具设备', '${c}')` }))
        );
        return;
      }
      
      // ===== 三级分类明确提问（优先）：推荐70g的A4纸等，直接进入分析页面二 =====
      if ((msgLower.includes('70g') || msgLower.includes('70克')) && (msgLower.includes('a4') || msgLower.includes('纸'))) {
        currentCat1 = '办公用品';
        currentCat2 = '复印纸';
        currentCat3 = 'A4 70g';
        addMessage('已为您推荐商品，请查看右侧分析区域。', 'assistant');
        renderAnalysisPage2('办公用品', '复印纸', 'A4 70g');
        return;
      }
      if ((msgLower.includes('80g') || msgLower.includes('80克')) && (msgLower.includes('a4') || msgLower.includes('纸'))) {
        currentCat1 = '办公用品';
        currentCat2 = '复印纸';
        currentCat3 = 'A4 80g';
        addMessage('已为您推荐商品，请查看右侧分析区域。', 'assistant');
        renderAnalysisPage2('办公用品', '复印纸', 'A4 80g');
        return;
      }
      
      // ===== 二级分类适中提问：推荐好用的复印纸/手套/口罩等 =====
      if (msgLower.includes('复印纸') || msgLower.includes('打印纸')) {
        currentCat1 = '办公用品';
        currentCat2 = '复印纸';
        addMessage('已在智能分析中给出推荐，请查看右侧分析区域。', 'assistant');
        renderAnalysisPage1('办公用品', '复印纸');
        return;
      }
      if (msgLower.includes('手套')) {
        currentCat1 = '劳保用品';
        currentCat2 = '手部防护';
        addMessage('已在智能分析中给出推荐，请查看右侧分析区域。', 'assistant');
        renderAnalysisPage1('劳保用品', '手部防护');
        return;
      }
      if (msgLower.includes('安全帽') || msgLower.includes('帽')) {
        currentCat1 = '劳保用品';
        currentCat2 = '头部防护';
        addMessage('已在智能分析中给出推荐，请查看右侧分析区域。', 'assistant');
        renderAnalysisPage1('劳保用品', '头部防护');
        return;
      }
      if (msgLower.includes('口罩') || msgLower.includes('防尘')) {
        currentCat1 = '劳保用品';
        currentCat2 = '呼吸防护';
        addMessage('已在智能分析中给出推荐，请查看右侧分析区域。', 'assistant');
        renderAnalysisPage1('劳保用品', '呼吸防护');
        return;
      }
      if (msgLower.includes('笔') || msgLower.includes('文具')) {
        currentCat1 = '办公用品';
        currentCat2 = '文具';
        addMessage('已在智能分析中给出推荐，请查看右侧分析区域。', 'assistant');
        renderAnalysisPage1('办公用品', '文具');
        return;
      }
      if (msgLower.includes('角磨机') || msgLower.includes('电钻') || msgLower.includes('电动')) {
        currentCat1 = '工具设备';
        currentCat2 = '电动工具';
        addMessage('已在智能分析中给出推荐，请查看右侧分析区域。', 'assistant');
        renderAnalysisPage1('工具设备', '电动工具');
        return;
      }
      
      // ===== 旧逻辑：纸（保留兼容） =====
      if (msgLower.includes('纸')) {
        addMessageWithOptions(
          '请问您需要什么规格的复印纸？',
          [
            { label: 'A4 70g', action: "selectSpec('A4 70g')" },
            { label: 'A4 80g', action: "selectSpec('A4 80g')" },
            { label: 'A5 70g', action: "selectSpec('A5 70g')" },
          ]
        );
        return;
      }
      
      // 预算筛选
      if (msgLower.includes('元') && (msgLower.includes('采购') || msgLower.includes('预算'))) {
        const budgetMatch = msg.match(/(\d+)\s*元/);
        const budget = budgetMatch ? parseInt(budgetMatch[1]) : 200;
        addMessage(`为您找到预算 ${budget} 元内的商品，请查看右侧分析区域：`, 'assistant');
        showBudgetProducts(budget);
        return;
      }
      
      // 评价查询
      if (msgLower.includes('评价') || msgLower.includes('好评') || msgLower.includes('差评')) {
        addMessage('该商品好评率 <strong>92%</strong>，负面评价主要集中在物流速度方面。详情请看右侧分析区域。', 'assistant');
        showReviewsAnalysis();
        return;
      }
      
      // 比价
      if (msgLower.includes('比') || msgLower.includes('对比') || msgLower.includes('哪个更好')) {
        addMessage('根据对比分析，<strong>得力 A4复印纸</strong> 在性价比方面表现最佳。详情请看右侧分析区域。', 'assistant');
        showCompareAnalysis();
        return;
      }
      
      // 规则咨询
      if (msgLower.includes('结算') || msgLower.includes('付款') || msgLower.includes('支付')) {
        addMessage(`<strong>商品结算方式：</strong><br><br>
          <strong>1. 在线支付</strong><br>
          支持支付宝、微信支付、银联等多种支付方式。<br><br>
          <strong>2. 对公转账</strong><br>
          适用于企业客户，下单后生成对公账户信息。<br><br>
          <strong>3. 账期结算</strong><br>
          通过信用评估的企业客户可申请账期。`, 'assistant');
        clearAnalysis();
        return;
      }
      
      if (msgLower.includes('退货') || msgLower.includes('退换')) {
        addMessage(`<strong>退货规则说明：</strong><br><br>
          <strong>1. 退货时限</strong>：签收后 7 天内可申请无理由退货<br><br>
          <strong>2. 退货条件</strong>：商品需保持原包装完好<br><br>
          <strong>3. 退款时效</strong>：审核通过后 3-5 个工作日内原路退回`, 'assistant');
        clearAnalysis();
        return;
      }
      
      // 默认回复
      addMessageWithOptions(
        '抱歉，我没有完全理解您的问题。您可以尝试以下操作：',
        [
          { label: '找复印纸', action: "sendQuickMsg('有没有好用的复印纸？')" },
          { label: '预算采购', action: "sendQuickMsg('200元内采购10箱A4复印纸')" },
          { label: '查看评价', action: "sendQuickMsg('这个商品评价怎么样？')" },
          { label: '规则咨询', action: "sendQuickMsg('商品如何结算？')" },
        ]
      );
    }
    
    // 选择规格（旧逻辑保留）
    function selectSpec(spec) {
      addMessage(spec, 'user');
      setTimeout(() => {
        addMessage(`为您推荐以下 ${spec} 复印纸，请查看右侧分析区域：`, 'assistant');
        showProductsAnalysis();
      }, 500);
    }
    
    // 选择二级分类（从一级追问进入）
    function selectCat2(cat1, cat2) {
      currentCat1 = cat1;
      currentCat2 = cat2;
      addMessage(cat2, 'user');
      setTimeout(function() {
        addMessage('已在智能分析中给出推荐，请查看右侧分析区域。', 'assistant');
        renderAnalysisPage1(cat1, cat2);
      }, 400);
    }
    
    // 选择三级分类 Tab（从分析页面一进入分析页面二）
    function selectCat3Tab(cat1, cat2, cat3) {
      currentCat3 = cat3;
      renderAnalysisPage2(cat1, cat2, cat3);
    }
    
    // ==================== 分析页面一：二级分类商品列表 + Tab ====================
    function renderAnalysisPage1(cat1, cat2) {
      currentCat3 = '';
      var cat3List = mockCategories[cat1] && mockCategories[cat1].children[cat2] ? mockCategories[cat1].children[cat2] : [];
      var products = mockProducts.filter(function(p) { return p.cat1 === cat1 && p.cat2 === cat2; });
      currentRecommendProducts = products;
      
      var tabsHtml = '<div class="ai-analysis-tabs">'
        + '<button class="ai-analysis-tab active" onclick="renderAnalysisPage1TabAll(\'' + cat1 + '\', \'' + cat2 + '\')">全部</button>'
        + cat3List.map(function(c3) {
          return '<button class="ai-analysis-tab" onclick="selectCat3Tab(\'' + cat1 + '\', \'' + cat2 + '\', \'' + c3 + '\')">' + c3 + '</button>';
        }).join('')
        + '</div>';
      
      var html = `
        <div class="ai-reco-header">
          <div class="ai-reco-header-left">
            <div class="ai-section-title"><i class="fas fa-box-open"></i> ${cat2}</div>
            <span class="ai-reco-compliance" title="以下商品均合规"><i class="fas fa-shield-alt"></i> 以下商品均合规</span>
          </div>
        </div>
        ${tabsHtml}
        <div class="ai-product-grid">
          ${renderProductCards(products)}
        </div>
      `;
      document.getElementById('analysisContent').innerHTML = html;
      updatePageHints('分析页面一', '寻源页面一');
      updateSourcingAndInquiry(products);
    }
    
    function renderAnalysisPage1TabAll(cat1, cat2) {
      renderAnalysisPage1(cat1, cat2);
    }
    
    // ==================== 分析页面二：三级分类商品列表（无顶部 Tab，避免与“分析页面三”混淆时重复展示） ====================
    function renderAnalysisPage2(cat1, cat2, cat3) {
      var products = mockProducts.filter(function(p) { return p.cat1 === cat1 && p.cat2 === cat2 && p.cat3 === cat3; });
      currentRecommendProducts = products;
      
      var html = `
        <div class="ai-reco-header">
          <div class="ai-reco-header-left">
            <div class="ai-section-title"><i class="fas fa-box-open"></i> ${cat2} - ${cat3}</div>
            <span class="ai-reco-compliance" title="以下商品均合规"><i class="fas fa-shield-alt"></i> 以下商品均合规</span>
          </div>
          <button type="button" class="ai-reco-refresh" onclick="renderAnalysisPage1('${cat1}', '${cat2}')"><i class="fas fa-arrow-left"></i> 返回全部</button>
        </div>
        <div class="ai-product-grid">
          ${renderProductCards(products)}
        </div>
      `;
      document.getElementById('analysisContent').innerHTML = html;
      updatePageHints('分析页面二', '寻源页面一');
      updateSourcingAndInquiry(products);
    }
    
    // 渲染商品卡片（分析页面一/二：无复选框，悬停层含比质比价按钮）
    function renderProductCards(products) {
      return products.map(function(p) {
        var nameEsc = p.name.replace(/'/g, "\\'");
        return `
          <div class="ai-product-card" id="productCard_${p.id}">
            <img src="${p.img}" class="ai-product-card-img" alt="">
            <div class="ai-product-card-name">${p.name}</div>
            <div class="ai-product-card-supplier-name">${p.brand}</div>
            <div class="ai-product-card-meta">
              <span class="ai-product-card-price">¥${p.price.toFixed(2)}/${p.unit}</span>
              <span class="ai-product-card-sales">${p.sales} 销量</span>
            </div>
            <div class="ai-product-card-footer">
              <button type="button" class="ai-product-card-detail-btn" onclick="showProductDetail('${nameEsc}')"><i class="fas fa-info-circle"></i> 查看详情</button>
            </div>
            <div class="ai-product-card-hover">
              <button type="button" class="ai-btn-sm primary" onclick="event.stopPropagation();addToCart(${p.id})"><i class="fas fa-cart-plus"></i> 加入购物车</button>
              <button type="button" class="ai-btn-sm secondary" onclick="event.stopPropagation();addToFavorite(${p.id})"><i class="fas fa-heart"></i> 加入收藏</button>
              <button type="button" class="ai-btn-sm primary" onclick="event.stopPropagation();showOrderConfirm(${p.id}, 1)"><i class="fas fa-bolt"></i> 立即下单</button>
              <button type="button" class="ai-btn-sm primary" onclick="event.stopPropagation();openCompareFromProduct(${p.id})"><i class="fas fa-balance-scale"></i> 比质比价</button>
              <button type="button" class="ai-product-card-detail-btn" onclick="showProductDetail('${nameEsc}')"><i class="fas fa-info-circle"></i> 查看详情</button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // 从商品卡片点击「比质比价」进入分析页面四
    function openCompareFromProduct(productId) {
      compareSourceProductId = productId;
      renderAnalysisPage4();
    }
    
    // 分析页面四：Tab 下商品带勾选框的渲染（仅页面四使用）
    function renderPage4ProductCards(products, tabKey) {
      return products.map(function(p) {
        var nameEsc = p.name.replace(/'/g, "\\'");
        var checked = (comparePage4SelectedIds[tabKey] || []).indexOf(p.id) >= 0 ? ' checked' : '';
        var selectedClass = (comparePage4SelectedIds[tabKey] || []).indexOf(p.id) >= 0 ? ' selected' : '';
        return `
          <div class="ai-product-card${selectedClass}" id="page4Card_${tabKey}_${p.id}">
            <label class="ai-product-card-checkbox"><input type="checkbox" ${checked} onchange="togglePage4Select('${tabKey}', ${p.id}, this.checked)"></label>
            <img src="${p.img}" class="ai-product-card-img" alt="">
            <div class="ai-product-card-name">${p.name}</div>
            <div class="ai-product-card-supplier-name">${p.brand}</div>
            <div class="ai-product-card-meta">
              <span class="ai-product-card-price">¥${p.price.toFixed(2)}/${p.unit}</span>
              <span class="ai-product-card-sales">${p.sales} 销量</span>
            </div>
            <div class="ai-product-card-footer">
              <button type="button" class="ai-product-card-detail-btn" onclick="showProductDetail('${nameEsc}')"><i class="fas fa-info-circle"></i> 查看详情</button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function togglePage4Select(tabKey, productId, isChecked) {
      var list = comparePage4SelectedIds[tabKey] || [];
      var idx = list.indexOf(productId);
      if (isChecked) {
        if (idx < 0) list.push(productId);
      } else {
        if (idx >= 0) list.splice(idx, 1);
      }
      comparePage4SelectedIds[tabKey] = list;
      var card = document.getElementById('page4Card_' + tabKey + '_' + productId);
      if (card) {
        if (isChecked) card.classList.add('selected'); else card.classList.remove('selected');
      }
      updatePage4SelectedHint();
    }
    
    function getPage4SelectedCount() {
      var ids = [];
      (comparePage4SelectedIds.same || []).forEach(function(id) { if (ids.indexOf(id) < 0) ids.push(id); });
      (comparePage4SelectedIds.similar || []).forEach(function(id) { if (ids.indexOf(id) < 0) ids.push(id); });
      return ids.length;
    }
    
    function updatePage4SelectedHint() {
      var el = document.getElementById('page4SelectedCountNum');
      if (el) el.textContent = getPage4SelectedCount();
    }
    
    // 更新 AI寻源 和 AI询价（根据当前商品列表）
    function updateSourcingAndInquiry(products) {
      // AI寻源：去重供应商
      var supplierIds = [];
      products.forEach(function(p) {
        if (p.supplierId && supplierIds.indexOf(p.supplierId) < 0) {
          supplierIds.push(p.supplierId);
        }
      });
      var suppliers = mockSuppliers.filter(function(s) { return supplierIds.indexOf(s.id) >= 0; });
      if (suppliers.length === 0) suppliers = mockSuppliers.slice(0, 3);
      var firstProductId = products.length > 0 ? products[0].id : 1;
      renderSourcingSuppliersByList(suppliers, firstProductId);
      // AI询价：双轴线
      renderInquiryChartDual(products);
    }
    
    function renderSourcingSuppliersByList(suppliers, firstProductId) {
      var pid = firstProductId || 1;
      var html = '<div class="ai-supplier-grid">' + suppliers.map(function(s) {
        return `
          <div class="ai-supplier-card">
            <img src="${s.img}" class="ai-supplier-card-img" alt="">
            <div class="ai-supplier-card-name">${s.name}</div>
            <div class="ai-supplier-card-hover-btn">
              <button type="button" onclick="onSupplierViewProduct(${s.id}, ${pid})"><i class="fas fa-box-open"></i> 查看商品</button>
            </div>
          </div>
        `;
      }).join('') + '</div>';
      document.getElementById('aiSourcingBody').innerHTML = html;
    }
    
    // AI询价：双轴线（最高价、最低价）
    function renderInquiryChartDual(products) {
      var prices = products.map(function(p) { return p.price; });
      if (prices.length === 0) prices = [25, 28, 30];
      var minPrice = Math.min.apply(null, prices);
      var maxPrice = Math.max.apply(null, prices);
      var refPrice = ((minPrice + maxPrice) / 2).toFixed(2);
      
      // 生成 7 天最高价/最低价数据
      var historyMax = [];
      var historyMin = [];
      for (var i = 6; i >= 0; i--) {
        var d = new Date();
        d.setDate(d.getDate() - i);
        var dateStr = (d.getMonth()+1) + '/' + d.getDate();
        var baseMax = maxPrice + (Math.random() - 0.5) * 3;
        var baseMin = minPrice + (Math.random() - 0.5) * 2;
        if (baseMin > baseMax) baseMin = baseMax - 1;
        historyMax.push({ date: dateStr, value: Math.round(baseMax * 100) / 100 });
        historyMin.push({ date: dateStr, value: Math.round(baseMin * 100) / 100 });
      }
      
      var w = 280;
      var h = 140;
      var padding = { top: 16, right: 12, bottom: 28, left: 40 };
      var allVals = historyMax.map(function(d){ return d.value; }).concat(historyMin.map(function(d){ return d.value; }));
      var minV = Math.min.apply(null, allVals);
      var maxV = Math.max.apply(null, allVals);
      var range = maxV - minV || 1;
      minV = minV - range * 0.15;
      maxV = maxV + range * 0.15;
      var xScale = (w - padding.left - padding.right) / (historyMax.length - 1);
      var yScale = (h - padding.top - padding.bottom) / (maxV - minV);
      
      function getPolyline(arr) {
        return arr.map(function(d, i) {
          var x = padding.left + i * xScale;
          var y = padding.top + (maxV - d.value) * yScale;
          return x + ',' + y;
        }).join(' ');
      }
      
      var pointsMax = getPolyline(historyMax);
      var pointsMin = getPolyline(historyMin);
      var labels = historyMax.map(function(d) { return d.date; });
      
      var html = `
        <div class="ai-inquiry-chart-wrap">
          <span class="ai-inquiry-chart-ref">市场参考价 <strong>¥${refPrice}</strong></span>
          <div class="ai-inquiry-chart" style="height: 180px;">
            <svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="xMidYMid meet">
              <!-- 最高价线（红色） -->
              <polyline fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" points="${pointsMax}"/>
              ${historyMax.map(function(d, i) {
                var x = padding.left + i * xScale;
                var y = padding.top + (maxV - d.value) * yScale;
                return '<circle cx="' + x + '" cy="' + y + '" r="3" fill="#ef4444"/>';
              }).join('')}
              <!-- 最低价线（蓝色） -->
              <polyline fill="none" stroke="var(--color-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" points="${pointsMin}"/>
              ${historyMin.map(function(d, i) {
                var x = padding.left + i * xScale;
                var y = padding.top + (maxV - d.value) * yScale;
                return '<circle cx="' + x + '" cy="' + y + '" r="3" fill="var(--color-primary)"/>';
              }).join('')}
              <!-- 日期标签 -->
              ${labels.map(function(lab, i) {
                var x = padding.left + i * xScale;
                return '<text x="' + x + '" y="' + (h - 6) + '" font-size="10" fill="#94a3b8" text-anchor="middle">' + lab + '</text>';
              }).join('')}
            </svg>
          </div>
          <div style="display: flex; gap: 16px; justify-content: center; margin-top: 8px; font-size: 12px; color: #64748b;">
            <span><span style="display:inline-block;width:12px;height:3px;background:#ef4444;border-radius:2px;vertical-align:middle;margin-right:4px;"></span>最高价</span>
            <span><span style="display:inline-block;width:12px;height:3px;background:var(--color-primary);border-radius:2px;vertical-align:middle;margin-right:4px;"></span>最低价</span>
          </div>
        </div>
      `;
      document.getElementById('aiInquiryBody').innerHTML = html;
    }
    
    // ==================== 比质比价（分析页面四/五） ====================
    
    // 分析页面四：同品同规 / 相近品规 双 Tab + 智能分析按钮
    function renderAnalysisPage4() {
      comparePage4SelectedIds = { same: [], similar: [] };
      var sourceProduct = mockProducts.find(function(p) { return p.id === compareSourceProductId; }) || mockProducts[0];
      // 同品同规：同 cat2+cat3 的商品
      var sameSpecProducts = mockProducts.filter(function(p) { return p.cat2 === sourceProduct.cat2 && p.cat3 === sourceProduct.cat3; });
      // 相近品规：同 cat2 其他规格，或同大类
      var similarProducts = mockProducts.filter(function(p) {
        return (p.cat2 === sourceProduct.cat2 && p.cat3 !== sourceProduct.cat3) || (p.cat1 === sourceProduct.cat1 && p.cat2 !== sourceProduct.cat2);
      });
      if (similarProducts.length > 9) similarProducts = similarProducts.slice(0, 9);
      if (sameSpecProducts.length > 9) sameSpecProducts = sameSpecProducts.slice(0, 9);
      
      var html = `
        <div class="ai-reco-header">
          <div class="ai-reco-header-left">
            <div class="ai-section-title"><i class="fas fa-balance-scale"></i> 比质比价</div>
          </div>
          <button type="button" class="ai-reco-refresh" onclick="goBackToList()"><i class="fas fa-arrow-left"></i> 返回列表</button>
        </div>
        <div class="ai-analysis-tabs" style="margin-bottom: 8px; flex-wrap: nowrap; justify-content: space-between;">
          <div style="display: flex; gap: 8px; align-items: center;">
            <button class="ai-analysis-tab active" id="page4TabSame" onclick="switchPage4Tab('same')">同品同规商品</button>
            <button class="ai-analysis-tab" id="page4TabSimilar" onclick="switchPage4Tab('similar')">相近品规商品</button>
          </div>
          <button type="button" class="ai-page4-smart-analyze-btn" id="page4SmartAnalyzeBtn" onclick="renderAnalysisPage5()"><i class="fas fa-chart-line"></i> 智能分析</button>
        </div>
        <div class="ai-page4-selected-hint" id="page4SelectedCountHint" style="margin-bottom: 12px;">已勾选 <strong id="page4SelectedCountNum">0</strong> 件</div>
        <div id="page4TabContentSame" class="ai-product-grid">${renderPage4ProductCards(sameSpecProducts, 'same')}</div>
        <div id="page4TabContentSimilar" class="ai-product-grid" style="display: none;">${renderPage4ProductCards(similarProducts, 'similar')}</div>
      `;
      document.getElementById('analysisContent').innerHTML = html;
      updatePageHints('分析页面四', '寻源页面一');
      updateSourcingAndInquiry(sameSpecProducts.length ? sameSpecProducts : similarProducts);
    }
    
    function switchPage4Tab(tabKey) {
      document.getElementById('page4TabSame').classList.toggle('active', tabKey === 'same');
      document.getElementById('page4TabSimilar').classList.toggle('active', tabKey === 'similar');
      document.getElementById('page4TabContentSame').style.display = tabKey === 'same' ? '' : 'none';
      document.getElementById('page4TabContentSimilar').style.display = tabKey === 'similar' ? '' : 'none';
    }
    
    // 分析页面五：比质比价结果页（占位符）
    function renderAnalysisPage5() {
      var ids = [];
      (comparePage4SelectedIds.same || []).forEach(function(id) { if (ids.indexOf(id) < 0) ids.push(id); });
      (comparePage4SelectedIds.similar || []).forEach(function(id) { if (ids.indexOf(id) < 0) ids.push(id); });
      var products = mockProducts.filter(function(p) { return ids.indexOf(p.id) >= 0; });
      if (products.length === 0) products = mockProducts.slice(0, 3);
      var html = `
        <div class="ai-reco-header">
          <div class="ai-reco-header-left">
            <div class="ai-section-title"><i class="fas fa-chart-bar"></i> 比质比价结果</div>
          </div>
          <button type="button" class="ai-reco-refresh" onclick="renderAnalysisPage4()"><i class="fas fa-arrow-left"></i> 返回</button>
        </div>
        <div style="padding: 60px 20px; text-align: center; background: #f8fafc; border-radius: 12px; border: 2px dashed #e2e8f0; margin-bottom: 20px;">
          <div style="font-size: 48px; color: #cbd5e1; margin-bottom: 16px;"><i class="fas fa-chart-pie"></i></div>
          <div style="font-size: 16px; color: #64748b; margin-bottom: 8px;">比质比价结果区域</div>
          <div style="font-size: 13px; color: #94a3b8;">（占位符 - 后续提供样式）</div>
        </div>
      `;
      document.getElementById('analysisContent').innerHTML = html;
      updatePageHints('分析页面五', '寻源页面一');
      updateSourcingAndInquiry(products);
    }
    
    // 返回列表
    function goBackToList() {
      if (currentCat3) {
        renderAnalysisPage2(currentCat1, currentCat2, currentCat3);
      } else if (currentCat2) {
        renderAnalysisPage1(currentCat1, currentCat2);
      } else {
        clearAnalysis();
      }
    }
    
    // ==================== 分析区显示函数 ====================
    
    function clearAnalysis() {
      currentRecommendProducts = [];
      document.getElementById('analysisContent').innerHTML = `
        <div class="ai-analysis-empty" id="analysisEmpty">
          <div class="ai-analysis-empty-icon"><i class="fas fa-lightbulb"></i></div>
          <h4>等待您的提问</h4>
          <p>向 AI 提问后，这里将展示<br>相关商品推荐和数据分析</p>
        </div>
      `;
      document.getElementById('aiSourcingBody').innerHTML = '根据对话内容智能推荐供应商与货源，结果将在此展示。';
      document.getElementById('aiInquiryBody').innerHTML = '询价记录与报价结果将在此展示。';
      updatePageHints('', '');
    }
    
    var recommendBatchIndex = 0;
    
    function getRecommendProducts() {
      var list = mockProducts.slice();
      for (var i = list.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var t = list[i]; list[i] = list[j]; list[j] = t;
      }
      return list.slice(0, 9);
    }
    
    function refreshRecommendProducts() {
      renderRecommendProducts(getRecommendProducts());
    }
    
    var currentRecommendProducts = [];
    
    function renderRecommendProducts(products) {
      currentRecommendProducts = products || [];
      var firstProductId = (products && products[0]) ? products[0].id : (mockProducts[0] ? mockProducts[0].id : 1);
      var html = `
        <div class="ai-reco-header">
          <div class="ai-reco-header-left">
            <div class="ai-section-title"><i class="fas fa-box-open"></i> 推荐商品</div>
            <span class="ai-reco-compliance" title="以下商品均合规"><i class="fas fa-shield-alt"></i> 以下商品均合规</span>
          </div>
          <button type="button" class="ai-reco-refresh" onclick="refreshRecommendProducts()"><i class="fas fa-sync-alt"></i> 换一批</button>
        </div>
        <div class="ai-product-grid">
          ${products.map(function(p) {
            var nameEsc = p.name.replace(/'/g, "\\'");
            return `
            <div class="ai-product-card">
              <img src="${p.img}" class="ai-product-card-img" alt="">
              <div class="ai-product-card-name">${p.name}</div>
              <div class="ai-product-card-supplier-name">${p.brand}</div>
              <div class="ai-product-card-meta">
                <span class="ai-product-card-price">¥${p.price.toFixed(2)}/${p.unit}</span>
                <span class="ai-product-card-sales">${p.sales} 销量</span>
              </div>
              <div class="ai-product-card-footer">
                <button type="button" class="ai-product-card-detail-btn" onclick="showProductDetail('${nameEsc}')"><i class="fas fa-info-circle"></i> 查看详情</button>
              </div>
              <div class="ai-product-card-hover">
                <button type="button" class="ai-btn-sm primary" onclick="event.stopPropagation();addToCart(${p.id})"><i class="fas fa-cart-plus"></i> 加入购物车</button>
                <button type="button" class="ai-btn-sm secondary" onclick="event.stopPropagation();addToFavorite(${p.id})"><i class="fas fa-heart"></i> 加入收藏</button>
                <button type="button" class="ai-btn-sm primary" onclick="event.stopPropagation();showOrderConfirm(${p.id}, 1)"><i class="fas fa-bolt"></i> 立即下单</button>
                <button type="button" class="ai-product-card-detail-btn" onclick="showProductDetail('${nameEsc}')"><i class="fas fa-info-circle"></i> 查看详情</button>
              </div>
            </div>
          `;
          }).join('')}
        </div>
      `;
      document.getElementById('analysisContent').innerHTML = html;
      updatePageHints('分析页面一', '寻源页面一');
      renderSourcingSuppliers(firstProductId);
      renderInquiryChart();
    }
    
    function renderSourcingSuppliers(firstProductId) {
      var pid = firstProductId != null ? firstProductId : (mockProducts[0] ? mockProducts[0].id : 1);
      var html = '<div class="ai-supplier-grid">' + mockSuppliers.map(function(s) {
        return `
          <div class="ai-supplier-card">
            <img src="${s.img}" class="ai-supplier-card-img" alt="">
            <div class="ai-supplier-card-name">${s.name}</div>
            <div class="ai-supplier-card-hover-btn">
              <button type="button" onclick="onSupplierViewProduct(${s.id}, ${pid})"><i class="fas fa-box-open"></i> 查看商品</button>
            </div>
          </div>
        `;
      }).join('') + '</div>';
      document.getElementById('aiSourcingBody').innerHTML = html;
    }
    
    function renderSourcingSupplierDetail(supplier) {
      if (!supplier) return;
      updatePageHints(null, '寻源页面二');
      var html = `
        <div class="ai-supplier-detail">
          <img src="${supplier.img}" class="ai-supplier-detail-img" alt="">
          <div class="ai-supplier-detail-name">${supplier.name}</div>
          <div class="ai-supplier-detail-addr"><i class="fas fa-map-marker-alt" style="color:#94a3b8;margin-right:4px;"></i>${supplier.address}</div>
          <button type="button" class="ai-supplier-detail-btn"><i class="fas fa-phone-alt"></i> 联系报价</button>
        </div>
      `;
      document.getElementById('aiSourcingBody').innerHTML = html;
    }
    
    function onSupplierViewProduct(supplierId, productId) {
      var product = mockProducts.find(function(p) { return p.id === productId; }) || mockProducts[0];
      showProductDetail(product.name);
      var supplier = mockSuppliers.find(function(s) { return s.id === supplierId; });
      if (supplier) renderSourcingSupplierDetail(supplier);
      renderInquiryChart(product.price);
    }
    
    function renderInquiryChart(refPriceOverride) {
      var refPrice = refPriceOverride != null ? refPriceOverride
        : (currentRecommendProducts && currentRecommendProducts[0])
          ? currentRecommendProducts[0].price
          : (mockProducts[0] ? mockProducts[0].price : 25);
      var history = getMockPriceHistory();
      var w = 280;
      var h = 120;
      var padding = { top: 8, right: 8, bottom: 24, left: 36 };
      var minV = Math.min.apply(null, history.map(function(d) { return d.value; }));
      var maxV = Math.max.apply(null, history.map(function(d) { return d.value; }));
      var range = maxV - minV || 1;
      minV = minV - range * 0.1;
      maxV = maxV + range * 0.1;
      var xScale = (w - padding.left - padding.right) / (history.length - 1);
      var yScale = (h - padding.top - padding.bottom) / (maxV - minV);
      var points = history.map(function(d, i) {
        var x = padding.left + i * xScale;
        var y = padding.top + (maxV - d.value) * yScale;
        return x + ',' + y;
      }).join(' ');
      var labels = history.map(function(d) { return d.date; });
      var html = `
        <div class="ai-inquiry-chart-wrap">
          <span class="ai-inquiry-chart-ref">市场参考价 <strong>¥${refPrice.toFixed(2)}</strong></span>
          <div class="ai-inquiry-chart">
            <svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="xMidYMid meet">
              <polyline fill="none" stroke="var(--color-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" points="${points}"/>
              ${history.map(function(d, i) {
                var x = padding.left + i * xScale;
                var y = padding.top + (maxV - d.value) * yScale;
                return '<circle cx="' + x + '" cy="' + y + '" r="3" fill="var(--color-primary)"/>';
              }).join('')}
              ${labels.map(function(lab, i) {
                var x = padding.left + i * xScale;
                return '<text x="' + x + '" y="' + (h - 4) + '" font-size="10" fill="#94a3b8" text-anchor="middle">' + lab + '</text>';
              }).join('')}
            </svg>
          </div>
        </div>
      `;
      document.getElementById('aiInquiryBody').innerHTML = html;
    }
    
    function showProductsAnalysis() {
      var products = getRecommendProducts();
      renderRecommendProducts(products);
    }
    
    function showProductAnalysis(productName, fromConversation) {
      updatePageHints('分析页面三', '寻源页面二');
      const product = mockProducts.find(p => p.name.includes((productName || '').split(' ')[0])) || mockProducts[0];
      var topHtml = fromConversation
        ? '<div class="ai-section-title"><i class="fas fa-info-circle"></i> 商品信息</div>'
        : `
        <div class="ai-reco-header" style="margin-bottom: 12px;">
          <div class="ai-reco-header-left">
            <div class="ai-section-title"><i class="fas fa-info-circle"></i> 商品信息</div>
          </div>
          <button type="button" class="ai-reco-refresh" onclick="goBackToList()"><i class="fas fa-arrow-left"></i> 返回列表</button>
        </div>
      `;
      const html = topHtml + `
        <div class="ai-product-card" style="margin-bottom: 16px;">
          <div class="ai-product-card-icon"><i class="fas fa-shopping-cart"></i></div>
          <img src="${product.img}" class="ai-product-card-img" alt="">
          <div class="ai-product-card-name">${product.name}</div>
          <div class="ai-product-card-meta">
            <span class="ai-product-card-price">¥${product.price.toFixed(2)}/${product.unit}</span>
            <span class="ai-product-card-suppliers"><i class="fas fa-star"></i> ${product.score} | 销量 ${product.sales}</span>
          </div>
          <div class="ai-product-card-actions">
            <button class="ai-btn-sm primary" onclick="addToCart(${product.id})"><i class="fas fa-cart-plus"></i> 加入购物车</button>
            <button class="ai-btn-sm secondary" onclick="addToFavorite(${product.id})"><i class="fas fa-heart"></i> 收藏</button>
          </div>
        </div>
      `;
      document.getElementById('analysisContent').innerHTML = html;
      renderSourcingSupplierDetail(mockSuppliers[0]);
      renderInquiryChart(product.price);
    }
    
    function showBudgetProducts(budget) {
      const products = mockProducts.filter(p => p.price * 10 <= budget).slice(0, 4);
      const html = `
        <div class="ai-section-title"><i class="fas fa-wallet"></i> 预算内商品</div>
        <div class="ai-product-grid">
          ${products.map(p => `
            <div class="ai-product-card">
              <div class="ai-budget-tag"><i class="fas fa-check-circle"></i> 预算内</div>
              <div class="ai-product-card-icon"><i class="fas fa-shopping-cart"></i></div>
              <img src="${p.img}" class="ai-product-card-img" alt="">
              <div class="ai-product-card-name">${p.name}</div>
              <div class="ai-product-card-meta">
                <span class="ai-product-card-price">¥${p.price.toFixed(2)}/${p.unit}</span>
                <span class="ai-product-card-suppliers">10箱 ¥${(p.price * 10).toFixed(2)}</span>
              </div>
              <div class="ai-product-card-actions">
                <button class="ai-btn-sm primary" onclick="showOrderConfirm(${p.id}, 10)"><i class="fas fa-bolt"></i> 一键下单</button>
              </div>
            </div>
          `).join('')}
        </div>
      `;
      document.getElementById('analysisContent').innerHTML = html;
    }
    
    function showReviewsAnalysis() {
      const html = `
        <div class="ai-section-title"><i class="fas fa-star"></i> 商品评价</div>
        <div class="ai-review-summary">
          <div class="ai-review-summary-title"><i class="fas fa-chart-pie"></i> 评价摘要</div>
          <div class="ai-review-summary-content">好评率 <strong>92%</strong>，负面评价主要集中在物流速度方面。整体质量稳定，值得推荐。</div>
        </div>
        <div class="ai-review-tabs">
          <button class="ai-review-tab positive active" onclick="showPositiveReviews()">好评 (${mockReviews.positive.length})</button>
          <button class="ai-review-tab negative" onclick="showNegativeReviews()">差评 (${mockReviews.negative.length})</button>
        </div>
        <div id="reviewsList">
          ${mockReviews.positive.map(r => `
            <div class="ai-review-item">
              <div class="ai-review-header">
                <span class="ai-review-user">${r.user}</span>
                <span class="ai-review-tag positive">好评</span>
              </div>
              <div class="ai-review-content">${r.content}</div>
            </div>
          `).join('')}
        </div>
      `;
      document.getElementById('analysisContent').innerHTML = html;
    }
    
    function showPositiveReviews() {
      document.querySelectorAll('.ai-review-tab').forEach(t => t.classList.remove('active'));
      document.querySelector('.ai-review-tab.positive').classList.add('active');
      document.getElementById('reviewsList').innerHTML = mockReviews.positive.map(r => `
        <div class="ai-review-item">
          <div class="ai-review-header">
            <span class="ai-review-user">${r.user}</span>
            <span class="ai-review-tag positive">好评</span>
          </div>
          <div class="ai-review-content">${r.content}</div>
        </div>
      `).join('');
    }
    
    function showNegativeReviews() {
      document.querySelectorAll('.ai-review-tab').forEach(t => t.classList.remove('active'));
      document.querySelector('.ai-review-tab.negative').classList.add('active');
      document.getElementById('reviewsList').innerHTML = mockReviews.negative.map(r => `
        <div class="ai-review-item">
          <div class="ai-review-header">
            <span class="ai-review-user">${r.user}</span>
            <span class="ai-review-tag negative">差评</span>
          </div>
          <div class="ai-review-content">${r.content}</div>
        </div>
      `).join('');
    }
    
    function showCompareAnalysis() {
      const products = mockProducts.filter(p => p.name.includes('纸')).slice(0, 3);
      const html = `
        <div class="ai-section-title"><i class="fas fa-balance-scale"></i> 比质比价</div>
        <table class="ai-compare-table">
          <tr>
            <th>维度</th>
            ${products.map(p => `<th>${p.brand}</th>`).join('')}
          </tr>
          <tr>
            <td>价格</td>
            ${products.map((p, i) => `<td ${i === 2 ? 'class="highlight"' : ''}>¥${p.price.toFixed(2)}</td>`).join('')}
          </tr>
          <tr>
            <td>销量</td>
            ${products.map((p, i) => `<td ${i === 2 ? 'class="highlight"' : ''}>${p.sales}</td>`).join('')}
          </tr>
          <tr>
            <td>评分</td>
            ${products.map((p, i) => `<td ${i === 2 ? 'class="highlight"' : ''}>${p.score}</td>`).join('')}
          </tr>
        </table>
        <div style="text-align: center; padding: 16px; background: #f9fafb; border-radius: 10px; margin-bottom: 16px;">
          <div style="font-size: 12px; color: #9ca3af; margin-bottom: 8px;">综合评分雷达图</div>
          <svg width="140" height="140" viewBox="0 0 140 140">
            <polygon points="70,15 125,45 110,115 30,115 15,45" fill="none" stroke="#e5e7eb" stroke-width="1"/>
            <polygon points="70,35 100,55 90,100 50,100 40,55" fill="none" stroke="#e5e7eb" stroke-width="1"/>
            <polygon points="70,40 85,55 80,85 60,85 55,55" fill="rgba(16,185,129,0.2)" stroke="#10b981" stroke-width="2"/>
          </svg>
        </div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
          ${products.map((p, i) => `
            <button class="ai-btn-sm ${i === 2 ? 'primary' : 'secondary'}" onclick="addToCart(${p.id})">选${p.brand}</button>
          `).join('')}
        </div>
      `;
      document.getElementById('analysisContent').innerHTML = html;
    }
    
    function showOrderConfirm(productId, quantity) {
      const product = mockProducts.find(p => p.id === productId) || mockProducts[0];
      const total = (product.price * quantity).toFixed(2);
      const html = `
        <div class="ai-section-title"><i class="fas fa-shopping-cart"></i> 订单确认</div>
        <div class="ai-order-card">
          <div class="ai-order-card-header">
            <img src="${product.img}" class="ai-order-card-img" alt="">
            <div class="ai-order-card-info">
              <div class="ai-order-card-name">${product.name}</div>
              <div class="ai-order-card-meta">
                <span>单价：¥${product.price.toFixed(2)}/${product.unit}</span>
                <span>数量：${quantity}${product.unit}</span>
              </div>
            </div>
          </div>
          <div class="ai-order-card-total">
            <span>合计金额：</span>
            <strong>¥${total}</strong>
          </div>
          <button class="ai-order-btn" onclick="confirmOrder(${productId}, ${quantity})">
            <i class="fas fa-check"></i> 确认下单
          </button>
        </div>
      `;
      document.getElementById('analysisContent').innerHTML = html;
      addMessage(`即将为您创建订单，商品：${product.name}，数量：${quantity}${product.unit}，总价：¥${total}`, 'assistant');
    }
    
    function showProductDetail(name, fromConversation) {
      showProductAnalysis(name, fromConversation);
    }
    
    function showReviews(name) {
      showReviewsAnalysis();
    }
    
    function showCompare(name) {
      showCompareAnalysis();
    }
    
    function showOrder(name) {
      const product = mockProducts.find(p => p.name.includes(name.split(' ')[0])) || mockProducts[0];
      showOrderConfirm(product.id, 1);
    }
    
    // ==================== 操作函数 ====================
    
    function addToCart(productId) {
      const product = mockProducts.find(p => p.id === productId);
      if (product) {
        showToast(`已将「${product.name}」加入购物车`);
      }
    }
    
    function addToFavorite(productId) {
      const product = mockProducts.find(p => p.id === productId);
      if (product) {
        showToast(`已收藏「${product.name}」`);
      }
    }
    
    function confirmOrder(productId, quantity) {
      const product = mockProducts.find(p => p.id === productId);
      if (product) {
        showToast('订单创建成功，正在跳转...');
        addMessage(`<i class="fas fa-check-circle" style="color: #10b981;"></i> 订单创建成功！商品：${product.name}，数量：${quantity}${product.unit}`, 'assistant');
        setTimeout(() => clearAnalysis(), 1500);
      }
    }
    
    // Toast 提示
    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2500);
    }
    
    // 底条 Tab 切换（购物车/我的收藏）
    function switchQuickTab(tab) {
      document.querySelectorAll('.ai-bottom-bar-tab').forEach(t => t.classList.remove('active'));
      var el = document.querySelector('.ai-bottom-bar-tab[data-tab="' + tab + '"]');
      if (el) el.classList.add('active');
      
      document.getElementById('favoritesTab').style.display = tab === 'favorites' ? 'flex' : 'none';
      document.getElementById('cartTab').style.display = tab === 'cart' ? 'flex' : 'none';
    }
    
    // 底条收起/展开
    function toggleBottomBar() {
      var bar = document.getElementById('aiBottomBar');
      var btn = document.getElementById('aiBottomBarToggle');
      if (!bar || !btn) return;
      var isCollapsed = bar.classList.toggle('collapsed');
      var icon = btn.querySelector('i');
      if (isCollapsed) {
        btn.innerHTML = '<i class="fas fa-chevron-up"></i> 展开';
      } else {
        btn.innerHTML = '<i class="fas fa-chevron-down"></i> 收起';
      }
    }
    
    // 底部勾选更新
    function updateBottomBarSelection() {
      var checkboxes = document.querySelectorAll('.ai-quick-item-checkbox:checked');
      var count = checkboxes.length;
      var countEl = document.getElementById('bottomSelectedCount');
      var btn = document.getElementById('bottomOrderBtn');
      if (countEl) countEl.textContent = count;
      if (btn) btn.disabled = count === 0;
    }
    
    // 底部下单：在综合分析模块展示确认页
    function bottomBarOrder() {
      var checkboxes = document.querySelectorAll('.ai-quick-item-checkbox:checked');
      if (checkboxes.length === 0) {
        showToast('请先勾选要下单的商品');
        return;
      }
      var items = [];
      checkboxes.forEach(function(cb) {
        var itemEl = cb.closest('.ai-quick-item');
        if (itemEl) {
          var pid = parseInt(itemEl.getAttribute('data-product-id'), 10);
          var qty = parseInt(itemEl.getAttribute('data-quantity'), 10) || 1;
          if (pid && !isNaN(pid)) items.push({ productId: pid, quantity: qty });
        }
      });
      if (items.length === 0) {
        showToast('请先勾选要下单的商品');
        return;
      }
      showBottomBarOrderConfirm(items);
    }
    
    // 在综合分析模块展示购物车/收藏勾选商品的订单确认页
    function showBottomBarOrderConfirm(items) {
      var lines = [];
      var totalAmount = 0;
      items.forEach(function(it) {
        var product = mockProducts.find(function(p) { return p.id === it.productId; });
        if (product) {
          var subtotal = product.price * it.quantity;
          totalAmount += subtotal;
          lines.push({
            product: product,
            quantity: it.quantity,
            subtotal: subtotal
          });
        }
      });
      var totalStr = totalAmount.toFixed(2);
      var html = `
        <div class="ai-section-title"><i class="fas fa-shopping-cart"></i> 订单确认</div>
        <div class="ai-order-card">
          <div style="max-height: 240px; overflow-y: auto; margin-bottom: 12px;">
            ${lines.map(function(l) {
              return `
                <div class="ai-order-card-header" style="padding-bottom: 12px; margin-bottom: 12px; border-bottom: 1px dashed #e2e8f0;">
                  <img src="${l.product.img}" class="ai-order-card-img" alt="">
                  <div class="ai-order-card-info">
                    <div class="ai-order-card-name">${l.product.name}</div>
                    <div class="ai-order-card-meta">
                      <span>单价：¥${l.product.price.toFixed(2)}/${l.product.unit}</span>
                      <span>数量：${l.quantity}${l.product.unit}</span>
                    </div>
                    <div style="margin-top: 6px; font-size: 13px; color: var(--color-primary); font-weight: 600;">小计：¥${l.subtotal.toFixed(2)}</div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
          <div class="ai-order-card-total">
            <span>合计金额：</span>
            <strong>¥${totalStr}</strong>
          </div>
          <button class="ai-order-btn" onclick="confirmBottomBarOrder()">
            <i class="fas fa-check"></i> 确认下单
          </button>
        </div>
      `;
      document.getElementById('analysisContent').innerHTML = html;
      updatePageHints('', '');
      addMessage('您已选择 ' + items.length + ' 件商品，请在综合分析区域确认订单。', 'assistant');
    }
    
    function confirmBottomBarOrder() {
      showToast('订单创建成功，正在跳转...');
      addMessage('<i class="fas fa-check-circle" style="color: #10b981;"></i> 订单创建成功！', 'assistant');
      document.querySelectorAll('.ai-quick-item-checkbox:checked').forEach(function(cb) { cb.checked = false; });
      updateBottomBarSelection();
      setTimeout(function() {
        clearAnalysis();
      }, 1500);
    }
    
    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
      // 获取用户信息
      const role = localStorage.getItem('role') || 'buyer';
      const roleNames = {
        'guest': '访客',
        'buyer-user': '普通采购用户',
        'buyer': '采购专员',
        'supplier': '供应商',
        'admin': '平台管理员'
      };
      document.getElementById('userNameDisplay').textContent = `张三（${roleNames[role] || '采购专员'}）`;
    });
  </script>
</body>
</html>
